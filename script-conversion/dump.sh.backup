#!/bin/bash

# ğŸš€ HOMEY DUMP BUNDLE - BRIEF 'BÃ‰TON'
# Script de dump complet pour Linux/macOS

set -e

# ParamÃ¨tres
RUN_SECONDS=${1:-300}
TIMESTAMP=$(date +"%Y%m%d-%H%M")
DUMP_DIR="dumps/$TIMESTAMP"
DUMP_PATH="dumps/dump-$TIMESTAMP"

echo "ğŸš€ HOMEY DUMP BUNDLE - BRIEF 'BÃ‰TON'"
echo "============================================================"

# CrÃ©er le dossier de dump
mkdir -p "dumps"
mkdir -p "$DUMP_DIR"

echo "ğŸ“ Dossier de dump crÃ©Ã©: $DUMP_DIR"

# 1. Capture de l'environnement
echo "ğŸ” Capture de l'environnement..."
cat > "$DUMP_DIR/env.txt" << EOF
=== ENVIRONNEMENT ===
Date: $(date)
PWD: $(pwd)
Node: $(node --version 2>/dev/null || echo "Non installÃ©")
NPM: $(npm --version 2>/dev/null || echo "Non installÃ©")
Homey CLI: $(homey --version 2>/dev/null || echo "Non installÃ©")
Git: $(git --version 2>/dev/null || echo "Non installÃ©")
EOF

echo "âœ… Environnement capturÃ©"

# 2. Copie app.json
if [ -f "app.json" ]; then
    cp "app.json" "$DUMP_DIR/app.json"
    echo "âœ… app.json copiÃ©"
else
    echo "âŒ app.json non trouvÃ©"
fi

# 3. Strip BOM des JSON
echo "ğŸ§¹ Nettoyage BOM des JSON..."
BOM_LOG=()
JSON_FILES=$(find . -name "*.json" -not -path "./node_modules/*" -not -path "./dumps/*")

for file in $JSON_FILES; do
    if [ -f "$file" ]; then
        if head -c3 "$file" | grep -q $'\xef\xbb\xbf'; then
            # BOM dÃ©tectÃ©, le retirer
            tail -c +4 "$file" > "${file}.tmp" && mv "${file}.tmp" "$file"
            BOM_LOG+=("âœ… BOM retirÃ©: $file")
        fi
    fi
done

printf "%s\n" "${BOM_LOG[@]}" > "$DUMP_DIR/strip-bom.log"
echo "âœ… BOM nettoyÃ© sur $(echo "$JSON_FILES" | wc -w) fichiers"

# 4. Lint JSON
echo "ğŸ” Validation JSON..."
LINT_LOG=()
INVALID_JSON=()

for file in $JSON_FILES; do
    if [ -f "$file" ]; then
        if jq empty "$file" >/dev/null 2>&1; then
            LINT_LOG+=("âœ… $file")
        else
            LINT_LOG+=("âŒ $file - Erreur de parsing")
            INVALID_JSON+=("$file")
        fi
    fi
done

printf "%s\n" "${LINT_LOG[@]}" > "$DUMP_DIR/lint-json.log"
VALID_COUNT=$(($(echo "$JSON_FILES" | wc -w) - ${#INVALID_JSON[@]}))
echo "âœ… JSON validÃ©: $VALID_COUNT/$(echo "$JSON_FILES" | wc -w) valides"

# 5. Tree de l'arborescence
echo "ğŸŒ³ GÃ©nÃ©ration de l'arborescence..."
cat > "$DUMP_DIR/tree.txt" << EOF
=== ARBORESCENCE PROJET ===
Date: $(date)
EOF

tree -I 'node_modules|.git|dumps' >> "$DUMP_DIR/tree.txt" 2>/dev/null || find . -type d -not -path "./node_modules" -not -path "./.git" -not -path "./dumps" | sort >> "$DUMP_DIR/tree.txt"

echo "âœ… Arborescence gÃ©nÃ©rÃ©e"

# 6. Validation Homey (debug)
echo "ğŸ” Validation Homey (debug)..."
if command -v homey >/dev/null 2>&1; then
    homey app validate -l debug > "$DUMP_DIR/validate.log" 2>&1 || true
    
    if grep -q "âœ“" "$DUMP_DIR/validate.log"; then
        echo "âœ… Validation Homey rÃ©ussie"
    else
        echo "âš ï¸ Validation Homey avec avertissements"
    fi
else
    echo "âŒ Homey CLI non installÃ©" > "$DUMP_DIR/validate.log"
    echo "âŒ Homey CLI non installÃ©"
fi

# 7. Lancement Homey app run
echo "ğŸš€ Lancement Homey app run..."
echo "â±ï¸ DurÃ©e: $RUN_SECONDS secondes"
echo "ğŸ›‘ ArrÃªt automatique dans $RUN_SECONDS secondes (Ctrl+C pour arrÃªt manuel)"

cat > "$DUMP_DIR/run.log" << EOF
=== LOGS HOMEY APP RUN ===
Date: $(date)
DurÃ©e: $RUN_SECONDS secondes

EOF

# Timer pour arrÃªt automatique
(
    sleep $RUN_SECONDS
    echo "â° ArrÃªt automatique aprÃ¨s $RUN_SECONDS secondes"
    pkill -f "homey app run" 2>/dev/null || true
) &

TIMER_PID=$!

# Lancer homey app run et capturer les logs
if command -v homey >/dev/null 2>&1; then
    echo "ğŸš€ Lancement de homey app run..."
    timeout $RUN_SECONDS homey app run 2>&1 | tee -a "$DUMP_DIR/run.log" || true
else
    echo "âŒ Homey CLI non installÃ©" | tee -a "$DUMP_DIR/run.log"
fi

# ArrÃªter le timer
kill $TIMER_PID 2>/dev/null || true

# 8. CrÃ©ation du ZIP final
echo "ğŸ“¦ CrÃ©ation du ZIP final..."
if command -v zip >/dev/null 2>&1; then
    cd dumps
    zip -r "dump-$TIMESTAMP.zip" "$TIMESTAMP" >/dev/null 2>&1
    cd ..
    echo "âœ… ZIP crÃ©Ã©: dumps/dump-$TIMESTAMP.zip"
elif command -v tar >/dev/null 2>&1; then
    tar -czf "$DUMP_PATH.tar.gz" -C dumps "$TIMESTAMP"
    echo "âœ… TAR crÃ©Ã©: $DUMP_PATH.tar.gz"
else
    echo "âš ï¸ Aucun outil de compression disponible, copie simple"
    cp -r "$DUMP_DIR" "$DUMP_PATH"
fi

# 9. Rapport final
echo ""
echo "ğŸ‰ DUMP COMPLET TERMINÃ‰ !"
echo "============================================================"
echo "ğŸ“ Dossier: $DUMP_DIR"
if [ -f "dumps/dump-$TIMESTAMP.zip" ]; then
    echo "ğŸ“¦ Archive: dumps/dump-$TIMESTAMP.zip"
elif [ -f "$DUMP_PATH.tar.gz" ]; then
    echo "ğŸ“¦ Archive: $DUMP_PATH.tar.gz"
else
    echo "ğŸ“ Copie: $DUMP_PATH"
fi

echo ""
echo "ğŸ“‹ CONTENU DU DUMP:"
ls -la "$DUMP_DIR" | while read line; do
    echo "  ğŸ“„ $line"
done

echo ""
echo "ğŸš€ PROCHAINES Ã‰TAPES:"
echo "1. Analyser les logs dans $DUMP_DIR"
echo "2. Corriger les erreurs JSON si nÃ©cessaire"
echo "3. Relancer la validation si besoin"
echo "4. Tester l'appairage des devices"

echo ""
echo "ğŸ¯ DUMP TERMINÃ‰ AVEC SUCCÃˆS !"
