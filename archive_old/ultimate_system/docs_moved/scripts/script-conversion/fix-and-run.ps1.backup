# Script pour résoudre les problèmes de dépendances et exécuter le script
Write-Host "=== Résolution des problèmes de dépendances ===" -ForegroundColor Cyan

# Vérification de Node.js et npm
try {
    $nodeVersion = node --version
    $npmVersion = npm --version
    Write-Host "✅ Node.js $nodeVersion et npm $npmVersion sont installés" -ForegroundColor Green
} catch {
    Write-Host "❌ Node.js n'est pas installé ou n'est pas dans le PATH" -ForegroundColor Red
    Write-Host "Veuillez installer Node.js depuis https://nodejs.org/"
    exit 1
}

# Nettoyage
Write-Host "`nNettoyage des dépendances existantes..." -ForegroundColor Yellow
if (Test-Path "node_modules") {
    Remove-Item -Recurse -Force node_modules
}
if (Test-Path "package-lock.json") {
    Remove-Item -Force package-lock.json
}

# Installation des dépendances dans le dossier scripts
Write-Host "`nInstallation des dépendances dans le dossier scripts..." -ForegroundColor Yellow
Set-Location scripts

# Vérification et installation des dépendances manquantes
$dependencies = @("uuid@9.0.0", "axios@1.6.2", "chalk@5.3.0", "fs-extra@11.1.1", "glob@10.3.3")

foreach ($dep in $dependencies) {
    $package = $dep -replace '@.*', ''
    Write-Host "- Vérification de $package..."
    
    $installed = npm list $package --depth=0 2>$null
    if ($LASTEXITCODE -ne 0) {
        Write-Host "  Installation de $dep..."
        npm install $dep --save
        if ($LASTEXITCODE -ne 0) {
            Write-Host "  ❌ Échec de l'installation de $dep" -ForegroundColor Red
        } else {
            Write-Host "  ✅ $package installé avec succès" -ForegroundColor Green
        }
    } else {
        Write-Host "  ✅ $package est déjà installé" -ForegroundColor Green
    }
}

# Exécution du script
Write-Host "`n=== Exécution du script update-drivers.js ===" -ForegroundColor Cyan
node update-drivers.js

if ($LASTEXITCODE -ne 0) {
    Write-Host "`n❌ Le script a rencontré une erreur (code: $LASTEXITCODE)" -ForegroundColor Red
    Write-Host "Veuillez vérifier les messages d'erreur ci-dessus." -ForegroundColor Yellow
} else {
    Write-Host "`n✅ Script exécuté avec succès" -ForegroundColor Green
}

# Retour au répertoire parent
Set-Location ..
