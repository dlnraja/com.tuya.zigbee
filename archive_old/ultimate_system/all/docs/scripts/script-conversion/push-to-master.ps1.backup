# Script pour pousser les modifications vers la branche principale
Write-Host "Configuration de Git..." -ForegroundColor Cyan

# Configuration Git
try {
    git config --global user.name "dlnraja"
    git config --global user.email "dylan.rajasekaram@gmail.com"
    Write-Host "✓ Configuration Git effectuée" -ForegroundColor Green
} catch {
    Write-Host "Erreur lors de la configuration Git: $_" -ForegroundColor Red
    exit 1
}

# Vérifier l'état du dépôt
try {
    Write-Host "\nVérification de l'état du dépôt..." -ForegroundColor Cyan
    git status
} catch {
    Write-Host "Erreur: Le répertoire actuel ne semble pas être un dépôt Git valide" -ForegroundColor Red
    exit 1
}

# Ajouter tous les fichiers
try {
    Write-Host "\nAjout des fichiers..." -ForegroundColor Cyan
    git add .
    Write-Host "✓ Fichiers ajoutés" -ForegroundColor Green
} catch {
    Write-Host "Erreur lors de l'ajout des fichiers: $_" -ForegroundColor Red
    exit 1
}

# Créer un commit
try {
    Write-Host "\nCréation du commit..." -ForegroundColor Cyan
    git commit -m "Mise à jour du projet Tuya Zigbee"
    Write-Host "✓ Commit créé" -ForegroundColor Green
} catch {
    Write-Host "Erreur lors de la création du commit: $_" -ForegroundColor Red
    exit 1
}

# Vérifier la branche actuelle
try {
    $currentBranch = git rev-parse --abbrev-ref HEAD
    Write-Host "\nBranche actuelle: $currentBranch" -ForegroundColor Cyan
    
    # Pousser vers la branche principale (main ou master)
    Write-Host "\nPousse des modifications vers la branche principale..." -ForegroundColor Cyan
    
    # Essayer d'abord avec 'main', puis avec 'master' si nécessaire
    try {
        git push -u origin main
        Write-Host "✓ Modifications poussées vers la branche 'main'" -ForegroundColor Green
    } catch {
        Write-Host "La branche 'main' n'existe pas, tentative avec 'master'..." -ForegroundColor Yellow
        git push -u origin master
        Write-Host "✓ Modifications poussées vers la branche 'master'" -ForegroundColor Green
    }
    
} catch {
    Write-Host "Erreur lors du push: $_" -ForegroundColor Red
    Write-Host "\nConseil: Vérifiez que le dépôt distant est correctement configuré avec 'git remote -v'" -ForegroundColor Yellow
    exit 1
}

Write-Host "\n✓ Opération terminée avec succès!" -ForegroundColor Green
Write-Host "Vos modifications ont été poussées vers la branche principale du dépôt." -ForegroundColor Green

# Afficher l'URL du dépôt
try {
    $remoteUrl = git config --get remote.origin.url
    Write-Host "\nDépôt distant: $remoteUrl" -ForegroundColor Cyan
} catch {
    Write-Host "\nImpossible de récupérer l'URL du dépôt distant" -ForegroundColor Yellow
}

Read-Host "\nAppuyez sur Entrée pour quitter..."
