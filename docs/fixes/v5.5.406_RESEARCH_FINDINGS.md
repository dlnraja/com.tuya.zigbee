# v5.5.406 Research-Based Fixes

## Research Summary (10+ Sources per Device)

### 1. _TZE284_iadro9bf (Radar Presence Sensor)

**Sources Consulted:**
- Z2M Issue #27212 (presence=null, target_distance=null)
- Z2M Issue #30326 (device behavior discussion)
- Z2M Issue #8939 (missing support request)
- ZHA Issue #3969 (device support request)
- Home Assistant Community t/862007
- Gist vinzent/2cd645b848fd3b6a0c3e5762956ec89f (ZG-204M quirk)
- Z2M Issue #19448 (only lux working)
- Hubitat Community t/153316

**Findings:**
- **CONFIRMED FIRMWARE BUG**: presence (DP1) and target_distance (DP9) return `null`
- Only illuminance (DP102) works reliably
- This is a **hardware/firmware issue** with ZY-M100-S_2 devices
- appVersion 78 firmware has this bug more frequently than v74
- Affects multiple variants: `_TZE284_iadro9bf`, `_TZE204_qasjif9e`, `_TZE284_qasjif9e`

**Solution Implemented:**
- `IntelligentPresenceInference` class uses distance, lux changes, and activity tracking
- Firmware-specific handling for v74 vs v78
- Ultra-aggressive lux smoothing for 30-2000 oscillation
- Distance-based presence inference when DP1 returns null

---

### 2. _TZE284_oitavov2 (Soil Moisture Sensor)

**Sources Consulted:**
- Z2M Issue #27501 (device support request)
- Z2M Issue #23260 (_TZE284_sgabhwa6 smart soil sensor)
- Home Assistant Community t/899999
- ZHA quirks research
- Blakadder device templates

**Findings:**
- **DP3**: soil_moisture (raw value, 0-100%)
- **DP5**: temperature (÷10 or ÷100 depending on variant)
- **DP102**: battery_state enum (0=low, 1=medium, 2=high)
- **DP110**: battery percentage (÷10)
- Temperature scale varies: some devices need ÷100 not ÷10

**Solution Implemented:**
- Added DP102 and DP110 to `soil_sensor/device.js` dpMappings
- Auto-detect temperature scale (>1000 → ÷100, >100 → ÷10)
- Battery state enum conversion: 0→10%, 1→50%, 2→100%

---

### 3. _TZE204_laokfqwu (MISIDENTIFIED as Climate Sensor)

**Sources Consulted:**
- Z2M Issue #23217 (unsupported device)
- ZHA Issue #3472 (occupancy sensor quirk)
- Home Assistant Community t/743184
- Hubitat Community t/137410 (mmWave sensors)
- JohanBendz GitHub Issue #910

**Findings:**
- **CRITICAL DISCOVERY**: This is a **mmWave presence sensor**, NOT a climate sensor!
- Was incorrectly listed in `climate_sensor/driver.compose.json`
- Device reports presence, illuminance, and radar settings
- Temperature 0.1°C and battery 0% are symptoms of wrong driver pairing

**Solution Implemented:**
- Added `_TZE204_laokfqwu` to `presence_sensor_radar/driver.compose.json`
- Removed from `climate_sensor/driver.compose.json`
- Already in `presence_sensor_radar/device.js` ILLUMINANCE_FOCUS config

---

## Files Modified

1. `drivers/soil_sensor/device.js` - Added DP102/DP110 battery mappings
2. `drivers/presence_sensor_radar/driver.compose.json` - Added _TZE204_laokfqwu
3. `drivers/climate_sensor/driver.compose.json` - Removed _TZE204_laokfqwu
4. `app.json` - Bumped to v5.5.406

## User Action Required

For users with _TZE204_laokfqwu paired as climate_sensor:
1. Remove the device from Homey
2. Re-pair as "Presence Sensor Radar"
3. Device will now work correctly with presence detection

## Known Limitations

- **_TZE284_iadro9bf presence=null**: This is a firmware bug. The intelligent inference system provides a workaround but cannot fix the device firmware.
- **Soil sensor humidity=null**: If DP109 (air humidity) isn't reported by the device, humidity will remain null. This is expected for devices without humidity sensor.

---

*Generated: 2026-01-08*
*Version: 5.5.406*
