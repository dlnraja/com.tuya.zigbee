const fs = require('fs');
const path = require('path');

console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
console.log('‚ïë   üìÅ ORGANISATION & V√âRIFICATION COMPL√àTE DU PROJET   ‚ïë');
console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');

// Structure de dossiers √† cr√©er
const docsStructure = {
  'docs': {
    'guides': [],
    'reports': [],
    'api': [],
    'workflows': []
  },
  'scripts': {
    'validation': [],
    'fixes': [],
    'generation': [],
    'analysis': []
  }
};

// Classification des fichiers
const fileClassification = {
  guides: [
    'AUTO_PUBLISH_GUIDE.md',
    'DEVELOPER_GUIDE.md',
    'DOCUMENTATION_INDEX.md',
    'GITHUB_ACTIONS_SETUP.md',
    'INSTALLATION.md',
    'PUBLICATION_GUIDE_OFFICIELLE.md',
    'QUALITY_CHECKS_GUIDE.md',
    'QUICK_START_PUBLICATION.md',
    'SCRIPTS_README.md',
    'TUYA_DATAPOINTS_GUIDE.md',
    'CONTRIBUTING.md',
    'README_CORRECTIONS.md',
    'EXPLICATION_BATTERIES.md'
  ],
  reports: [
    'COMPLETE_SESSION_SUMMARY.md',
    'DEEP_ANALYSIS_REPORT.md',
    'DOCUMENTATION_COMPLETE_RECAP.md',
    'DRIVER_ICONS_COMPLETE.md',
    'EXEMPLE_BATTERIE_CONCRET.md',
    'FINAL_AUTO_PUBLISH_SUMMARY.md',
    'FINAL_DOCUMENTATION_SUMMARY.md',
    'FINAL_QUALITY_REPORT.md',
    'FINAL_WORKFLOW_CONFIG.md',
    'FORUM_POST_V2.9.9_FIX.md',
    'IMAGES_FIX_REPORT.md',
    'PUSH_DIAGNOSTIC.md',
    'RAPPORT_CORRECTIONS_COMPLETES.md',
    'RECAP_IMPLEMENTATION_OFFICIELLE.md',
    'RESPONSE_TO_PETER.md',
    'SESSION_COMPLETE_FINALE.md',
    'SESSION_COMPLETE.md',
    'WORKFLOW_FIX_COMPLETE.md',
    'WORKFLOW_FIXES_FINAL.md',
    'WORKFLOWS_CLEANUP_COMPLETE.md',
    'WORKFLOWS_FIX_REPORT.md'
  ],
  api: [
    'REFERENCES_COMPLETE.md'
  ],
  scripts: [
    'FIX_APP_IMAGES.js'
  ]
};

// Cr√©er la structure de dossiers
function createStructure() {
  console.log('üìÇ Cr√©ation structure de dossiers...\n');
  
  if (!fs.existsSync('docs')) fs.mkdirSync('docs');
  if (!fs.existsSync('docs/guides')) fs.mkdirSync('docs/guides');
  if (!fs.existsSync('docs/reports')) fs.mkdirSync('docs/reports');
  if (!fs.existsSync('docs/api')) fs.mkdirSync('docs/api');
  if (!fs.existsSync('docs/workflows')) fs.mkdirSync('docs/workflows');
  
  console.log('‚úÖ Structure cr√©√©e:\n');
  console.log('   docs/');
  console.log('   ‚îú‚îÄ‚îÄ guides/');
  console.log('   ‚îú‚îÄ‚îÄ reports/');
  console.log('   ‚îú‚îÄ‚îÄ api/');
  console.log('   ‚îî‚îÄ‚îÄ workflows/');
  console.log('');
}

// Organiser les fichiers
function organizeFiles() {
  console.log('üì¶ Organisation des fichiers...\n');
  
  let moved = 0;
  
  // Guides
  fileClassification.guides.forEach(file => {
    if (fs.existsSync(file)) {
      const dest = path.join('docs', 'guides', file);
      fs.copyFileSync(file, dest);
      moved++;
      console.log(`   ‚úì ${file} ‚Üí docs/guides/`);
    }
  });
  
  // Reports
  fileClassification.reports.forEach(file => {
    if (fs.existsSync(file)) {
      const dest = path.join('docs', 'reports', file);
      fs.copyFileSync(file, dest);
      moved++;
      console.log(`   ‚úì ${file} ‚Üí docs/reports/`);
    }
  });
  
  // API
  fileClassification.api.forEach(file => {
    if (fs.existsSync(file)) {
      const dest = path.join('docs', 'api', file);
      fs.copyFileSync(file, dest);
      moved++;
      console.log(`   ‚úì ${file} ‚Üí docs/api/`);
    }
  });
  
  console.log(`\n‚úÖ ${moved} fichiers organis√©s\n`);
}

// V√©rifications compl√®tes
function runVerifications() {
  console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
  console.log('‚ïë              üîç V√âRIFICATIONS COMPL√àTES                ‚ïë');
  console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
  
  const checks = {
    drivers: 0,
    images: 0,
    compose: 0,
    deviceJs: 0,
    endpoints: 0,
    manufacturerIds: 0
  };
  
  // V√©rifier drivers
  const driversDir = 'drivers';
  if (fs.existsSync(driversDir)) {
    const drivers = fs.readdirSync(driversDir).filter(d => 
      fs.statSync(path.join(driversDir, d)).isDirectory()
    );
    
    checks.drivers = drivers.length;
    
    drivers.forEach(driver => {
      const driverPath = path.join(driversDir, driver);
      
      // V√©rifier driver.compose.json
      const composePath = path.join(driverPath, 'driver.compose.json');
      if (fs.existsSync(composePath)) {
        checks.compose++;
        
        try {
          const compose = JSON.parse(fs.readFileSync(composePath, 'utf8'));
          
          // V√©rifier endpoints
          if (compose.zigbee && compose.zigbee.endpoints) {
            checks.endpoints++;
          }
          
          // V√©rifier manufacturerName
          if (compose.zigbee && compose.zigbee.manufacturerName) {
            checks.manufacturerIds++;
          }
        } catch (e) {
          // Ignorer erreurs JSON
        }
      }
      
      // V√©rifier device.js
      if (fs.existsSync(path.join(driverPath, 'device.js'))) {
        checks.deviceJs++;
      }
      
      // V√©rifier images
      const assetsPath = path.join(driverPath, 'assets');
      if (fs.existsSync(assetsPath)) {
        const hasSmall = fs.existsSync(path.join(assetsPath, 'small.png'));
        const hasLarge = fs.existsSync(path.join(assetsPath, 'large.png'));
        const hasXlarge = fs.existsSync(path.join(assetsPath, 'xlarge.png'));
        
        if (hasSmall && hasLarge && hasXlarge) {
          checks.images++;
        }
      }
    });
  }
  
  // Afficher r√©sultats
  console.log('üìä R√âSULTATS V√âRIFICATIONS:\n');
  console.log(`   Drivers total:          ${checks.drivers}`);
  console.log(`   driver.compose.json:    ${checks.compose}/${checks.drivers} (${Math.round(checks.compose/checks.drivers*100)}%)`);
  console.log(`   device.js:              ${checks.deviceJs}/${checks.drivers} (${Math.round(checks.deviceJs/checks.drivers*100)}%)`);
  console.log(`   Images compl√®tes:       ${checks.images}/${checks.drivers} (${Math.round(checks.images/checks.drivers*100)}%)`);
  console.log(`   Endpoints d√©finis:      ${checks.endpoints}/${checks.drivers} (${Math.round(checks.endpoints/checks.drivers*100)}%)`);
  console.log(`   ManufacturerIDs:        ${checks.manufacturerIds}/${checks.drivers} (${Math.round(checks.manufacturerIds/checks.drivers*100)}%)`);
  console.log('');
  
  // V√©rifier app.json
  try {
    if (fs.existsSync('app.json')) {
      const app = JSON.parse(fs.readFileSync('app.json', 'utf8'));
      console.log('üì¶ APP.JSON:\n');
      console.log(`   Version:                ${app.version}`);
      console.log(`   SDK:                    ${app.sdk}`);
      console.log(`   ID:                     ${app.id}`);
      console.log(`   Compatibility:          ${app.compatibility}`);
      console.log('');
    }
  } catch (e) {
    console.log('‚ö†Ô∏è  Erreur lecture app.json\n');
  }
  
  // V√©rifier changelog
  try {
    if (fs.existsSync('.homeychangelog.json')) {
      const changelog = JSON.parse(fs.readFileSync('.homeychangelog.json', 'utf8'));
      const versions = Object.keys(changelog);
      console.log('üìã CHANGELOG:\n');
      console.log(`   Versions document√©es:   ${versions.length}`);
      console.log(`   Derni√®re version:       ${versions[0]}`);
      console.log('');
    }
  } catch (e) {
    console.log('‚ö†Ô∏è  Erreur lecture changelog\n');
  }
  
  return checks;
}

// Cr√©er index de documentation
function createDocIndex() {
  console.log('üìö Cr√©ation index documentation...\n');
  
  const index = `# üìö DOCUMENTATION INDEX - UNIVERSAL TUYA ZIGBEE

**Version:** 2.10.2  
**Date:** ${new Date().toLocaleDateString('fr-FR')}

---

## üìñ GUIDES

### D√©marrage
- [README](../README.md) - Guide principal
- [Installation](guides/INSTALLATION.md) - Installation et configuration
- [Quick Start](guides/QUICK_START_PUBLICATION.md) - D√©marrage rapide

### D√©veloppement
- [Developer Guide](guides/DEVELOPER_GUIDE.md) - Guide d√©veloppeur complet
- [Contributing](guides/CONTRIBUTING.md) - Contribution au projet
- [Scripts](guides/SCRIPTS_README.md) - Documentation scripts

### Publication
- [Publication Guide](guides/PUBLICATION_GUIDE_OFFICIELLE.md) - Guide officiel
- [Auto-Publish](guides/AUTO_PUBLISH_GUIDE.md) - Publication automatique
- [GitHub Actions](guides/GITHUB_ACTIONS_SETUP.md) - Configuration CI/CD
- [Quality Checks](guides/QUALITY_CHECKS_GUIDE.md) - V√©rifications qualit√©

### Sp√©cifique Tuya
- [Tuya Datapoints](guides/TUYA_DATAPOINTS_GUIDE.md) - Guide datapoints
- [Batteries](guides/EXPLICATION_BATTERIES.md) - Gestion batteries
- [Exemples](reports/EXEMPLE_BATTERIE_CONCRET.md) - Exemples concrets

---

## üìä RAPPORTS

### Session Marathon
- [Session Complete](reports/SESSION_COMPLETE.md) - R√©capitulatif final
- [Final Quality](reports/FINAL_QUALITY_REPORT.md) - Rapport qualit√©
- [Complete Summary](reports/COMPLETE_SESSION_SUMMARY.md) - R√©sum√© complet

### Corrections
- [Deep Analysis](reports/DEEP_ANALYSIS_REPORT.md) - Analyse profonde
- [Corrections](reports/RAPPORT_CORRECTIONS_COMPLETES.md) - Corrections appliqu√©es
- [Driver Icons](reports/DRIVER_ICONS_COMPLETE.md) - Ic√¥nes drivers
- [Images Fix](reports/IMAGES_FIX_REPORT.md) - Correctifs images

### Workflows
- [Workflow Config](reports/FINAL_WORKFLOW_CONFIG.md) - Configuration finale
- [Workflow Fixes](reports/WORKFLOW_FIXES_FINAL.md) - Correctifs workflow
- [Cleanup](reports/WORKFLOWS_CLEANUP_COMPLETE.md) - Nettoyage

### Communication
- [Response to Peter](reports/RESPONSE_TO_PETER.md) - Email utilisateur
- [Forum Post](reports/FORUM_POST_V2.9.9_FIX.md) - Post communaut√©

---

## üîß API & R√âF√âRENCES

- [References Complete](api/REFERENCES_COMPLETE.md) - Toutes r√©f√©rences

---

## üìù CHANGELOG

Voir [CHANGELOG.md](../CHANGELOG.md) et [.homeychangelog.json](../.homeychangelog.json)

---

**G√©n√©r√© automatiquement par ORGANIZE_AND_VERIFY.js**
`;
  
  fs.writeFileSync('docs/INDEX.md', index);
  console.log('‚úÖ Index cr√©√©: docs/INDEX.md\n');
}

// Ex√©cution
try {
  createStructure();
  organizeFiles();
  const checks = runVerifications();
  createDocIndex();
  
  console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
  console.log('‚ïë            ‚úÖ ORGANISATION TERMIN√âE                    ‚ïë');
  console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
  
  console.log('üìä R√âSUM√â:\n');
  console.log(`   ‚úì Structure cr√©√©e`);
  console.log(`   ‚úì Fichiers organis√©s`);
  console.log(`   ‚úì V√©rifications compl√®tes`);
  console.log(`   ‚úì Index documentation`);
  console.log(`   ‚úì ${checks.drivers} drivers v√©rifi√©s\n`);
  
} catch (error) {
  console.error('‚ùå Erreur:', error.message);
  process.exit(1);
}
