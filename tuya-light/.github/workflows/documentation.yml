name: ğŸ“š Documentation & Translation

on:
  push:
    branches: [ master ]
    paths:
      - 'drivers/**'
      - 'README.md'
      - 'CHANGELOG.md'
      - '.github/workflows/documentation.yml'
  workflow_dispatch:
    inputs:
      language:
        description: 'Language to generate documentation for'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - en
          - fr
          - nl
          - ta

permissions:
  contents: read
  issues: write
  actions: read

concurrency:
  group: documentation-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        language: [en, fr, nl, ta]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸŒ Setup language environment
        run: |
          echo "ğŸŒ Setting up language environment for ${{ matrix.language }}"
          
          # Set language-specific variables
          case "${{ matrix.language }}" in
            "en")
              LANG_NAME="English"
              LANG_CODE="en"
              ;;
            "fr")
              LANG_NAME="FranÃ§ais"
              LANG_CODE="fr"
              ;;
            "nl")
              LANG_NAME="Nederlands"
              LANG_CODE="nl"
              ;;
            "ta")
              LANG_NAME="à®¤à®®à®¿à®´à¯"
              LANG_CODE="ta"
              ;;
          esac
          
          echo "LANG_NAME=$LANG_NAME" >> $GITHUB_ENV
          echo "LANG_CODE=$LANG_CODE" >> $GITHUB_ENV

      - name: ğŸ“Š Generate driver documentation
        run: |
          echo "ğŸ“Š Generating driver documentation for $LANG_NAME..."
          
          # Create documentation directory
          mkdir -p docs/$LANG_CODE
          
          # Generate driver overview
          cat << EOF > docs/$LANG_CODE/drivers-overview.md
          # Driver Overview - $LANG_NAME
          
          **Generated**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          **Language**: $LANG_NAME ($LANG_CODE)
          
          ## Zigbee Drivers
          
          ### Categories
          EOF
          
          # Add Zigbee categories
          for category in $(find drivers/zigbee -type d -mindepth 2 -maxdepth 2 -exec basename {} \; | sort); do
            driver_count=$(find drivers/zigbee/$category -name "device.js" | wc -l)
            echo "#### $category ($driver_count drivers)" >> docs/$LANG_CODE/drivers-overview.md
            echo "" >> docs/$LANG_CODE/drivers-overview.md
          done
          
          echo "## Tuya Drivers" >> docs/$LANG_CODE/drivers-overview.md
          echo "" >> docs/$LANG_CODE/drivers-overview.md
          echo "### Categories" >> docs/$LANG_CODE/drivers-overview.md
          
          # Add Tuya categories
          for category in $(find drivers/tuya -type d -mindepth 2 -maxdepth 2 -exec basename {} \; | sort); do
            driver_count=$(find drivers/tuya/$category -name "device.js" | wc -l)
            echo "#### $category ($driver_count drivers)" >> docs/$LANG_CODE/drivers-overview.md
            echo "" >> docs/$LANG_CODE/drivers-overview.md
          done

      - name: ğŸ“ Generate changelog
        run: |
          echo "ğŸ“ Generating changelog for $LANG_NAME..."
          
          # Create changelog
          cat << EOF > docs/$LANG_CODE/CHANGELOG.md
          # Changelog - $LANG_NAME
          
          **Version**: 2.0.0
          **Date**: $(date -u +'%Y-%m-%d')
          **Language**: $LANG_NAME
          
          ## [2.0.0] - $(date -u +'%Y-%m-%d')
          
          ### Added
          - ğŸš€ Complete driver reorganization
          - ğŸ“ Structured category system
          - ğŸ”„ Automated workflows
          - ğŸ“š Multi-language documentation
          - ğŸ§¹ Automated maintenance
          
          ### Changed
          - ğŸ”„ Improved project structure
          - ğŸ“Š Enhanced driver organization
          - ğŸ¯ Optimized workflows
          - ğŸŒ Multi-language support
          
          ### Fixed
          - ğŸ› Workflow syntax errors
          - ğŸ”§ Build configuration issues
          - ğŸ“ File organization problems
          
          ## [1.0.0] - Initial Release
          
          ### Added
          - ğŸ”Œ Basic driver support
          - ğŸ“± Homey integration
          - ğŸ”§ Basic configuration
          
          ---
          
          *This changelog is automatically generated for $LANG_NAME ($LANG_CODE)*
          EOF

      - name: ğŸ“š Generate README
        run: |
          echo "ğŸ“š Generating README for $LANG_NAME..."
          
          # Create README
          cat << EOF > docs/$LANG_CODE/README.md
          # Tuya Zigbee Project - $LANG_NAME
          
          ## ğŸŒŸ Overview
          
          This project provides comprehensive driver support for Tuya and Zigbee devices in Homey.
          
          ## ğŸ“ Structure
          
          ### Drivers
          - **Zigbee**: $(find drivers/zigbee -name "device.js" | wc -l) drivers in $(find drivers/zigbee -type d -mindepth 2 -maxdepth 2 | wc -l) categories
          - **Tuya**: $(find drivers/tuya -name "device.js" | wc -l) drivers in $(find drivers/tuya -type d -mindepth 2 -maxdepth 2 | wc -l) categories
          
          ### Categories
          - Climate control
          - Lighting
          - Sensors
          - Switches
          - Security
          - Covers
          - Plugs
          - Other devices
          
          ## ğŸš€ Features
          
          - ğŸ”Œ Complete driver coverage
          - ğŸ“± Homey SDK3 support
          - ğŸŒ Multi-language support
          - ğŸ”„ Automated workflows
          - ğŸ“Š Real-time monitoring
          
          ## ğŸ“– Documentation
          
          - [Driver Overview](drivers-overview.md)
          - [Changelog](CHANGELOG.md)
          - [Installation Guide](../en/INSTALLATION.md)
          
          ---
          
          *Documentation generated for $LANG_NAME ($LANG_CODE)*
          EOF

      - name: ğŸ“¤ Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation-${{ matrix.language }}
          path: docs/${{ matrix.language }}/
          retention-days: 30

  finalize-docs:
    runs-on: ubuntu-latest
    needs: generate-docs
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“Š Documentation Summary
        run: |
          echo "ğŸ“Š Documentation Generation Summary"
          echo "=================================="
          echo "ğŸ“… Generated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸŒ Languages processed: ${{ github.event.inputs.language == 'all' && 'English, French, Dutch, Tamil' || github.event.inputs.language }}"
          echo "ğŸ“š Documentation files created"
          echo "ğŸ“ Changelogs generated"
          echo "ğŸ“– READMEs updated"
          echo ""
          echo "âœ… All documentation has been generated successfully!"
          echo "ğŸš€ Multi-language support is now complete!"
