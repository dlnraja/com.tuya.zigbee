name: Version Bump & Release

on:
  workflow_dispatch:
    inputs:
      version:
        type: choice
        description: 'Version bump type'
        required: true
        default: patch
        options:
          - major
          - minor
          - patch
      changelog:
        type: string
        description: 'Changelog (English)'
        required: true
        default: 'ðŸ”§ Automated release with latest fixes and improvements'

permissions:
  contents: write

jobs:
  version-bump:
    name: Bump Version & Create Release
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ðŸ”¢ Update Homey App Version
        uses: athombv/github-action-homey-app-version@master
        id: update_version
        with:
          version: ${{ inputs.version }}
          changelog: ${{ inputs.changelog }}
          
      - name: âœ… Validate updated app
        uses: athombv/github-action-homey-app-validate@master
        with:
          level: publish
          
      - name: ðŸ’¾ Commit & Push
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: Bump version to v${{ steps.update_version.outputs.version }}
          
          ${{ inputs.changelog }}"
          git tag "v${{ steps.update_version.outputs.version }}"
          git push origin HEAD --tags
          
      - name: ðŸš€ Create GitHub Release
        run: |
          gh release create "v${{ steps.update_version.outputs.version }}" \
            --title "v${{ steps.update_version.outputs.version }}" \
            --notes "${{ inputs.changelog }}" \
            --latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ github.token }}
          
      - name: ðŸ“Š Summary
        run: |
          echo "# ðŸŽ‰ Version Bump Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **New Version:** v${{ steps.update_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Changelog:** ${{ inputs.changelog }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Release:** https://github.com/${{ github.repository }}/releases/tag/v${{ steps.update_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Release will trigger automatic publication to Homey App Store!" >> $GITHUB_STEP_SUMMARY
