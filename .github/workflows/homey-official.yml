name: Homey App Store Publication

on:
  push:
    branches: [master, main]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci || npm install
      
      - name: Install Homey CLI
        run: |
          npm install -g homey
          homey --version
      
      - name: Configure Homey Auth
        env:
          HOMEY_TOKEN: ${{ secrets.HOMEY_TOKEN }}
        run: |
          if [ -z "$HOMEY_TOKEN" ]; then
            echo "ERROR: HOMEY_TOKEN not configured"
            exit 1
          fi
          mkdir -p ~/.homey
          echo '{"token":"'"$HOMEY_TOKEN"'"}' > ~/.homey/.homeyrc.json
      
      - name: Clean Cache
        run: rm -rf .homeybuild .homeycompose
      
      - name: Validate App
        run: homey app validate --level=publish
      
      - name: Build App
        run: homey app build
      
      - name: Publish to App Store
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y expect
          
          cat > publish.exp << 'EOF'
          #!/usr/bin/expect -f
          set timeout 300
          
          spawn homey app publish
          
          expect {
            "uncommitted changes" {
              send "n\r"
              exp_continue
            }
            "update your app's version" {
              send "y\r"
              exp_continue
            }
            "Select the desired version" {
              send "\r"
              exp_continue
            }
            "What's new" {
              send "SDK3 fixes + workflow\r"
              exp_continue
            }
            "Do you want to commit" {
              send "n\r"
              exp_continue
            }
            timeout {
              puts "Timeout"
              exit 1
            }
            eof
          }
          EOF
          
          chmod +x publish.exp
          ./publish.exp
      
      - name: Summary
        if: always()
        run: |
          echo "## Publication Status" >> $GITHUB_STEP_SUMMARY
          echo "**App:** Universal Tuya Zigbee" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "[Dashboard](https://tools.developer.homey.app/apps/app/com.dlnraja.tuya.zigbee)" >> $GITHUB_STEP_SUMMARY
