name: ðŸš€ Publish to Homey (Official Actions)

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - none
        default: 'patch'
      skip_validation:
        description: 'Skip validation'
        required: false
        type: boolean
        default: false

jobs:
  publish:
    name: ðŸš€ Publish App
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: âœ… Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: âœ… Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          
      - name: ðŸ“¦ Install Dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          npm ci
          echo "âœ… Dependencies installed"
          
      - name: ðŸ” Get Current Version
        id: current-version
        run: |
          VERSION=$(node -p "require('./app.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Current version: $VERSION"
          
      - name: âœ… Validate App
        if: ${{ !inputs.skip_validation }}
        uses: athombv/github-action-homey-app-validate@v1
        with:
          personal_access_token: ${{ secrets.HOMEY_PAT }}
          
      - name: ðŸ”¢ Update Version
        if: ${{ inputs.version_type != 'none' }}
        id: new-version
        uses: athombv/github-action-homey-app-update-version@v1
        with:
          personal_access_token: ${{ secrets.HOMEY_PAT }}
          version_type: ${{ inputs.version_type }}
          
      - name: ðŸ“ Get Updated Version
        id: version
        run: |
          VERSION=$(node -p "require('./app.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Version to publish: $VERSION"
          
      - name: ðŸš€ Publish to Homey App Store
        id: publish
        uses: athombv/github-action-homey-app-publish@v1
        with:
          personal_access_token: ${{ secrets.HOMEY_PAT }}
          
      - name: ðŸ“ Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: |
            ## ðŸš€ Version ${{ steps.version.outputs.version }}
            
            Published to Homey App Store using official Athom GitHub Actions.
            
            ### ðŸ“¦ What's Changed
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md)
            
            ### ðŸ”— Links
            - ðŸª [Homey App Store](${{ steps.publish.outputs.url }})
            - ðŸ› ï¸ [Developer Dashboard](https://tools.developer.homey.app)
            - ðŸ“– [Documentation](https://github.com/${{ github.repository }})
            
            ### âš™ï¸ Workflow Info
            - Workflow: `publish-official-optimized.yml`
            - Run: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - Commit: ${{ github.sha }}
          files: |
            CHANGELOG.md
          draft: false
          prerelease: false
          
      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "# ðŸš€ Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "## âœ… SUCCESS!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¦ Published to Homey App Store" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— Manage your app: ${{ steps.publish.outputs.url }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. ðŸŒ Visit [Developer Dashboard](https://tools.developer.homey.app)" >> $GITHUB_STEP_SUMMARY
            echo "2. ðŸ“± Go to **My Apps** â†’ **com.dlnraja.tuya.zigbee**" >> $GITHUB_STEP_SUMMARY
            echo "3. âœ… Choose deployment: **Test** or **Live**" >> $GITHUB_STEP_SUMMARY
            echo "4. ðŸ“¤ Submit for certification (if publishing to public)" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”§ Troubleshooting" >> $GITHUB_STEP_SUMMARY
            echo "1. Verify HOMEY_PAT is configured correctly" >> $GITHUB_STEP_SUMMARY
            echo "2. Check app.json validity" >> $GITHUB_STEP_SUMMARY
            echo "3. Run validation locally: \`homey app validate --level publish\`" >> $GITHUB_STEP_SUMMARY
            echo "4. Check [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Workflow: publish-official-optimized.yml*" >> $GITHUB_STEP_SUMMARY
