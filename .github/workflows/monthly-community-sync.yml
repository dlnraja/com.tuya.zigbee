# Monthly Community Sync - Universal Tuya Zigbee
# Automatically sources fingerprints from community projects
# ENRICHMENT ONLY - Never overwrites base code, only adds complementary data
# Sources: JohanBendz fork, Zigbee2MQTT, ZHA, GitHub Issues/PRs

name: ğŸŒ Monthly Community Sync

on:
  schedule:
    - cron: '0 4 1 * *'  # 1st of month at 4 AM UTC
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no commits)'
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: read

env:
  NODE_VERSION: '20'

jobs:
  community-sync:
    name: ğŸ”„ Sync Community Sources
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline || npm install

      - name: ğŸŒ Run Community Sync
        run: node scripts/community-sync/sync-all.js
        
      - name: ğŸ“Š Generate Summary Report
        run: node scripts/community-sync/generate-report.js >> $GITHUB_STEP_SUMMARY

      - name: ï¿½ Create Issue for New Fingerprints
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'data/community-sync/new-fingerprints.json';
            if (!fs.existsSync(reportPath)) return;
            const fps = JSON.parse(fs.readFileSync(reportPath));
            if (fps.length === 0) return;
            
            const body = `## ğŸŒ Monthly Community Sync Found ${fps.length} New Fingerprints\n\n` +
              `| Manufacturer ID | Source | Driver (if known) |\n|---|---|---|\n` +
              fps.slice(0,50).map(f => `| \`${f.mfr}\` | ${f.source} | ${f.driver || '-'} |`).join('\n') +
              `\n\n*Auto-generated by monthly community sync*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner, repo: context.repo.repo,
              title: `[Auto] ${fps.length} new fingerprints from community (${new Date().toISOString().slice(0,7)})`,
              body, labels: ['enhancement', 'community-sync']
            });

      - name: ğŸ“ Commit Reports
        if: ${{ !inputs.dry_run }}
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add data/community-sync/*.json || true
          git diff --staged --quiet || git commit -m "ğŸŒ Monthly community sync $(date +%Y-%m)"
          git push || true
