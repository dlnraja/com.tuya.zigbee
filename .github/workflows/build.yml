name: Build - Compilation et DÃ©ploiement
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Validate project structure
      run: |
        echo "ğŸ” Validation de la structure du projet..."
        echo "ğŸ“ Structure dÃ©tectÃ©e:"
        ls -la
        echo "ğŸ“Š Drivers: $(find drivers -name "*.js" | wc -l) fichiers"
        echo "ğŸ“Š Assets: $(find assets -type f | wc -l) fichiers"
        echo "ğŸ“Š Locales: $(find locales -type f | wc -l) fichiers"
        
    - name: Build validation
      run: |
        echo "ğŸ” Validation du build..."
        if [ -f "app.json" ] && [ -f "package.json" ]; then
          echo "âœ… Fichiers de configuration prÃ©sents"
          echo "ğŸ“¦ Version: $(jq -r '.version' app.json)"
          echo "ğŸ·ï¸ Nom: $(jq -r '.name' app.json)"
        else
          echo "âŒ Fichiers de configuration manquants"
          exit 1
        fi
        
    - name: Create build artifacts
      run: |
        echo "ğŸ” CrÃ©ation des artefacts de build..."
        mkdir -p build
        cp app.json build/
        cp package.json build/
        cp -r drivers build/ 2>/dev/null || echo "âš ï¸ Pas de dossier drivers"
        cp -r assets build/ 2>/dev/null || echo "âš ï¸ Pas de dossier assets"
        cp -r locales build/ 2>/dev/null || echo "âš ï¸ Pas de dossier locales"
        echo "âœ… Artefacts crÃ©Ã©s"
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tuya-zigbee-build
        path: build/
        retention-days: 30
        
    - name: Build success
      run: |
        echo "ğŸ‰ Build terminÃ© avec succÃ¨s!"
        echo "ğŸ“Š RÃ©sumÃ©:"
        echo "- âœ… Structure validÃ©e"
        echo "- âœ… Configuration vÃ©rifiÃ©e"
        echo "- âœ… Artefacts crÃ©Ã©s"
        echo "- âœ… Build uploadÃ©"

