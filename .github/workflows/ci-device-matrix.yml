name: ğŸ“Š Device Matrix Generator

on:
  schedule:
    - cron: '0 2 * * 1'  # Every Monday at 2 AM
  push:
    branches: [ master, tuya-light ]
    paths:
      - 'drivers/**'
      - 'lib/**'
  workflow_dispatch:

jobs:
  generate-matrix:
    name: ğŸ” Generate Device Matrix
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        npm ci
        echo "  \n"
        
    - name: ğŸ“Š Generate Device Matrix
      run: |
        echo "ğŸ“Š Generating device matrix..."
        node tools/generate-device-matrix.js
        echo "  \n"
        
    - name: ğŸ“‹ Validate Matrix Format
      run: |
        echo "ğŸ“‹ Validating matrix format..."
        if [ -f "device-matrix.csv" ]; then
          echo "âœ… Matrix file generated successfully"
          echo "ğŸ“Š Matrix preview:"
          head -5 device-matrix.csv
        else
          echo "âŒ Matrix file not found"
          exit 1
        fi
        echo "  \n"
        
    - name: ğŸ”„ Commit Matrix Updates
      run: |
        echo "ğŸ”„ Committing matrix updates..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add device-matrix.csv
        git diff --staged --quiet || git commit -m "ğŸ“Š Auto-update device matrix [skip ci]"
        echo "  \n"
        
    - name: ğŸ“¤ Push Matrix Updates
      run: |
        echo "ğŸ“¤ Pushing matrix updates..."
        git push origin ${{ github.ref }}
        echo "  \n"
        
    - name: ğŸ“Š Upload Matrix Artifact
      uses: actions/upload-artifact@v4
      with:
        name: device-matrix
        path: device-matrix.csv
        retention-days: 90
        
    - name: ğŸ¯ Matrix Generation Complete
      run: |
        echo "ğŸ¯ Device matrix generation completed!"
        echo "âœ… Matrix file generated and validated"
        echo "âœ… Matrix committed to repository"
        echo "âœ… Matrix available as artifact"
