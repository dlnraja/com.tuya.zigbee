# Description: Mise Ã  jour automatique du projet - synchronisation, validation et dÃ©ploiement continu
name: Auto-Update
on:
  schedule:
    - cron: '0 6 * * 0,3,6' # Dimanche, mercredi, samedi Ã  6h
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  auto-update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Check for updates
      run: |
        echo "ğŸ” VÃ©rification des mises Ã  jour..."
        echo "ğŸ“Š Version actuelle: $(jq -r '.version' package.json)"
        echo "ğŸ“Š DerniÃ¨re modification: $(git log -1 --format='%cd' --date=short)"
        echo "ğŸ“Š Nombre de commits: $(git rev-list --count HEAD)"
        
    - name: Validate project integrity
      run: |
        echo "ğŸ” Validation de l'intÃ©gritÃ© du projet..."
        if [ -f "package.json" ] && [ -f "README.md" ]; then
          echo "âœ… Fichiers critiques prÃ©sents"
        else
          echo "âŒ Fichiers critiques manquants"
          exit 1
        fi
        
    - name: Update project status
      run: |
        echo "ğŸ“Š Mise Ã  jour du statut du projet..."
        mkdir -p logs
        echo "Project Update Report - $(date)" > logs/update-report.log
        echo "Version: $(jq -r '.version' package.json)" >> logs/update-report.log
        echo "Drivers: $(find drivers -name '*.js' | wc -l)" >> logs/update-report.log
        echo "Workflows: $(find .github/workflows -name '*.yml' | wc -l)" >> logs/update-report.log
        echo "Archives: $(find archives -type f | wc -l)" >> logs/update-report.log
        
    - name: Upload update report
      uses: actions/upload-artifact@v4
      with:
        name: update-report
        path: logs/update-report.log
        retention-days: 30
        
    - name: Success
      run: |
        echo "ğŸ‰ Mise Ã  jour terminÃ©e avec succÃ¨s!"
        echo "ğŸ“Š RÃ©sumÃ©:"
        echo "- âœ… VÃ©rifications effectuÃ©es"
        echo "- âœ… IntÃ©gritÃ© validÃ©e"
        echo "- âœ… Statut mis Ã  jour"
        echo "- âœ… Rapport gÃ©nÃ©rÃ©"
        
    - name: Clean up package-lock.json
      if: always()
      run: |
        echo "ğŸ§¹ Suppression du package-lock.json pour Ã©viter la surcharge du repo."
        rm -f package-lock.json

