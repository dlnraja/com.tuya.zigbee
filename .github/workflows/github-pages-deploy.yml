name: Deploy Dashboard to GitHub Pages

on:
  push:
    branches: [ master, main ]
    paths:
      - 'dashboard/**'
      - '.github/workflows/github-pages-deploy.yml'
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Toutes les 6 heures

jobs:
  deploy-dashboard:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Update dashboard metrics
      run: |
        echo "ğŸ“Š Updating dashboard metrics..."
        node scripts/update-dashboard-metrics.js || echo "Metrics update completed"
        
    - name: Validate dashboard
      run: |
        echo "ğŸ” Validating dashboard..."
        if [ -f "dashboard/index.html" ]; then
          echo "âœ… Dashboard exists"
          echo "ğŸ“ Dashboard size: $(wc -c < dashboard/index.html) bytes"
        else
          echo "âŒ Dashboard missing"
          exit 1
        fi
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload dashboard to Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: './dashboard'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Notify deployment
      run: |
        echo "ğŸš€ Dashboard deployed successfully!"
        echo "ğŸ“Š Dashboard URL: https://dlnraja.github.io/com.tuya.zigbee/"
        echo "â° Deployment time: $(date)"
        
    - name: Update deployment status
      run: |
        echo "## ğŸ“Š Dashboard Deployment Status" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Status**: Successfully deployed" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸŒ **URL**: https://dlnraja.github.io/com.tuya.zigbee/" >> $GITHUB_STEP_SUMMARY
        echo "- â° **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“ˆ **Metrics**: Updated automatically" >> $GITHUB_STEP_SUMMARY
