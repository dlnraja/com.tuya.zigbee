name: Publish to Homey App Store (Official)

'on':
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  
  # Validate app with official action
  validate:
    name: Validate Homey App
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Validate Homey App
        uses: athombv/github-action-homey-app-validate@v1
  
  # Publish app with official action
  publish:
    name: Publish Homey App
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Publish to Homey App Store
        uses: athombv/github-action-homey-app-publish@master
        id: publish
        with:
          personal_access_token: ${{ secrets.HOMEY_PAT }}
          
      - name: Publish URL
        run: |
          echo "# üéâ App Published Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Manage your app at:** ${{ steps.publish.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Version: ${{ github.ref_name || 'manual' }}" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Published to Homey App Store" >> $GITHUB_STEP_SUMMARY
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          generate_release_notes: true
          body: |
            # Release ${{ github.ref_name }}
            
            Published to Homey App Store via official Athom GitHub Actions.
            
            **Manage app:** ${{ steps.publish.outputs.url }}
            
            See [CHANGELOG.md](CHANGELOG.md) for details.
          files: |
            CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  # Notify
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [validate, publish]
    if: always()
    steps:
      - name: Success notification
        if: ${{ needs.publish.result == 'success' }}
        run: |
          echo "======================================"
          echo "‚úÖ HOMEY APP PUBLISHED SUCCESSFULLY!"
          echo "======================================"
          echo ""
          echo "Version: ${{ github.ref_name || 'manual' }}"
          echo "App Store: https://apps.homey.app/app/com.dlnraja.tuya.zigbee"
          echo ""
          echo "‚úÖ Validation passed"
          echo "‚úÖ Published to Homey App Store"
          echo "‚úÖ GitHub Release created"
          echo ""
          echo "======================================"
          
      - name: Failure notification
        if: ${{ needs.publish.result == 'failure' || needs.validate.result == 'failure' }}
        run: |
          echo "======================================"
          echo "‚ùå HOMEY APP PUBLISH FAILED"
          echo "======================================"
          echo ""
          echo "Version: ${{ github.ref_name || 'manual' }}"
          echo ""
          if [ "${{ needs.validate.result }}" == "failure" ]; then
            echo "‚ùå Validation failed - check app requirements"
          fi
          if [ "${{ needs.publish.result }}" == "failure" ]; then
            echo "‚ùå Publish failed - check HOMEY_PAT secret"
            echo ""
            echo "Get your Personal Access Token at:"
            echo "https://tools.developer.homey.app/me"
            echo ""
            echo "Add it to GitHub Secrets as HOMEY_PAT"
          fi
          echo ""
          echo "======================================"
