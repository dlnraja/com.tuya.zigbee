name: ðŸš€ MASTER Publish V2 (Fixed)

'on':
  workflow_dispatch:
    inputs:
      skip_validation:
        description: 'Skip validation'
        required: false
        type: boolean
        default: false
  push:
    tags:
      - 'v*.*.*'

jobs:
  
  publish:
    name: ðŸš€ Publish to Homey
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          
      - name: Get Version
        id: version
        run: |
          VERSION=$(node -p "require('./app.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"
          
      - name: Check HOMEY_PAT
        id: check-pat
        run: |
          if [ -z "${{ secrets.HOMEY_PAT }}" ]; then
            echo "âŒ HOMEY_PAT not configured!"
            echo ""
            echo "ðŸ”‘ Get your Personal Access Token:"
            echo "   https://tools.developer.homey.app/api"
            echo ""
            echo "ðŸ“ Add to GitHub Secrets:"
            echo "   https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "   Name: HOMEY_PAT"
            echo ""
            exit 1
          fi
          echo "âœ… HOMEY_PAT configured"
          
      - name: Install Homey CLI
        run: |
          echo "ðŸ“¦ Installing Homey CLI..."
          npm install -g homey@latest
          homey --version
          echo "âœ… Homey CLI installed"
          
      - name: Authenticate
        run: |
          echo "ðŸ” Authenticating with Homey..."
          homey login --token "${{ secrets.HOMEY_PAT }}"
          echo "âœ… Authenticated"
          
      - name: Validate
        if: ${{ !inputs.skip_validation }}
        run: |
          echo "âœ… Validating app..."
          homey app validate --level publish || {
            echo "âš ï¸ Validation warnings (continuing)"
            exit 0
          }
        continue-on-error: true
        
      - name: Build
        run: |
          echo "ðŸ—ï¸ Building app..."
          homey app build || {
            echo "âš ï¸ Build warnings (continuing)"
            exit 0
          }
        continue-on-error: true
        
      - name: Publish to Homey App Store
        id: publish
        run: |
          echo "ðŸš€ Publishing v${{ steps.version.outputs.version }} to Homey App Store..."
          homey app publish
          echo "âœ… Published successfully!"
          echo "published=true" >> $GITHUB_OUTPUT
          
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          body: |
            # ðŸŽ‰ Release v${{ steps.version.outputs.version }}
            
            ## Status
            - âœ… Published to Homey App Store via MASTER-publish-v2
            - âœ… GitHub Release created
            
            ## Links
            - [Homey App Store](https://apps.homey.app/app/com.dlnraja.tuya.zigbee)
            - [Developer Tools](https://tools.developer.homey.app)
            
            See [CHANGELOG.md](CHANGELOG.md) for details.
          files: CHANGELOG.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
        
      - name: Summary
        if: always()
        run: |
          echo "# ðŸŽ¯ Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Version: v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.publish.outcome }}" == "success" ]; then
            echo "## âœ… Success!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your app has been published to the Homey App Store." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Check [Developer Tools](https://tools.developer.homey.app)" >> $GITHUB_STEP_SUMMARY
            echo "2. Verify in [Homey App Store](https://apps.homey.app/app/com.dlnraja.tuya.zigbee)" >> $GITHUB_STEP_SUMMARY
            echo "3. Test the published version" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Publish Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Common issues:" >> $GITHUB_STEP_SUMMARY
            echo "- Token expired or invalid" >> $GITHUB_STEP_SUMMARY
            echo "- Validation errors" >> $GITHUB_STEP_SUMMARY
            echo "- Network issues" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Published using MASTER-publish-v2 workflow*" >> $GITHUB_STEP_SUMMARY
