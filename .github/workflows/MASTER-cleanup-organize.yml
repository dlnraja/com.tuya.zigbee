name: ðŸ§¹ MASTER Cleanup & Organize

'on':
  workflow_dispatch:
  schedule:
    - cron: '0 3 1 * *' # Monthly on 1st at 3am - Reduced frequency

jobs:
  
  cleanup:
    name: ðŸ§¹ Cleanup & Organize
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
      - name: Disable old workflows
        run: |
          echo "ðŸ” Scanning workflows..."
          
          # Create archive directory
          mkdir -p .github/workflows/archive
          
          # List of workflows to keep (active workflows)
          KEEP_WORKFLOWS=(
            "MASTER-publish.yml"
            "MASTER-cleanup-organize.yml"
            "MASTER-auto-fix-monitor.yml"
            "PUBLISH-WORKING.yml"
            "publish-official-optimized.yml"
          )
          
          # Move old workflows to archive
          cd .github/workflows
          
          for file in *.yml; do
            # Skip if it's a MASTER workflow or in KEEP list
            if [[ $file == MASTER-* ]] || [[ $file == PUBLISH-WORKING.yml ]] || [[ $file == publish-official-optimized.yml ]]; then
              echo "âœ… Keeping: $file"
              continue
            fi
            
            # Skip if it's disabled or already in archive
            if [[ $file == *.disabled ]] || [[ -d "archive" && -f "archive/$file.disabled" ]]; then
              echo "â­ï¸  Already disabled: $file"
              continue
            fi
            
            # Only archive old/unused workflows (not the active publish ones)
            if [[ $file == publish*.yml ]] || [[ $file == force-publish*.yml ]] || [[ $file == ci*.yml ]] || [[ $file == auto-*.yml ]]; then
              echo "ðŸ“¦ Archiving old workflow: $file â†’ archive/$file.disabled"
              mv "$file" "archive/$file.disabled" 2>/dev/null || echo "Already archived"
            else
              echo "â„¹ï¸  Keeping: $file (not in archive list)"
            fi
          done
          
      - name: Organize documentation
        run: |
          echo "ðŸ“š Organizing documentation..."
          
          # Create docs structure
          mkdir -p docs/workflows
          mkdir -p docs/guides
          mkdir -p docs/archive
          
          # Move workflow docs
          find . -maxdepth 1 -name "*WORKFLOW*.md" -exec mv {} docs/workflows/ \; 2>/dev/null || true
          find . -maxdepth 1 -name "*ACTIONS*.md" -exec mv {} docs/workflows/ \; 2>/dev/null || true
          find . -maxdepth 1 -name "*PUBLISH*.md" -exec mv {} docs/guides/ \; 2>/dev/null || true
          
          # Archive old docs
          find . -maxdepth 1 -name "*READY.md" -exec mv {} docs/archive/ \; 2>/dev/null || true
          find . -maxdepth 1 -name "*LAUNCHED.md" -exec mv {} docs/archive/ \; 2>/dev/null || true
          
          echo "âœ… Documentation organized"
          
      - name: Create index
        run: |
          cat > docs/README.md << 'EOF'
          # ðŸ“š Documentation Index
          
          ## ðŸš€ Active Workflows
          
          - **MASTER-publish.yml** - Main publish workflow
          - **MASTER-cleanup-organize.yml** - Cleanup & organization
          - **MASTER-auto-fix-monitor.yml** - Auto-fix & monitoring
          
          ## ðŸ“– Guides
          
          See [guides/](guides/) for:
          - Publish guides
          - Configuration guides
          - Troubleshooting
          
          ## ðŸ”§ Archived
          
          Old workflows and docs in:
          - `.github/workflows/archive/` - Old workflows
          - `docs/archive/` - Old documentation
          
          EOF
          
          echo "âœ… Index created"
          
      - name: Commit changes
        run: |
          git add -A
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit"
            exit 0
          fi
          
          git commit -m "chore: cleanup and organize workflows & docs

          ðŸ§¹ Automated cleanup:
          - Archived old workflows
          - Organized documentation
          - Created documentation index
          
          Active workflows:
          - MASTER-publish.yml
          - MASTER-cleanup-organize.yml
          - MASTER-auto-fix-monitor.yml"
          
          git push origin master
          
          echo "âœ… Changes committed and pushed"
          
      - name: Summary
        if: always()
        run: |
          echo "# ðŸ§¹ Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Actions Taken" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Old workflows archived" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Documentation organized" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Index created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Active Workflows" >> $GITHUB_STEP_SUMMARY
          echo "1. **MASTER-publish.yml** - Publish to Homey" >> $GITHUB_STEP_SUMMARY
          echo "2. **MASTER-cleanup-organize.yml** - This workflow" >> $GITHUB_STEP_SUMMARY
          echo "3. **MASTER-auto-fix-monitor.yml** - Auto-fix & monitor" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All old workflows archived to .github/workflows/archive/" >> $GITHUB_STEP_SUMMARY
