name: Homey App Store Auto-Publish with Draftâ†’Test Promotion

on:
  push:
    branches:
      - master

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Homey CLI
        run: npm install -g homey
        
      - name: Login to Homey
        env:
          HOMEY_TOKEN: ${{ secrets.HOMEY_TOKEN }}
        run: |
          homey login --bearer $HOMEY_TOKEN
          
      - name: Validate app
        run: homey app validate --level=publish
        
      - name: Publish app (creates Draft build)
        id: publish
        run: |
          BUILD_OUTPUT=$(homey app publish 2>&1 | tee /dev/tty)
          BUILD_ID=$(echo "$BUILD_OUTPUT" | grep -oP 'App version \d+\.\d+\.\d+ has been published\. Build ID: \K\d+' || echo "")
          if [ -z "$BUILD_ID" ]; then
            BUILD_ID=$(echo "$BUILD_OUTPUT" | grep -oP 'Build #\K[0-9]+' || echo "")
          fi
          if [ -z "$BUILD_ID" ]; then
            echo "âŒ Failed to extract build ID"
            echo "Output was: $BUILD_OUTPUT"
            exit 1
          fi
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "âœ… Build #$BUILD_ID created (Draft)"
          
      - name: Auto-promote Draft to Test
        env:
          HOMEY_TOKEN: ${{ secrets.HOMEY_TOKEN }}
        run: |
          BUILD_ID="${{ steps.publish.outputs.BUILD_ID }}"
          echo "ðŸš€ Promoting Build #$BUILD_ID from Draft to Test..."
          
          # Use Homey API to promote build
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $HOMEY_TOKEN" \
            -H "Content-Type: application/json" \
            "https://api.developer.homey.app/app/com.dlnraja.tuya.zigbee/build/$BUILD_ID/promote" \
            -d '{"target": "test"}')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            echo "âœ… Build #$BUILD_ID promoted to Test successfully"
          else
            echo "âš ï¸ API returned status $HTTP_CODE"
            echo "Response: $BODY"
            echo "Note: Build may still be promoted, check dashboard"
          fi
          
      - name: Summary
        run: |
          echo "## ðŸ“Š Publication Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build ID:** ${{ steps.publish.outputs.BUILD_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Test (auto-promoted)" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://homey.app/a/com.dlnraja.tuya.zigbee/test/" >> $GITHUB_STEP_SUMMARY
          echo "- **Dashboard:** https://tools.developer.homey.app/apps/app/com.dlnraja.tuya.zigbee" >> $GITHUB_STEP_SUMMARY
