name: ğŸ›¡ï¸ Continuous Security Monitoring

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  schedule:
    - cron: '0 */6 * * *'  # Toutes les 6 heures

jobs:
  security-monitoring:
    name: ğŸ” Security Monitoring
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸš¨ Block Dangerous Files
      run: |
        echo "ğŸ” Recherche fichiers dangereux..."
        DANGEROUS_FILES=$(find . -name "id_rsa*" -o -name "*.pem" -o -name "*.key" | grep -v node_modules || true)
        if [ ! -z "$DANGEROUS_FILES" ]; then
          echo "âŒ FICHIERS DANGEREUX DÃ‰TECTÃ‰S:"
          echo "$DANGEROUS_FILES"
          exit 1
        fi
        echo "âœ… Aucun fichier dangereux"
        
    - name: ğŸ” Secret Pattern Detection
      run: |
        echo "ğŸ” Recherche patterns secrets..."
        if grep -r "BEGIN.*PRIVATE KEY" . --exclude-dir=.git --exclude-dir=node_modules; then
          echo "âŒ CLÃ‰ PRIVÃ‰E DÃ‰TECTÃ‰E!"
          exit 1
        fi
        if grep -r "eyJ[A-Za-z0-9+/=]*\.[A-Za-z0-9+/=]*\.[A-Za-z0-9+/=]*" . --exclude-dir=.git --exclude-dir=node_modules; then
          echo "âŒ JWT TOKEN DÃ‰TECTÃ‰!"
          exit 1
        fi
        echo "âœ… Aucun pattern secret dÃ©tectÃ©"
        
    - name: ğŸ“Š Security Report
      run: |
        echo "ğŸ“Š RAPPORT SÃ‰CURITÃ‰ AUTOMATIQUE"
        echo "ğŸ—“ï¸ Date: $(date)"
        echo "âœ… Scan fichiers dangereux: OK"
        echo "âœ… Scan patterns secrets: OK"
        echo "ğŸ›¡ï¸ Statut: SÃ‰CURISÃ‰"
        
  auto-cleanup:
    name: ğŸ§¹ Auto Cleanup
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ§¹ Emergency Cleanup
      run: |
        echo "ğŸ§¹ Nettoyage automatique..."
        find . -name "id_rsa*" -delete || true
        find . -name "*.pem" -path "*/test/*" -delete || true
        find . -name "*.key" -path "*/fixtures/*" -delete || true
        echo "âœ… Nettoyage terminÃ©"
        
    - name: âœ‰ï¸ Notification
      if: always()
      run: |
        echo "ğŸ“§ Notification: Scan sÃ©curitÃ© automatique effectuÃ©"
        echo "ğŸ›¡ï¸ Projet maintenu sÃ©curisÃ©"
