name: ğŸ¯ Homey CI/CD
"on":
  workflow_dispatch:
    inputs:
      action:
        description: Action to perform
        required: true
        type: choice
        options:
          - validate
          - publish
          - version-patch
          - version-minor
          - version-major
        default: validate
      changelog:
        description: Changelog (for version updates)
        required: false
        type: string
        default: Bug fixes and improvements
permissions:
  contents: read
  actions: read
env:
  NODE_VERSION: "20"
jobs:
  validate:
    name: ğŸ” Validate
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.info.outputs.version }}
      name: ${{ steps.info.outputs.name }}
      id: ${{ steps.info.outputs.id }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      - name: ğŸ“¦ Get App Info
        id: info
        run: |
          VERSION=$(node -p "require('./app.json').version")
          NAME=$(node -p "require('./app.json').name.en")
          ID=$(node -p "require('./app.json').id")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "id=$ID" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ $NAME v$VERSION ($ID)"
      - name: ğŸ” Validate (Athom Official)
        uses: athombv/github-action-homey-app-validate@v1
        with:
          level: publish
      - name: âœ… Validation Summary
        run: |
          echo "## âœ… Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| App | ${{ steps.info.outputs.name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | v${{ steps.info.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ID | \`${{ steps.info.outputs.id }}\` |" >> $GITHUB_STEP_SUMMARY
    timeout-minutes: 30
    strategy:
      fail-fast: true
  version:
    name: ğŸ“¦ Update Version
    runs-on: ubuntu-latest
    needs:
      - validate
    if: >
      needs.validate.result == 'success' &&

      (inputs.action == 'version-patch' || inputs.action == 'version-minor' || inputs.action ==
      'version-major')
    outputs:
      new_version: ${{ steps.update.outputs.version }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      - name: ğŸ“¦ Determine Version Type
        id: type
        run: |
          case "${{ inputs.action }}" in
            version-patch) echo "type=patch" >> $GITHUB_OUTPUT ;;
            version-minor) echo "type=minor" >> $GITHUB_OUTPUT ;;
            version-major) echo "type=major" >> $GITHUB_OUTPUT ;;
          esac
      - name: ğŸ“¦ Update Version (Athom Official)
        uses: athombv/github-action-homey-app-version@v1
        id: update
        with:
          version: ${{ steps.type.outputs.type }}
          changelog: ${{ inputs.changelog }}
      - name: ğŸ“ Commit & Push
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "ğŸ”– v${{ steps.update.outputs.version }}: ${{ inputs.changelog }}"
          git tag "v${{ steps.update.outputs.version }}"
          git push origin HEAD --tags
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: âœ… Version Summary
        run: |
          echo "## ğŸ“¦ Version Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**New Version:** v${{ steps.update.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Changelog:** ${{ inputs.changelog }}" >> $GITHUB_STEP_SUMMARY
    timeout-minutes: 30
    strategy:
      fail-fast: true
  publish:
    name: ğŸš€ Publish
    runs-on: ubuntu-latest
    needs:
      - validate
      - version
    if: |
      always() &&
      needs.validate.result == 'success' &&
      (needs.version.result == 'success' || needs.version.result == 'skipped') &&
      inputs.action == 'publish'
    outputs:
      url: ${{ steps.publish.outputs.url }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
      - name: ğŸ”‘ Check HOMEY_PAT
        run: |
          if [ -z "${{ secrets.HOMEY_PAT }}" ]; then
            echo "::error::HOMEY_PAT not configured!"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## âŒ Authentication Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Setup Instructions:" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to [tools.developer.homey.app/me](https://tools.developer.homey.app/me)" >> $GITHUB_STEP_SUMMARY
            echo "2. Copy your **Personal Access Token**" >> $GITHUB_STEP_SUMMARY
            echo "3. Add as GitHub Secret: **HOMEY_PAT**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      - name: ğŸš€ Publish (Athom Official)
        uses: athombv/github-action-homey-app-publish@v1
        id: publish
        with:
          personal_access_token: ${{ secrets.HOMEY_PAT }}
      - name: âœ… Publish Summary
        run: >
          echo "## ğŸ‰ Published to Homey App Store!" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          echo "**Version:** v${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ğŸ”— Links" >> $GITHUB_STEP_SUMMARY

          echo "- [Manage Release](${{ steps.publish.outputs.url }})" >> $GITHUB_STEP_SUMMARY

          echo "- [App Store](https://homey.app/a/${{ needs.validate.outputs.id }})" >>
          $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ğŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY

          echo "1. Review the uploaded version" >> $GITHUB_STEP_SUMMARY

          echo "2. Submit for Test or Live certification" >> $GITHUB_STEP_SUMMARY
    timeout-minutes: 30
    strategy:
      fail-fast: true
  release:
    name: ğŸ“ GitHub Release
    runs-on: ubuntu-latest
    needs:
      - validate
      - publish
    if: needs.publish.result == 'success'
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      - name: ğŸ“ Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.validate.outputs.version }}
          name: ğŸ‰ v${{ needs.validate.outputs.version }}
          body: |
            ## Release v${{ needs.validate.outputs.version }}

            Published to Homey App Store.

            **Manage:** ${{ needs.publish.outputs.url }}
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    timeout-minutes: 30
    strategy:
      fail-fast: true
