name: ðŸ” Auto-Discover New Devices

on:
  schedule:
    # Every day at 4:00 AM UTC
    - cron: "0 4 * * *"
  workflow_dispatch:
    inputs:
      sources:
        description: "Sources to scan (comma-separated or ALL)"
        required: false
        default: "ALL"
        type: choice
        options:
          - ALL
          - zigbee2mqtt
          - zha
          - deconz
          - blakadder
          - tasmota
      dry_run:
        description: "Dry run (no commits)"
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: "18"

jobs:
  discover:
    name: ðŸ” Discover New Devices
    runs-on: ubuntu-latest
    outputs:
      new_devices_count: ${{ steps.discover.outputs.new_count }}
      has_changes: ${{ steps.discover.outputs.has_changes }}

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --ignore-scripts

      - name: ðŸ” Discover from All Sources
        id: discover
        run: |
          echo "ðŸ” Starting multi-source device discovery..."
          node scripts/enrichment/auto-discover-devices.js

          # Count new devices
          if [ -f "data/discovery/new-devices.json" ]; then
            NEW_COUNT=$(jq '.devices | length' data/discovery/new-devices.json)
            echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT

            if [ "$NEW_COUNT" -gt 0 ]; then
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "âœ… Found $NEW_COUNT new devices!"
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ No new devices found"
            fi
          else
            echo "new_count=0" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“Š Generate Discovery Report
        if: steps.discover.outputs.has_changes == 'true'
        run: |
          echo "## ðŸ” Device Discovery Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**New Devices Found:** ${{ steps.discover.outputs.new_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "data/discovery/report.md" ]; then
            cat data/discovery/report.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ’¾ Upload Discovery Artifacts
        if: steps.discover.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: discovery-results
          path: |
            data/discovery/
          retention-days: 30

  enrich:
    name: ðŸ§¬ Enrich & Implement
    needs: discover
    if: needs.discover.outputs.has_changes == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --ignore-scripts

      - name: ðŸ“¥ Download Discovery Results
        uses: actions/download-artifact@v4
        with:
          name: discovery-results
          path: data/discovery/

      - name: ðŸ§¬ Enrich New Devices
        run: |
          echo "ðŸ§¬ Enriching new devices with DP patterns..."
          node scripts/enrichment/enrich-new-devices.js

      - name: ðŸ”§ Add to Drivers
        run: |
          echo "ðŸ”§ Adding manufacturer IDs to appropriate drivers..."
          node scripts/enrichment/add-to-drivers.js

      - name: âœ… Validate Changes
        run: |
          echo "âœ… Validating driver configurations..."
          npx homey app validate --level publish || true

      - name: ðŸ“ Commit Changes
        if: ${{ !inputs.dry_run }}
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add -A

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            DEVICE_COUNT="${{ needs.discover.outputs.new_devices_count }}"
            COMMIT_DATE=$(date -u '+%Y-%m-%d')
            git commit -m "ðŸ¤– Auto-discovered +${DEVICE_COUNT} new device IDs [${COMMIT_DATE}]"

            git push origin main || git push origin master
            echo "âœ… Changes committed and pushed!"
          fi

      - name: ðŸ“Š Summary
        run: |
          echo "## ðŸ§¬ Enrichment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**New Devices Added:** ${{ needs.discover.outputs.new_devices_count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ inputs.dry_run || false }}" >> $GITHUB_STEP_SUMMARY
