name: Auto Organize Root

on:
  push:
    branches:
      - master
  workflow_dispatch:  # Manual trigger

jobs:
  organize:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper organization
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ðŸ“š Install dependencies
        run: npm ci
      
      - name: ðŸ§¹ Run organization script
        id: organize
        run: |
          node scripts/maintenance/AUTO_ORGANIZE_ROOT.js
          echo "status=$?" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: ðŸ” Validate Homey App
        id: validate
        uses: athombv/github-action-homey-app-validate@master
        with:
          level: publish
        continue-on-error: true
      
      - name: ðŸ“Š Check for changes
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Files were organized"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No changes needed"
          fi
      
      - name: ðŸ’¾ Commit organized files
        if: steps.check_changes.outputs.has_changes == 'true' && steps.validate.outcome == 'success'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "ðŸ§¹ Auto-organize: Clean up root directory [skip ci]

          - Moved temporary files to archive/
          - Organized by category and purpose
          - Preserved essential SDK files
          - Validated with official Athom action

          Generated by: Auto Organize workflow
          Triggered: ${{ github.event_name }}
          Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          git push
      
      - name: âš ï¸ Validation failed - rollback
        if: steps.check_changes.outputs.has_changes == 'true' && steps.validate.outcome != 'success'
        run: |
          echo "âŒ Homey validation failed! Rolling back changes..."
          git reset --hard HEAD
          git clean -fd
          echo "::error::Organization caused validation errors. Changes not committed."
          exit 1
      
      - name: ðŸ“ Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Auto-organize workflow failed',
              body: `The auto-organize workflow failed during execution.
              
              **Run Details:**
              - Workflow: ${{ github.workflow }}
              - Run ID: ${{ github.run_id }}
              - Triggered by: ${{ github.event_name }}
              - Date: ${{ github.event.head_commit.timestamp }}
              
              **Action Required:**
              Please review the workflow logs and fix any issues.
              
              [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`,
              labels: ['bug', 'automation', 'priority-high']
            })
      
      - name: ðŸ“Š Upload summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: organization-summary
          path: archive/ORGANIZATION_SUMMARY.json
          retention-days: 30
      
      - name: âœ… Summary
        if: always()
        run: |
          echo "# ðŸŽ¯ Auto-Organize Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Organization:** ${{ steps.organize.outputs.status == '0' && 'âœ… SUCCESS' || 'âŒ FAILED' }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Validation:** ${{ steps.validate.outcome == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Changes:** ${{ steps.check_changes.outputs.has_changes || 'No changes' }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
