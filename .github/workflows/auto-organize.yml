name: Auto Organize Project

on:
  schedule:
    - cron: '0 3 */2 * *'  # Every 2 days at 3 AM
  workflow_dispatch:  # Manual trigger
  push:
    branches:
      - master
    paths:
      - '**.md'
      - '**.txt'
      - '**.js'
      - 'commit**'
      - 'EMAIL_**'

jobs:
  organize:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper organization
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“š Install dependencies
        run: npm ci
      
      - name: ğŸ§¹ Run organization script
        id: organize
        run: |
          node scripts/cleanup/AUTO_ORGANIZE_PROJECT.js
          echo "status=$?" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: ğŸ” Homey App Validate
        id: validate
        run: |
          npx @athombv/homey app validate --level publish
          echo "validate_status=$?" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: ğŸ“Š Check for changes
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Files were organized"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No changes needed"
          fi
      
      - name: ğŸ’¾ Commit organized files
        if: steps.check_changes.outputs.has_changes == 'true' && steps.validate.outputs.validate_status == '0'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "ğŸ§¹ Auto-organize: Clean up root directory [skip ci]

          - Moved temporary files to archive/
          - Organized by category and purpose
          - Preserved essential SDK files
          - Validated with homey app validate

          Generated by: Auto Organize workflow
          Triggered: ${{ github.event_name }}
          Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          git push
      
      - name: âš ï¸ Validation failed - rollback
        if: steps.check_changes.outputs.has_changes == 'true' && steps.validate.outputs.validate_status != '0'
        run: |
          echo "âŒ Homey validation failed! Rolling back changes..."
          git reset --hard HEAD
          git clean -fd
          echo "::error::Organization caused validation errors. Changes not committed."
          exit 1
      
      - name: ğŸ“ Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Auto-organize workflow failed',
              body: `The auto-organize workflow failed during execution.
              
              **Run Details:**
              - Workflow: ${{ github.workflow }}
              - Run ID: ${{ github.run_id }}
              - Triggered by: ${{ github.event_name }}
              - Date: ${{ github.event.head_commit.timestamp }}
              
              **Action Required:**
              Please review the workflow logs and fix any issues.
              
              [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`,
              labels: ['bug', 'automation', 'priority-high']
            })
      
      - name: ğŸ“Š Upload summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: organization-summary
          path: archive/ORGANIZATION_SUMMARY.json
          retention-days: 30
      
      - name: âœ… Summary
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Auto-Organize Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Organization: ${{ steps.organize.outputs.status == '0' && 'âœ… SUCCESS' || 'âŒ FAILED' }}"
          echo "Validation: ${{ steps.validate.outputs.validate_status == '0' && 'âœ… PASSED' || 'âŒ FAILED' }}"
          echo "Changes: ${{ steps.check_changes.outputs.has_changes || 'No changes' }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
