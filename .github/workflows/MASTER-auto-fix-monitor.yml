name: ðŸ”§ MASTER Auto-Fix & Monitor

'on':
  workflow_dispatch:
  # push:
  #   branches: [master]
  # schedule:
  #   - cron: '*/30 * * * *' # Every 30 minutes - DISABLED to prevent excessive runs

jobs:
  
  monitor-and-fix:
    name: ðŸ” Monitor & Auto-Fix
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          
      - name: Check app.json validity
        id: check-app
        run: |
          echo "ðŸ“„ Checking app.json..."
          
          if ! node -e "JSON.parse(require('fs').readFileSync('app.json'))"; then
            echo "âŒ app.json is invalid JSON!"
            echo "needs_fix=true" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          VERSION=$(node -p "require('./app.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… app.json valid (v$VERSION)"
          
      - name: Check HOMEY_PAT status
        id: check-pat
        run: |
          if [ -n "${{ secrets.HOMEY_PAT }}" ]; then
            echo "has_pat=true" >> $GITHUB_OUTPUT
            echo "âœ… HOMEY_PAT configured"
          else
            echo "has_pat=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ HOMEY_PAT not configured"
          fi
          
      - name: Check if published
        id: check-published
        if: steps.check-pat.outputs.has_pat == 'true'
        run: |
          echo "ðŸ” Checking publish status..."
          
          # Install Homey CLI
          npm install -g homey >/dev/null 2>&1
          
          # Try to authenticate
          if homey login --token "${{ secrets.HOMEY_PAT }}" >/dev/null 2>&1; then
            echo "âœ… Authentication successful"
            echo "authenticated=true" >> $GITHUB_OUTPUT
            
            # Check if we can validate
            if homey app validate --level debug >/dev/null 2>&1; then
              echo "âœ… App structure valid"
              echo "valid=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ App validation issues"
              echo "valid=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Authentication failed"
            echo "authenticated=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
        
      - name: Auto-fix common issues
        id: auto-fix
        if: always()
        run: |
          echo "ðŸ”§ Running auto-fixes..."
          
          FIXED=false
          
          # Fix 1: Ensure docs directory
          if [ ! -d "docs" ]; then
            mkdir -p docs
            echo "âœ… Created docs directory"
            FIXED=true
          fi
          
          # Fix 2: Ensure package.json scripts
          if [ -f "package.json" ]; then
            if ! grep -q "build-docs" package.json; then
              echo "âš ï¸ Missing build-docs script"
              # Could add it here
            fi
          fi
          
          # Fix 3: Check workflow files
          if [ -d ".github/workflows" ]; then
            # Count active workflows
            ACTIVE=$(ls .github/workflows/*.yml 2>/dev/null | wc -l)
            echo "ðŸ“Š Active workflows: $ACTIVE"
            
            if [ $ACTIVE -gt 10 ]; then
              echo "âš ï¸ Too many workflows ($ACTIVE) - cleanup recommended"
            fi
          fi
          
          if [ "$FIXED" = "true" ]; then
            echo "needs_commit=true" >> $GITHUB_OUTPUT
          else
            echo "needs_commit=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Commit fixes
        if: ${{ steps.auto-fix.outputs.needs_commit == 'true' }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git add -A
          
          if ! git diff --staged --quiet; then
            git commit -m "fix: auto-fix issues

            ðŸ”§ Automated fixes applied:
            - Directory structure
            - Configuration files
            
            By: MASTER-auto-fix-monitor workflow"
            
            git push origin master
            echo "âœ… Fixes committed"
          fi
        continue-on-error: true
        
      - name: Trigger publish if not published
        if: |
          steps.check-pat.outputs.has_pat == 'true' &&
          steps.check-published.outputs.valid == 'true' &&
          github.event_name != 'schedule'
        run: |
          echo "ðŸš€ App is valid but might not be published"
          echo "ðŸ’¡ Recommend running MASTER-publish workflow"
          
          # Could trigger it here with gh workflow run
          # gh workflow run MASTER-publish.yml
          
      - name: Generate report
        if: always()
        run: |
          echo "# ðŸ” Monitoring Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** v${{ steps.check-app.outputs.version || 'unknown' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **app.json:** ${{ steps.check-app.outcome == 'success' && 'âœ… Valid' || 'âŒ Invalid' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **HOMEY_PAT:** ${{ steps.check-pat.outputs.has_pat == 'true' && 'âœ… Configured' || 'âš ï¸ Not configured' }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-pat.outputs.has_pat }}" == "true" ]; then
            echo "- **Authentication:** ${{ steps.check-published.outputs.authenticated == 'true' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Validation:** ${{ steps.check-published.outputs.valid == 'true' && 'âœ… Valid' || 'âš ï¸ Issues' }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-pat.outputs.has_pat }}" != "true" ]; then
            echo "## âš ï¸ Action Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**HOMEY_PAT not configured!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Get token: https://tools.developer.homey.app/api" >> $GITHUB_STEP_SUMMARY
            echo "2. Add to secrets: https://github.com/${{ github.repository }}/settings/secrets/actions" >> $GITHUB_STEP_SUMMARY
            echo "3. Name: \`HOMEY_PAT\`" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check-published.outputs.valid }}" == "true" ]; then
            echo "## âœ… All Good!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "App is valid and ready for publishing." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "[Run MASTER-publish workflow](https://github.com/${{ github.repository }}/actions/workflows/MASTER-publish.yml)" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ðŸ”§ Issues Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some issues were detected. Check logs above." >> $GITHUB_STEP_SUMMARY
          fi
