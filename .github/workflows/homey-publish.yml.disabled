name: Homey App Store - Official Publish

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 4.9.261)'
        required: true

permissions:
  contents: write
  pull-requests: read

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"
      
      - name: Validate app structure
        run: |
          echo "ðŸ” Running Homey App Store validation..."
          node scripts/validation/validate-app-structure.js
          node scripts/validation/validate-all-drivers.js
          echo "âœ… App structure valid for Homey App Store"
      
      - name: Generate changelog for release
        run: |
          echo "ðŸ“ Generating release notes..."
          node scripts/automation/auto-changelog.js
      
      - name: Create release notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Extract changelog for this version
          if [ -f CHANGELOG.md ]; then
            NOTES=$(sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d')
          else
            NOTES="Release v$VERSION"
          fi
          
          # Save to file for GitHub release
          echo "$NOTES" > release_notes.md
          echo "ðŸ“„ Release notes generated"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Notify Homey App Store
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          echo "ðŸš€ HOMEY APP STORE PUBLICATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… Git tag created: v$VERSION"
          echo "âœ… GitHub Release published"
          echo ""
          echo "ðŸ“‹ NEXT STEPS:"
          echo ""
          echo "Homey App Store will automatically detect the new tag and:"
          echo "  1. Clone the repository"
          echo "  2. Build the app"
          echo "  3. Run validation tests"
          echo "  4. Publish to App Store (if all tests pass)"
          echo ""
          echo "ðŸ“Š Monitor build status:"
          echo "  https://tools.developer.homey.app/apps/app/com.tuya.zigbee"
          echo ""
          echo "ðŸŽ¯ Test version (for private testing):"
          echo "  https://homey.app/a/com.tuya.zigbee/test/"
          echo ""
          echo "ðŸ“± Public App Store page:"
          echo "  https://homey.app/a/com.tuya.zigbee/"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "â³ Build typically takes 5-10 minutes"
          echo "ðŸ“§ You will receive an email when build completes"
          echo ""
      
      - name: Update metrics
        run: |
          echo "ðŸ“Š Updating release metrics..."
          node scripts/monitoring/count-devices.js
          node scripts/monitoring/generate-metrics-report.js
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add reports/metrics/ || true
          git commit -m "chore: Update metrics for v${{ steps.version.outputs.version }}" || true
          git push origin HEAD:master || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Comment on related PRs
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.version.outputs.version }}';
            
            // Find recent merged PRs
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              per_page: 10
            });
            
            const recentMerged = pulls.filter(pr => pr.merged_at);
            
            for (const pr of recentMerged) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `## ðŸŽ‰ Released in v${version}!
                
                Your contribution is now live in the Homey App Store!
                
                ### ðŸ“± Update Instructions
                
                Users can update via:
                - Homey app â†’ Settings â†’ Apps â†’ Tuya Zigbee â†’ Update
                - Automatic updates (if enabled)
                
                ### ðŸ™ Thank You!
                
                Your contribution helps thousands of users. 
                
                ---
                
                Released: ${new Date().toLocaleString()}`
              }).catch(() => {
                // Ignore errors (PR might have comments disabled)
              });
            }
