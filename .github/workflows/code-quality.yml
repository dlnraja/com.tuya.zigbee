name: ðŸ” Code Quality Check

on:
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  quality:
    name: ðŸ”§ Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ” Check Common Bugs
        run: |
          echo "## ðŸ” Code Quality" >> $GITHUB_STEP_SUMMARY
          
          # Settings keys bug
          if grep -rq "zb_modelId\|zb_manufacturerName" lib/ drivers/ --include="*.js" 2>/dev/null; then
            echo "âŒ Wrong settings keys (use zb_model_id)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Settings keys OK" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Flow card bug
          if grep -rq "titleFormatted.*\[\[device\]\]" drivers/ --include="*.json" 2>/dev/null; then
            echo "âŒ titleFormatted [[device]] bug" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Flow cards OK" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Import bug
          if grep -rq "require.*TuyaZigbeeDriver" drivers/ --include="*.js" 2>/dev/null; then
            echo "âŒ Wrong TuyaZigbeeDriver import" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Imports OK" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“Š Stats
        run: |
          DRIVERS=$(ls -d drivers/*/ 2>/dev/null | wc -l)
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Drivers | $DRIVERS |" >> $GITHUB_STEP_SUMMARY
