# Universal Tuya Zigbee - Code Quality Checks
# v5.8.12 - Updated 2026-02-04
# Checks for common bugs and code patterns

name: ðŸ” Code Quality Check

on:
  pull_request:
    branches: [master, main]
  push:
    branches: [master, main]
    paths:
      - '**.js'
      - 'drivers/**/*.json'
  workflow_dispatch:

jobs:
  quality:
    name: ðŸ”§ Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ” Check Common Bugs
        run: |
          echo "## ðŸ” Code Quality" >> $GITHUB_STEP_SUMMARY
          
          # Settings keys bug
          if grep -rq "zb_modelId\|zb_manufacturerName" lib/ drivers/ --include="*.js" 2>/dev/null; then
            echo "âŒ Wrong settings keys (use zb_model_id)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Settings keys OK" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Flow card bug
          if grep -rq "titleFormatted.*\[\[device\]\]" drivers/ --include="*.json" 2>/dev/null; then
            echo "âŒ titleFormatted [[device]] bug" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Flow cards OK" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Import bug
          if grep -rq "require.*TuyaZigbeeDriver" drivers/ --include="*.js" 2>/dev/null; then
            echo "âŒ Wrong TuyaZigbeeDriver import" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Imports OK" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ï¿½ Check getConditionCard vs getDeviceConditionCard
        run: |
          # Check for wrong flow card method usage
          WRONG_METHOD=$(grep -rn "getConditionCard" drivers/ --include="*.js" 2>/dev/null | grep -v "getDeviceConditionCard" | wc -l)
          if [ "$WRONG_METHOD" -gt 0 ]; then
            echo "âš ï¸ Found $WRONG_METHOD uses of getConditionCard (check if should be getDeviceConditionCard)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Flow card methods OK" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ï¿½ðŸ“Š Stats
        run: |
          DRIVERS=$(ls -d drivers/*/ 2>/dev/null | wc -l)
          MFRS=$(grep -ohE '"_TZ[^"]+"' drivers/*/driver.compose.json 2>/dev/null | sort -u | wc -l)
          FLOWCARDS=$(grep -c '"id":' drivers/*/driver.flow.compose.json 2>/dev/null | awk -F: '{sum+=$2} END {print sum}')
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Drivers | $DRIVERS |" >> $GITHUB_STEP_SUMMARY
          echo "| Manufacturer IDs | $MFRS |" >> $GITHUB_STEP_SUMMARY
          echo "| Flow Cards | $FLOWCARDS |" >> $GITHUB_STEP_SUMMARY
