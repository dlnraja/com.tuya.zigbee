name: Auto PR & Issue Handler

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, reopened]
  schedule:
    # Check every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  discussions: write

jobs:
  handle-prs:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Analyze PR
        if: github.event_name == 'pull_request'
        id: analyze
        run: |
          echo "üîç Analyzing PR #${{ github.event.pull_request.number }}..."
          
          # Check if PR adds manufacturer IDs
          if git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -q "driver.compose.json"; then
            echo "type=device_support" >> $GITHUB_OUTPUT
          else
            echo "type=other" >> $GITHUB_OUTPUT
          fi
      
      - name: Auto-respond to device support PR
        if: github.event_name == 'pull_request' && steps.analyze.outputs.type == 'device_support'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `## üéâ Thank you for your contribution!
            
            Your PR has been automatically detected as a **device support addition**.
            
            ### ‚úÖ Automated Review Process
            
            Our CI/CD pipeline will:
            1. ‚úÖ Validate JSON formatting
            2. ‚úÖ Check manufacturer ID format
            3. ‚úÖ Run Homey app validation
            4. ‚úÖ Generate test report
            
            ### üìã What happens next?
            
            - If all checks pass ‚úÖ: **Auto-merge** within 1 hour
            - If checks fail ‚ùå: I'll comment with specific issues to fix
            
            ### üôè Acknowledgment
            
            You'll be added to our **CONTRIBUTORS.md** file automatically!
            
            ---
            
            **Community-maintained project** | Active maintenance | SDK3 compliant
            
            Need help? Check our [Contributing Guide](CONTRIBUTING.md)`
            });
            
            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['device-support', 'community-contribution', 'auto-review']
            });
      
      - name: Install dependencies
        run: npm install
      
      - name: Validate PR changes
        if: github.event_name == 'pull_request'
        run: |
          echo "üîç Validating changes..."
          npx homey app validate --level publish || {
            echo "validation_failed=true" >> $GITHUB_OUTPUT
            exit 1
          }
      
      - name: Comment validation result
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## ‚ùå Validation Failed
            
            Unfortunately, the automated validation didn't pass.
            
            ### Common issues:
            
            1. **JSON formatting**: Make sure manufacturer IDs use double quotes
               \`\`\`json
               ‚úÖ "manufacturerName": ["_TZ3000_xxx"]
               ‚ùå "manufacturerName": ['_TZ3000_xxx']
               \`\`\`
            
            2. **Invalid manufacturer ID format**
               - Must match pattern: \`_TZ[A-Z0-9]{4}_[a-z0-9]{8}\`
            
            3. **Missing required files**
               - driver.compose.json
               - device.js
               - assets/images/
            
            ### üîß How to fix:
            
            1. Review the validation output above
            2. Make the necessary changes
            3. Push to your branch
            4. Validation will run automatically again
            
            Need help? Comment on this PR and I'll assist you!`
            });
      
      - name: Auto-merge if validation passed
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            
            // Add approval
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_request_number: pr.number,
              event: 'APPROVE',
              body: '‚úÖ Automated review passed! All validations successful. Thank you for your contribution!'
            });
            
            // Enable auto-merge
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_request_number: pr.number,
              merge_method: 'squash'
            });
            
            // Thank the contributor
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `## üéâ PR Merged!
            
            Your contribution has been successfully merged! 
            
            ### üôè Thank You!
            
            - You've been added to CONTRIBUTORS.md
            - Your device support is now live
            - Next app release will include your changes
            
            ### ‚òï Support the Project
            
            If this app saved you time, consider:
            - ‚≠ê Star this repository
            - üí∞ [PayPal donation](https://paypal.me/dlnraja)
            - üì¢ Share with others
            
            ---
            
            **Want to contribute more?** Check out our [open issues](../../issues)!`
            });
      
      - name: Check stale PRs
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            for (const pr of pulls) {
              const updatedAt = new Date(pr.updated_at);
              
              if (updatedAt < thirtyDaysAgo) {
                // Comment on stale PR
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: `## ‚è∞ Stale PR Notice
            
            This PR hasn't been updated in 30+ days.
            
            ### Options:
            
            1. **Update your PR** - Rebase on latest master and fix conflicts
            2. **Close if no longer needed** - Let us know!
            3. **Need help?** - Comment and we'll assist
            
            This PR will be automatically closed in 7 days if no activity.`
                });
                
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  labels: ['stale']
                });
              }
            }
  
  handle-issues:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Auto-respond to new issue
        if: github.event_name == 'issues' && github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body.toLowerCase();
            
            let response = `## üëã Thank you for opening an issue!
            
            Your issue has been received and will be reviewed shortly.
            `;
            
            // Detect issue type
            if (body.includes('device') || body.includes('not work')) {
              response += `
            ### üîç Device Support Issue
            
            To help us assist you faster, please provide:
            
            1. **Device Information**:
               - Brand and model
               - Manufacturer ID (find in Homey developer tools)
               - Product ID
            
            2. **Current Behavior**:
               - What's not working?
               - Error messages?
            
            3. **Expected Behavior**:
               - What should happen?
            
            4. **Logs** (if available):
               - Homey app logs
               - Device pairing logs
            
            ### üìö Resources:
            - [Supported Devices](docs/SUPPORTED_DEVICES.md)
            - [Troubleshooting Guide](docs/TROUBLESHOOTING.md)
            - [FAQ](docs/FAQ.md)`;
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['device-support', 'needs-info']
              });
            } else if (body.includes('bug') || body.includes('error')) {
              response += `
            ### üêõ Bug Report
            
            Thank you for reporting this bug! To help us fix it:
            
            1. **Environment**:
               - Homey version
               - App version
               - Device type
            
            2. **Steps to Reproduce**:
               - Detailed steps
               - Expected vs actual behavior
            
            3. **Logs** (crucial!):
               - App logs from Homey
               - Any error messages
            
            ### üîß Temporary Workaround
            
            While we investigate, you can try:
            - Restart the app
            - Re-pair the device
            - Check latest app version`;
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['bug', 'needs-investigation']
              });
            } else if (body.includes('feature') || body.includes('enhancement')) {
              response += `
            ### ‚ú® Feature Request
            
            Great idea! Please describe:
            
            1. **What**: What feature would you like?
            2. **Why**: What problem does it solve?
            3. **How**: How do you envision it working?
            
            We'll review and prioritize based on:
            - Community interest (üëç reactions)
            - Technical feasibility
            - Alignment with project goals`;
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['enhancement', 'community-request']
              });
            }
            
            response += `
            
            ---
            
            **Response Time**: Typically within 24-48 hours
            **Status**: This is a community-maintained project with active development
            
            ‚≠ê If this app is useful to you, consider starring the repository!`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: response
            });
      
      - name: Close resolved issues
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'waiting-for-feedback'
            });
            
            const fourteenDaysAgo = new Date();
            fourteenDaysAgo.setDate(fourteenDaysAgo.getDate() - 14);
            
            for (const issue of issues) {
              const updatedAt = new Date(issue.updated_at);
              
              if (updatedAt < fourteenDaysAgo) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `## üîí Auto-closing due to inactivity
            
            This issue has been waiting for feedback for 14+ days with no response.
            
            ### Reopen if needed
            
            If you still need help:
            1. Provide the requested information
            2. Comment to reopen
            3. We'll be happy to assist!
            
            Thank you for using this app! ‚≠ê`
                });
                
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed',
                  state_reason: 'not_planned'
                });
              }
            }
