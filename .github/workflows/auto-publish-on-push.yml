name: Auto-Publish on Push

on:
  push:
    branches:
      - master
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'README*'
      - 'CHANGELOG*'
      - 'LICENSE*'
      - '.gitignore'
      - '.vscode/**'
      - 'scripts/**'
      - 'tools/**'
      - 'achievements/**'
      - 'analysis/**'
      - 'audit/**'
      - 'audits/**'
      - 'automation/**'
      - 'backup/**'
      - 'commits/**'
      - 'communication/**'
      - 'community/**'
      - 'debug/**'
      - 'deployments/**'
      - 'diagnostics/**'
      - 'enrichment/**'
      - 'finalization/**'
      - 'fixes/**'
      - 'forum/**'
      - 'forum-responses/**'
      - 'github-analysis/**'
      - 'github-issues/**'
      - 'guides/**'
      - 'instructions/**'
      - 'matrix/**'
      - 'misc/**'
      - 'orchestrator/**'
      - 'organized/**'
      - 'pairing/**'
      - 'planning/**'
      - 'project-data/**'
      - 'project-status/**'
      - 'readme-variants/**'
      - 'references/**'
      - 'releases/**'
      - 'reports/**'
      - 'research/**'
      - 'sessions/**'
      - 'stats/**'
      - 'summaries/**'
      - 'support/**'
      - 'technical/**'
      - 'templates/**'
      - 'troubleshooting/**'
      - 'ultimate_system/**'
      - 'users/**'
      - 'workflow/**'
      - '*.bat'
      - '*.ps1'
      - '*.sh'

jobs:
  check-changes:
    name: Check if code changed
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.check.outputs.should_publish }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: ðŸ” Check changed files
        id: check
        run: |
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only HEAD^..HEAD || echo "all")
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check if ANY code files changed (not just docs)
          CODE_CHANGED=false
          
          # Critical code directories
          if echo "$CHANGED_FILES" | grep -qE '^(lib/|drivers/|app\.js|app\.json|locales/|assets/images/|\.homeycompose/)'; then
            CODE_CHANGED=true
            echo "âœ… Code files changed - will publish"
          fi
          
          # If only doc/script/analysis files changed, skip
          if [ "$CODE_CHANGED" = "false" ]; then
            echo "â­ï¸ Only documentation/scripts changed - skipping publish"
          fi
          
          echo "should_publish=$CODE_CHANGED" >> $GITHUB_OUTPUT
      
      - name: ðŸ“Œ Get version from app.json
        id: version
        run: |
          VERSION=$(node -p "require('./app.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"

  validate:
    name: Validate App
    needs: check-changes
    if: needs.check-changes.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: âœ… Validate Homey App
        uses: athombv/github-action-homey-app-validate@master
        with:
          level: publish

  publish:
    name: Auto-Publish to Homey App Store
    needs: [check-changes, validate]
    if: needs.check-changes.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸš€ Publish to Homey App Store
        uses: athombv/github-action-homey-app-publish@master
        id: publish
        with:
          personal_access_token: ${{ secrets.HOMEY_PAT }}
      
      - name: ðŸ“ Publication Summary
        run: |
          echo "# ðŸŽ‰ Auto-Publish Success!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Version:** ${{ needs.check-changes.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Published:** com.dlnraja.tuya.zigbee" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Manage:** ${{ steps.publish.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”§ **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â° App will be available in Homey App Store in ~15-30 minutes" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ·ï¸ Create Git Tag
        if: success()
        run: |
          VERSION=${{ needs.check-changes.outputs.version }}
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Check if tag already exists
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Tag v$VERSION already exists, skipping"
          else
            git tag -a "v$VERSION" -m "Auto-release v$VERSION"
            git push origin "v$VERSION"
            echo "âœ… Created tag v$VERSION"
          fi

  skip-publish:
    name: Skip Publish (Docs Only)
    needs: check-changes
    if: needs.check-changes.outputs.should_publish == 'false'
    runs-on: ubuntu-latest
    
    steps:
      - name: â­ï¸ Skip message
        run: |
          echo "# â­ï¸ Publish Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Only documentation/scripts changed - no code changes detected." >> $GITHUB_STEP_SUMMARY
          echo "Skipping Homey App Store publication." >> $GITHUB_STEP_SUMMARY
