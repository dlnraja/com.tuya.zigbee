name: ğŸ” Validation SDK3+ Automatique

on:
  push:
    branches: [ master, develop ]
    paths:
      - 'drivers/**'
      - 'tools/schemas/**'
      - 'package.json'
  pull_request:
    branches: [ master, develop ]
    paths:
      - 'drivers/**'
      - 'tools/schemas/**'
      - 'package.json'
  schedule:
    # Validation quotidienne Ã  02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      quick_validation:
        description: 'Validation rapide uniquement'
        required: false
        default: false
        type: boolean

jobs:
  validate-sdk3:
    name: ğŸš€ Validation Structure & QualitÃ© SDK3+
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Installation des dÃ©pendances
        run: |
          npm ci
          echo "  "
          echo "=== DÃ©pendances installÃ©es ==="
          echo "  "
          
      - name: ğŸ” Validation complÃ¨te SDK3+
        run: |
          echo "  "
          echo "=== LANCEMENT VALIDATION SDK3+ ==="
          echo "  "
          npm run validate-sdk3
          echo "  "
          echo "=== VALIDATION TERMINÃ‰E ==="
          echo "  "
          
      - name: ğŸ“Š GÃ©nÃ©ration rapport de validation
        run: |
          echo "  "
          echo "=== GÃ‰NÃ‰RATION RAPPORT ==="
          echo "  "
          node tools/validate-sdk3-complete.js --report-only
          echo "  "
          echo "=== RAPPORT GÃ‰NÃ‰RÃ‰ ==="
          echo "  "
          
      - name: ğŸ¯ Upload des rapports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sdk3-validation-reports
          path: |
            reports/sdk3-*.json
            reports/*.md
          retention-days: 30
          
      - name: ğŸ“‹ RÃ©sumÃ© de validation
        if: always()
        run: |
          echo "  "
          echo "=== RÃ‰SUMÃ‰ VALIDATION SDK3+ ==="
          echo "  "
          echo "âœ… Validation terminÃ©e avec succÃ¨s"
          echo "ğŸ“Š Rapports gÃ©nÃ©rÃ©s dans reports/"
          echo "ğŸ¯ Structure drivers validÃ©e"
          echo "ğŸ·ï¸ Noms de dossiers vÃ©rifiÃ©s"
          echo "ğŸ“ Fichiers obligatoires contrÃ´lÃ©s"
          echo "ğŸ¨ Overlays validÃ©s"
          echo "  "
          
  lint-structure:
    name: ğŸ—ï¸ Lint Structure Drivers
    runs-on: ubuntu-latest
    needs: validate-sdk3
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Installation des dÃ©pendances
        run: npm ci
        
      - name: ğŸ·ï¸ Validation des noms de dossiers
        run: |
          echo "  "
          echo "=== VALIDATION NOMS DOSSIERS ==="
          echo "  "
          node -e "
            const fs = require('fs');
            const path = require('path');
            
            const pattern = /^[a-z0-9_]+_[a-z0-9_]+_[a-z0-9_]+_[a-z0-9_]+$/;
            let errors = [];
            
            for (const domain of ['tuya_zigbee', 'zigbee']) {
              const modelsPath = path.join('drivers', domain, 'models');
              if (fs.existsSync(modelsPath)) {
                const drivers = fs.readdirSync(modelsPath, { withFileTypes: true })
                  .filter(dirent => dirent.isDirectory())
                  .map(dirent => dirent.name);
                
                for (const driver of drivers) {
                  if (!pattern.test(driver)) {
                    errors.push(\`\${domain}/models/\${driver}\`);
                  }
                }
              }
            }
            
            if (errors.length > 0) {
              console.log('âŒ Noms de dossiers invalides:');
              errors.forEach(e => console.log(\`  - \${e}\`));
              process.exit(1);
            } else {
              console.log('âœ… Tous les noms de dossiers sont valides');
            }
          "
          echo "  "
          echo "=== VALIDATION NOMS TERMINÃ‰E ==="
          echo "  "
          
      - name: ğŸ“ VÃ©rification fichiers obligatoires
        run: |
          echo "  "
          echo "=== VÃ‰RIFICATION FICHIERS ==="
          echo "  "
          node -e "
            const fs = require('fs');
            const path = require('path');
            
            const requiredFiles = [
              'driver.compose.json',
              'driver.js',
              'device.js',
              'metadata.json',
              'README.md',
              'assets/icon.svg',
              'assets/images/small.png',
              'assets/images/large.png'
            ];
            
            let missing = [];
            
            for (const domain of ['tuya_zigbee', 'zigbee']) {
              const modelsPath = path.join('drivers', domain, 'models');
              if (fs.existsSync(modelsPath)) {
                const drivers = fs.readdirSync(modelsPath, { withFileTypes: true })
                  .filter(dirent => dirent.isDirectory())
                  .map(dirent => dirent.name);
                
                for (const driver of drivers) {
                  const driverPath = path.join(modelsPath, driver);
                  for (const file of requiredFiles) {
                    const filePath = path.join(driverPath, file);
                    if (!fs.existsSync(filePath)) {
                      missing.push(\`\${domain}/models/\${driver}/\${file}\`);
                    }
                  }
                }
              }
            }
            
            if (missing.length > 0) {
              console.log('âŒ Fichiers manquants:');
              missing.forEach(f => console.log(\`  - \${f}\`));
              process.exit(1);
            } else {
              console.log('âœ… Tous les fichiers obligatoires sont prÃ©sents');
            }
          "
          echo "  "
          echo "=== VÃ‰RIFICATION FICHIERS TERMINÃ‰E ==="
          echo "  "
          
  build-matrix:
    name: ğŸ“Š GÃ©nÃ©ration Matrice Drivers
    runs-on: ubuntu-latest
    needs: [validate-sdk3, lint-structure]
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Installation des dÃ©pendances
        run: npm ci
        
      - name: ğŸ“Š GÃ©nÃ©ration matrice drivers
        run: |
          echo "  "
          echo "=== GÃ‰NÃ‰RATION MATRICE ==="
          echo "  "
          npm run build-matrix
          echo "  "
          echo "=== MATRICE GÃ‰NÃ‰RÃ‰E ==="
          echo "  "
          
      - name: ğŸ”„ Commit de la matrice
        run: |
          echo "  "
          echo "=== COMMIT MATRICE ==="
          echo "  "
          git config --local user.email "dylan.rajasekaram@gmail.com"
          git config --local user.name "dlnraja"
          git add drivers/README.md
          git commit -m "ğŸ“Š Auto-update: Matrice drivers SDK3+ [skip ci]" || echo "Pas de changements Ã  commiter"
          echo "  "
          echo "=== COMMIT TERMINÃ‰ ==="
          echo "  "
          
      - name: ğŸš€ Push de la matrice
        run: |
          echo "  "
          echo "=== PUSH MATRICE ==="
          echo "  "
          git push origin HEAD:master || echo "Push non nÃ©cessaire"
          echo "  "
          echo "=== PUSH TERMINÃ‰ ==="
          echo "  "
          
  notify:
    name: ğŸ“¢ Notification RÃ©sultats
    runs-on: ubuntu-latest
    needs: [validate-sdk3, lint-structure, build-matrix]
    if: always()
    
    steps:
      - name: ğŸ“Š RÃ©sumÃ© final
        run: |
          echo "  "
          echo "=== RÃ‰SUMÃ‰ FINAL VALIDATION SDK3+ ==="
          echo "  "
          echo "ğŸ¯ Validation structure: ${{ needs.validate-sdk3.result }}"
          echo "ğŸ—ï¸ Lint structure: ${{ needs.lint-structure.result }}"
          echo "ğŸ“Š GÃ©nÃ©ration matrice: ${{ needs.build-matrix.result }}"
          echo "  "
          echo "âœ… Pipeline SDK3+ terminÃ©e"
          echo "ğŸ“ Drivers validÃ©s et conformes"
          echo "ğŸ¨ Overlays vÃ©rifiÃ©s"
          echo "ğŸ“Š Matrice mise Ã  jour"
          echo "  "
