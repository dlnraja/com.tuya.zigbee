name: Homey App Store Publisher

on:
  push:
    tags:
      - 'v*'  # DÃ©clenche sur les tags de version (v4.9.294, etc.)
  workflow_dispatch:  # Permet dÃ©clenchement manuel

jobs:
  validate-and-publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ”§ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          npm install --production
          npm install -g homey
      
      - name: ğŸ” Get version from tag
        id: version
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "ğŸ“Œ Version from tag: $VERSION"
          else
            VERSION=$(node -p "require('./app.json').version")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "ğŸ“Œ Version from app.json: $VERSION"
          fi
      
      - name: âœ… Validate app structure
        run: |
          echo "ğŸ” Validating app structure..."
          
          # Check required files
          if [ ! -f "app.json" ]; then
            echo "âŒ app.json not found!"
            exit 1
          fi
          
          if [ ! -f ".homeychangelog.json" ]; then
            echo "âš ï¸ .homeychangelog.json not found!"
          fi
          
          if [ ! -d "drivers" ]; then
            echo "âŒ drivers/ directory not found!"
            exit 1
          fi
          
          echo "âœ… Basic structure validation passed"
      
      - name: ğŸ—ï¸ Build Homey app
        run: |
          echo "ğŸ—ï¸ Building Homey app..."
          homey app build
          echo "âœ… Build successful"
      
      - name: ğŸ”¬ Validate with Homey CLI (publish level)
        run: |
          echo "ğŸ”¬ Running Homey validation (publish level)..."
          homey app validate --level publish
          echo "âœ… Validation passed (publish level)"
      
      - name: ğŸ“Š Generate build report
        run: |
          echo "ğŸ“Š Build Report:" > build-report.txt
          echo "================" >> build-report.txt
          echo "" >> build-report.txt
          echo "Version: ${{ steps.version.outputs.version }}" >> build-report.txt
          echo "Git SHA: ${{ github.sha }}" >> build-report.txt
          echo "Git Ref: ${{ github.ref }}" >> build-report.txt
          echo "Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> build-report.txt
          echo "" >> build-report.txt
          echo "App Structure:" >> build-report.txt
          echo "- Drivers: $(ls -1 drivers | wc -l)" >> build-report.txt
          echo "- Lib files: $(find lib -type f -name '*.js' | wc -l)" >> build-report.txt
          echo "" >> build-report.txt
          
          if [ -f ".homeychangelog.json" ]; then
            echo "Latest Changelog:" >> build-report.txt
            node -e "const c=require('./.homeychangelog.json'); const v='${{ steps.version.outputs.version }}'; if(c[v]) console.log(c[v].en.substring(0,500)+'...');" >> build-report.txt
          fi
          
          cat build-report.txt
      
      - name: ğŸš€ Publish to Homey App Store (Official Action)
        uses: athombv/github-action-homey-app-publish@master
        id: publish
        with:
          personal_access_token: ${{ secrets.HOMEY_PAT }}
          # Note: Builds are published to Test channel by default
          # Manual promotion to Live required in Homey Developer dashboard
      
      - name: ğŸ“ Publication Success
        run: |
          echo "âœ… Published successfully to Homey App Store!"
          echo "Version ${{ steps.version.outputs.version }} is now available"
          echo "Manage URL: ${{ steps.publish.outputs.url }}"
      
      - name: ğŸ“ Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: Release v${{ steps.version.outputs.version }}
          body_path: build-report.txt
          files: |
            build/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ’¬ Post success comment
        if: success()
        run: |
          echo "âœ… DEPLOYMENT SUCCESS!"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "Published to: Homey App Store"
          echo "Available in: ~15-30 minutes for all users"
      
      - name: ğŸš¨ Handle failure
        if: failure()
        run: |
          echo "âŒ DEPLOYMENT FAILED!"
          echo "Check the logs above for details"
          echo "Common issues:"
          echo "- HOMEY_TOKEN not set or invalid"
          echo "- Validation errors in app.json"
          echo "- Missing required files"
          exit 1

  monitor:
    needs: validate-and-publish
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“Š Monitor deployment status
        run: |
          echo "ğŸ“Š Monitoring deployment..."
          echo "Status: ${{ needs.validate-and-publish.result }}"
          
          if [ "${{ needs.validate-and-publish.result }}" == "success" ]; then
            echo "âœ… Deployment successful!"
            echo "App should be available in Homey App Store within 15-30 minutes"
          else
            echo "âŒ Deployment failed!"
            echo "Check logs for error details"
          fi
