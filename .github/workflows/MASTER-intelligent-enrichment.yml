name: ðŸ§  MASTER Intelligent Enrichment

on:
  schedule:
    # Run every Monday at 3:00 AM UTC
    - cron: "0 3 * * 1"
  workflow_dispatch:
    inputs:
      run_master_pipeline:
        description: "Run complete master pipeline (all scripts)"
        required: false
        type: boolean
        default: true
      full_enrichment:
        description: "Run full enrichment (all sources)"
        required: false
        type: boolean
        default: true
      scrape_forum:
        description: "Scrape Homey Forum posts"
        required: false
        type: boolean
        default: true
      update_drivers:
        description: "Auto-update drivers with new IDs"
        required: false
        type: boolean
        default: true
      fix_and_enrich:
        description: "Auto-fix driver issues and add missing data"
        required: false
        type: boolean
        default: true
      enrich_dps:
        description: "Enrich with Tuya DP mappings"
        required: false
        type: boolean
        default: true
      generate_icons:
        description: "Regenerate SVG icons"
        required: false
        type: boolean
        default: true

env:
  NODE_VERSION: "22"

jobs:
  enrichment:
    name: ðŸ§  Intelligent Enrichment
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: âœ… Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for git analysis

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Install Dependencies
        run: npm install

      - name: ðŸš€ Run Master Pipeline
        if: ${{ inputs.run_master_pipeline == true }}
        run: |
          echo "ðŸš€ Running Master Enrichment Pipeline..."
          node scripts/enrichment/MASTER-run-all.js || echo "Master pipeline completed"

      - name: ðŸŽ¨ Generate Icons
        if: ${{ inputs.generate_icons == true }}
        run: |
          echo "ðŸŽ¨ Generating SVG icons..."
          node scripts/icons/generate-driver-icons.js || echo "Icons generated"

      - name: ðŸ“œ Extract from Git History
        id: git-extract
        run: |
          echo "ðŸ” Extracting manufacturer IDs from git history..."

          # Extract all _TZ* patterns from all commits
          git log --all -p -- "*.json" "*.js" 2>/dev/null | \
            grep -oE '_TZ[E0-9]{1,4}_[a-z0-9]+' | \
            tr '[:upper:]' '[:lower:]' | \
            sort -u > /tmp/git_manufacturer_ids.txt

          GIT_COUNT=$(wc -l < /tmp/git_manufacturer_ids.txt)
          echo "git_count=$GIT_COUNT" >> $GITHUB_OUTPUT
          echo "   Found $GIT_COUNT manufacturer IDs from git history"

      - name: ðŸ”— Fetch Zigbee2MQTT Data
        id: z2m-extract
        run: |
          echo "ðŸ”— Fetching Zigbee2MQTT tuya.ts..."

          curl -sL https://raw.githubusercontent.com/Koenkk/zigbee-herdsman-converters/master/src/devices/tuya.ts \
            -o /tmp/tuya.ts

          # Extract manufacturer IDs
          grep -oE '_TZ[E0-9]{1,4}_[a-z0-9]+' /tmp/tuya.ts | \
            tr '[:upper:]' '[:lower:]' | \
            sort -u > /tmp/z2m_manufacturer_ids.txt

          Z2M_COUNT=$(wc -l < /tmp/z2m_manufacturer_ids.txt)
          echo "z2m_count=$Z2M_COUNT" >> $GITHUB_OUTPUT
          echo "   Found $Z2M_COUNT manufacturer IDs from Z2M"

          # Extract datapoint mappings
          echo "ðŸ“Š Extracting datapoint mappings..."
          grep -oE '\[([0-9]+),\s*'"'"'(\w+)'"'" /tmp/tuya.ts | \
            sed "s/\[//g; s/,.*'/ -> /g; s/'//g" | \
            sort -u > /tmp/z2m_datapoints.txt

          DP_COUNT=$(wc -l < /tmp/z2m_datapoints.txt)
          echo "   Found $DP_COUNT datapoint mappings"

      - name: ðŸ”— Fetch ZHA Data
        id: zha-extract
        run: |
          echo "ðŸ”— Fetching ZHA quirks..."

          # Get ZHA tuya quirks index
          curl -sL https://api.github.com/repos/zigpy/zha-device-handlers/contents/zhaquirks/tuya \
            -H "Accept: application/vnd.github.v3+json" | \
            jq -r '.[].download_url' | head -20 > /tmp/zha_files.txt

          # Download and extract from each file
          > /tmp/zha_manufacturer_ids.txt
          while read url; do
            if [ -n "$url" ] && [ "$url" != "null" ]; then
              curl -sL "$url" | grep -oE '_TZ[E0-9]{1,4}_[a-z0-9]+' >> /tmp/zha_manufacturer_ids.txt 2>/dev/null || true
            fi
          done < /tmp/zha_files.txt

          cat /tmp/zha_manufacturer_ids.txt | tr '[:upper:]' '[:lower:]' | sort -u > /tmp/zha_unique.txt
          mv /tmp/zha_unique.txt /tmp/zha_manufacturer_ids.txt

          ZHA_COUNT=$(wc -l < /tmp/zha_manufacturer_ids.txt)
          echo "zha_count=$ZHA_COUNT" >> $GITHUB_OUTPUT
          echo "   Found $ZHA_COUNT manufacturer IDs from ZHA"

      - name: ðŸ”— Fetch JohanBendz Data
        id: johan-extract
        run: |
          echo "ðŸ”— Fetching JohanBendz PRs and Issues..."

          # Fetch all PRs (paginated)
          > /tmp/johan_data.txt
          for page in 1 2 3 4 5; do
            curl -sL "https://api.github.com/repos/JohanBendz/com.tuya.zigbee/issues?state=all&per_page=100&page=$page" \
              -H "Accept: application/vnd.github.v3+json" >> /tmp/johan_data.txt
          done

          # Extract manufacturer IDs
          grep -oE '_TZ[E0-9]{1,4}_[a-z0-9]+' /tmp/johan_data.txt | \
            tr '[:upper:]' '[:lower:]' | \
            sort -u > /tmp/johan_manufacturer_ids.txt

          JOHAN_COUNT=$(wc -l < /tmp/johan_manufacturer_ids.txt)
          echo "johan_count=$JOHAN_COUNT" >> $GITHUB_OUTPUT
          echo "   Found $JOHAN_COUNT manufacturer IDs from JohanBendz"

      - name: ðŸŒ Scrape Homey Forum
        if: ${{ inputs.scrape_forum != 'false' }}
        id: forum-scrape
        run: |
          echo "ðŸŒ Scraping Homey Forum posts..."

          # Note: Forum scraping requires proper handling of dynamic content
          # Using curl to get initial page content

          > /tmp/forum_manufacturer_ids.txt

          # Universal Tuya Zigbee post
          echo "   Fetching Ultimate post..."
          curl -sL "https://community.homey.app/t/app-pro-universal-tuya-zigbee/93498.json" \
            -H "Accept: application/json" 2>/dev/null | \
            grep -oE '_TZ[E0-9]{1,4}_[a-z0-9]+' >> /tmp/forum_manufacturer_ids.txt || true

          # Johan's post
          echo "   Fetching Johan's post..."
          curl -sL "https://community.homey.app/t/app-tuya-zigbee/20549.json" \
            -H "Accept: application/json" 2>/dev/null | \
            grep -oE '_TZ[E0-9]{1,4}_[a-z0-9]+' >> /tmp/forum_manufacturer_ids.txt || true

          cat /tmp/forum_manufacturer_ids.txt | tr '[:upper:]' '[:lower:]' | sort -u > /tmp/forum_unique.txt
          mv /tmp/forum_unique.txt /tmp/forum_manufacturer_ids.txt

          FORUM_COUNT=$(wc -l < /tmp/forum_manufacturer_ids.txt)
          echo "forum_count=$FORUM_COUNT" >> $GITHUB_OUTPUT
          echo "   Found $FORUM_COUNT manufacturer IDs from forum"

      - name: ðŸŒ Fetch Blakadder Database
        id: blakadder-extract
        run: |
          echo "ðŸŒ Fetching Blakadder Zigbee Database..."

          # Fetch Blakadder device pages
          > /tmp/blakadder_manufacturer_ids.txt

          # Main Tuya page
          curl -sL "https://zigbee.blakadder.com/tuya.html" 2>/dev/null | \
            grep -oE '_TZ[E0-9]{1,4}_[a-z0-9]+' >> /tmp/blakadder_manufacturer_ids.txt || true

          # Zigbee2MQTT devices page
          curl -sL "https://zigbee.blakadder.com/zigbee2mqtt.html" 2>/dev/null | \
            grep -oE '_TZ[E0-9]{1,4}_[a-z0-9]+' >> /tmp/blakadder_manufacturer_ids.txt || true

          # Also fetch TS* model IDs
          curl -sL "https://zigbee.blakadder.com/" 2>/dev/null | \
            grep -oE 'TS0[0-9]{3}[A-Z]?' >> /tmp/blakadder_manufacturer_ids.txt || true

          cat /tmp/blakadder_manufacturer_ids.txt | tr '[:upper:]' '[:lower:]' | sort -u > /tmp/blakadder_unique.txt
          mv /tmp/blakadder_unique.txt /tmp/blakadder_manufacturer_ids.txt

          BLAKADDER_COUNT=$(wc -l < /tmp/blakadder_manufacturer_ids.txt)
          echo "blakadder_count=$BLAKADDER_COUNT" >> $GITHUB_OUTPUT
          echo "   Found $BLAKADDER_COUNT IDs from Blakadder"

      - name: ðŸ”— Fetch deCONZ Data
        id: deconz-extract
        run: |
          echo "ðŸ”— Fetching deCONZ device definitions..."

          > /tmp/deconz_manufacturer_ids.txt

          # Get deCONZ Tuya DDF files
          curl -sL "https://api.github.com/repos/dresden-elektronik/deconz-rest-plugin/contents/devices/tuya" \
            -H "Accept: application/vnd.github.v3+json" 2>/dev/null | \
            jq -r '.[].download_url' 2>/dev/null | head -30 > /tmp/deconz_files.txt || true

          while read url; do
            if [ -n "$url" ] && [ "$url" != "null" ]; then
              curl -sL "$url" 2>/dev/null | grep -oE '_TZ[E0-9]{1,4}_[a-z0-9]+' >> /tmp/deconz_manufacturer_ids.txt || true
            fi
          done < /tmp/deconz_files.txt

          cat /tmp/deconz_manufacturer_ids.txt | tr '[:upper:]' '[:lower:]' | sort -u > /tmp/deconz_unique.txt
          mv /tmp/deconz_unique.txt /tmp/deconz_manufacturer_ids.txt

          DECONZ_COUNT=$(wc -l < /tmp/deconz_manufacturer_ids.txt)
          echo "deconz_count=$DECONZ_COUNT" >> $GITHUB_OUTPUT
          echo "   Found $DECONZ_COUNT IDs from deCONZ"

      - name: ðŸ”€ Merge All Sources
        id: merge
        run: |
          echo "ðŸ”€ Merging all sources..."

          # Merge all manufacturer IDs
          cat /tmp/*_manufacturer_ids.txt | \
            tr '[:upper:]' '[:lower:]' | \
            sort -u > /tmp/all_manufacturer_ids.txt

          TOTAL_COUNT=$(wc -l < /tmp/all_manufacturer_ids.txt)
          echo "total_count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
          echo "   Total unique manufacturer IDs: $TOTAL_COUNT"

          # Get existing IDs from drivers
          grep -rhE '_TZ[E0-9]{1,4}_[a-z0-9]+' drivers/*/driver.compose.json 2>/dev/null | \
            tr '[:upper:]' '[:lower:]' | \
            sort -u > /tmp/existing_manufacturer_ids.txt

          EXISTING_COUNT=$(wc -l < /tmp/existing_manufacturer_ids.txt)
          echo "existing_count=$EXISTING_COUNT" >> $GITHUB_OUTPUT
          echo "   Existing in drivers: $EXISTING_COUNT"

          # Find missing IDs
          comm -23 /tmp/all_manufacturer_ids.txt /tmp/existing_manufacturer_ids.txt > /tmp/missing_manufacturer_ids.txt

          MISSING_COUNT=$(wc -l < /tmp/missing_manufacturer_ids.txt)
          echo "missing_count=$MISSING_COUNT" >> $GITHUB_OUTPUT
          echo "   Missing from drivers: $MISSING_COUNT"

      - name: ðŸ“Š Generate Enrichment Report
        run: |
          echo "ðŸ“Š Generating enrichment report..."

          mkdir -p data/enrichment

          cat > data/enrichment/enrichment-report-$(date +%Y%m%d).json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "sources": {
              "git_history": ${{ steps.git-extract.outputs.git_count || 0 }},
              "zigbee2mqtt": ${{ steps.z2m-extract.outputs.z2m_count || 0 }},
              "zha": ${{ steps.zha-extract.outputs.zha_count || 0 }},
              "johanbendz": ${{ steps.johan-extract.outputs.johan_count || 0 }},
              "forum": ${{ steps.forum-scrape.outputs.forum_count || 0 }},
              "blakadder": ${{ steps.blakadder-extract.outputs.blakadder_count || 0 }},
              "deconz": ${{ steps.deconz-extract.outputs.deconz_count || 0 }}
            },
            "totals": {
              "all_discovered": ${{ steps.merge.outputs.total_count || 0 }},
              "existing_in_drivers": ${{ steps.merge.outputs.existing_count || 0 }},
              "missing_from_drivers": ${{ steps.merge.outputs.missing_count || 0 }}
            },
            "missing_ids": $(cat /tmp/missing_manufacturer_ids.txt | jq -R . | jq -s .)
          }
          EOF

          echo "   Report saved to data/enrichment/"

      - name: ðŸ“ Update Driver Mapping Database
        if: ${{ inputs.update_drivers == 'true' }}
        run: |
          echo "ðŸ“ Updating driver-mapping-database.json..."

          # Read missing IDs and categorize
          node << 'SCRIPT'
          const fs = require('fs');

          // Read missing IDs
          const missing = fs.readFileSync('/tmp/missing_manufacturer_ids.txt', 'utf8')
            .trim().split('\n').filter(Boolean);

          console.log(`Processing ${missing.length} missing IDs...`);

          // Categorize by prefix pattern
          const categories = {
            climate: [],      // _TZE* with temp/humidity
            motion: [],       // _TZ3000 with motion patterns
            switch: [],       // _TZ3000 switches
            plug: [],         // Power plugs
            curtain: [],      // Curtain motors
            other: []
          };

          missing.forEach(id => {
            // Simple categorization based on known patterns
            if (id.includes('_tze2') || id.includes('_tze3')) {
              categories.climate.push(id);
            } else if (id.includes('_tz3000')) {
              categories.switch.push(id);
            } else {
              categories.other.push(id);
            }
          });

          console.log('Categories:');
          Object.entries(categories).forEach(([cat, ids]) => {
            console.log(`  ${cat}: ${ids.length}`);
          });

          // Save categorized IDs
          fs.writeFileSync('/tmp/categorized_ids.json', JSON.stringify(categories, null, 2));
          SCRIPT

      - name: ðŸ”§ Auto-Fix Driver Issues
        if: ${{ inputs.fix_and_enrich != 'false' }}
        run: |
          echo "ðŸ”§ Running auto-fix and enrich..."
          node scripts/enrichment/auto-fix-and-enrich.js || echo "Script not found, skipping"

      - name: ðŸ“Š Enrich with DP Mappings
        if: ${{ inputs.enrich_dps != 'false' }}
        run: |
          echo "ðŸ“Š Running DP enrichment..."
          node scripts/enrichment/enrich-from-z2m-detailed.js || echo "Script not found, skipping"

      - name: ðŸ”„ Run All Enrichment Scripts
        run: |
          echo "ðŸ”„ Running complete enrichment pipeline..."

          # Parse Z2M for Tuya DPs
          node scripts/enrichment/parse-z2m-tuya-dps.js || echo "parse-z2m-tuya-dps skipped"

          # Fetch Blakadder devices
          node scripts/enrichment/fetch-blakadder-devices.js || echo "fetch-blakadder skipped"

          # Auto-discover new devices
          node scripts/enrichment/auto-discover-devices.js || echo "auto-discover skipped"

          # Enrich discovered devices
          node scripts/enrichment/enrich-new-devices.js || echo "enrich-new skipped"

          # Add to drivers
          node scripts/enrichment/add-to-drivers.js || echo "add-to-drivers skipped"

          # Parse Z2M (legacy)
          node scripts/enrichment/parse-z2m-tuya.js || echo "parse-z2m skipped"

          # Intelligent merge
          node scripts/enrichment/intelligent-merge.js --apply || echo "intelligent-merge skipped"

          # Fetch all sources
          node scripts/enrichment/fetch-all-sources.js || echo "fetch-all-sources skipped"

          # Merge all sources
          node scripts/enrichment/merge-all-sources.js --apply || echo "merge-all-sources skipped"

          # Verify drivers
          node scripts/enrichment/verify-and-enrich-drivers.js || echo "verify skipped"

      - name: ðŸ’¾ Commit Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ§  Auto-enrichment: $(date +%Y-%m-%d) - ${{ steps.merge.outputs.missing_count || 0 }} new IDs discovered"
            git push
          fi

      - name: ðŸ“‹ Summary
        run: |
          echo "# ðŸ§  Intelligent Enrichment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Sources Analyzed" >> $GITHUB_STEP_SUMMARY
          echo "| Source | IDs Found |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Git History | ${{ steps.git-extract.outputs.git_count || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Zigbee2MQTT | ${{ steps.z2m-extract.outputs.z2m_count || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ZHA | ${{ steps.zha-extract.outputs.zha_count || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| JohanBendz | ${{ steps.johan-extract.outputs.johan_count || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Homey Forum | ${{ steps.forum-scrape.outputs.forum_count || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Blakadder | ${{ steps.blakadder-extract.outputs.blakadder_count || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| deCONZ | ${{ steps.deconz-extract.outputs.deconz_count || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Discovered:** ${{ steps.merge.outputs.total_count || 0 }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Already in Drivers:** ${{ steps.merge.outputs.existing_count || 0 }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Missing from Drivers:** ${{ steps.merge.outputs.missing_count || 0 }}" >> $GITHUB_STEP_SUMMARY
