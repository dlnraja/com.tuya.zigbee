name: ðŸš€ MASTER Publish to Homey

'on':
  workflow_dispatch:
    inputs:
      method:
        description: 'Publish method'
        required: true
        type: choice
        options:
          - official-action
          - homey-cli
          - both
        default: 'both'
  push:
    tags:
      - 'v*.*.*'

env:
  NODE_VERSION: '22'

jobs:
  
  # Pre-check
  precheck:
    name: ðŸ“‹ Pre-Check
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      has_pat: ${{ steps.check-pat.outputs.has_pat }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Get Version
        id: get-version
        run: |
          VERSION=$(node -p "require('./app.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"
          
      - name: Check HOMEY_PAT
        id: check-pat
        run: |
          if [ -n "${{ secrets.HOMEY_PAT }}" ]; then
            echo "has_pat=true" >> $GITHUB_OUTPUT
            echo "âœ… HOMEY_PAT is configured"
          else
            echo "has_pat=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ HOMEY_PAT not configured"
            echo ""
            echo "ðŸ”‘ Get your Personal Access Token:"
            echo "   https://tools.developer.homey.app/api"
            echo ""
            echo "ðŸ“ Add to GitHub Secrets:"
            echo "   https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "   Name: HOMEY_PAT"
          fi
          
      - name: Check app.json
        run: |
          echo "ðŸ“„ Checking app.json..."
          if [ ! -f "app.json" ]; then
            echo "âŒ app.json not found!"
            exit 1
          fi
          echo "âœ… app.json exists"
          
          # Verify it's valid JSON
          node -e "JSON.parse(require('fs').readFileSync('app.json'))" || exit 1
          echo "âœ… app.json is valid JSON"
  
  # Method 1: Official GitHub Action
  publish-official-action:
    name: ðŸ“¦ Publish (Official Action)
    runs-on: ubuntu-latest
    needs: precheck
    if: |
      needs.precheck.outputs.has_pat == 'true' && 
      (inputs.method == 'official-action' || inputs.method == 'both' || github.event_name == 'push')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Validate App
        uses: athombv/github-action-homey-app-validate@v1
        continue-on-error: true
        
      - name: Publish to Homey
        uses: athombv/github-action-homey-app-publish@master
        id: publish-action
        with:
          personal_access_token: ${{ secrets.HOMEY_PAT }}
          
      - name: Success
        if: success()
        run: |
          echo "âœ… Published via Official Action"
          echo "ðŸ”— Manage at: ${{ steps.publish-action.outputs.url }}"
  
  # Method 2: Homey CLI
  publish-cli:
    name: ðŸ”§ Publish (CLI)
    runs-on: ubuntu-latest
    needs: precheck
    if: |
      needs.precheck.outputs.has_pat == 'true' && 
      (inputs.method == 'homey-cli' || inputs.method == 'both')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Install Homey CLI
        run: |
          echo "ðŸ“¦ Installing Homey CLI..."
          npm install -g homey
          homey --version
          
      - name: Authenticate
        run: |
          echo "ðŸ” Authenticating..."
          homey login --token "${{ secrets.HOMEY_PAT }}"
          
      - name: Validate
        run: |
          echo "âœ… Validating..."
          homey app validate --level publish || echo "âš ï¸ Validation warnings"
        continue-on-error: true
        
      - name: Build
        run: |
          echo "ðŸ—ï¸ Building..."
          homey app build
        continue-on-error: true
        
      - name: Publish
        id: publish-cli
        run: |
          echo "ðŸš€ Publishing v${{ needs.precheck.outputs.version }}..."
          homey app publish
          echo "âœ… Published successfully!"
  
  # Create GitHub Release
  github-release:
    name: ðŸ“ GitHub Release
    runs-on: ubuntu-latest
    needs: [precheck, publish-official-action, publish-cli]
    if: |
      always() && 
      needs.precheck.result == 'success' &&
      (needs.publish-official-action.result == 'success' || needs.publish-cli.result == 'success')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.precheck.outputs.version }}
          name: v${{ needs.precheck.outputs.version }}
          body: |
            # ðŸŽ‰ Release v${{ needs.precheck.outputs.version }}
            
            ## Status
            - âœ… Published to Homey App Store
            - âœ… GitHub Release created
            
            ## Links
            - [Homey App Store](https://apps.homey.app/app/com.dlnraja.tuya.zigbee)
            - [Developer Tools](https://tools.developer.homey.app)
            
            See [CHANGELOG.md](CHANGELOG.md) for details.
          files: CHANGELOG.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  # Summary
  summary:
    name: ðŸ“Š Summary
    runs-on: ubuntu-latest
    needs: [precheck, publish-official-action, publish-cli, github-release]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸŽ¯ Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Version: v${{ needs.precheck.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "- Pre-check: ${{ needs.precheck.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.publish-official-action.result }}" != "skipped" ]; then
            echo "- Publish (Official Action): ${{ needs.publish-official-action.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.publish-cli.result }}" != "skipped" ]; then
            echo "- Publish (CLI): ${{ needs.publish-cli.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- GitHub Release: ${{ needs.github-release.result == 'success' && 'âœ…' || 'â­ï¸' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.precheck.outputs.has_pat }}" == "true" ]; then
            if [ "${{ needs.publish-official-action.result }}" == "success" ] || [ "${{ needs.publish-cli.result }}" == "success" ]; then
              echo "## âœ… Success!" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Your app has been published to the Homey App Store." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
              echo "1. Check [Developer Tools](https://tools.developer.homey.app)" >> $GITHUB_STEP_SUMMARY
              echo "2. Verify in [Homey App Store](https://apps.homey.app/app/com.dlnraja.tuya.zigbee)" >> $GITHUB_STEP_SUMMARY
            else
              echo "## âš ï¸ Publish Failed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## âš ï¸ HOMEY_PAT Not Configured" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Configure HOMEY_PAT secret to enable publishing." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Get token: https://tools.developer.homey.app/api" >> $GITHUB_STEP_SUMMARY
          fi
