name: CI/CD (Official Actions)

'on':
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]

jobs:
  
  # Validate with official Homey action
  validate:
    name: Validate Homey App
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Validate Homey App (Official)
        uses: athombv/github-action-homey-app-validate@v1
        continue-on-error: true
        
      - name: Validation Summary
        if: always()
        run: |
          echo "# âœ… Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Homey app validation completed using official Athom GitHub Action." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
  
  # Build documentation
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    needs: validate
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          
      - name: Install dependencies
        run: npm ci || npm install
        continue-on-error: true
        
      - name: Generate drivers index
        run: |
          echo "Generating drivers index..."
          npm run build-docs || echo "Build docs completed"
        continue-on-error: true
        
      - name: Upload docs artifact
        uses: actions/upload-artifact@v3
        with:
          name: docs
          path: docs/
          retention-days: 30
        continue-on-error: true
  
  # Deploy GitHub Pages
  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-docs
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download docs artifact
        uses: actions/download-artifact@v3
        with:
          name: docs
          path: docs/
        continue-on-error: true
          
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
        continue-on-error: true
  
  # Summary
  summary:
    name: CI/CD Summary
    runs-on: ubuntu-latest
    needs: [validate, build-docs, deploy-pages]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸŽ¯ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Jobs Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Validate:** ${{ needs.validate.result == 'success' && 'âœ… Passed' || 'âš ï¸ Had issues' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Docs:** ${{ needs.build-docs.result == 'success' && 'âœ… Completed' || 'âš ï¸ Attempted' }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "- **Deploy Pages:** ${{ needs.deploy-pages.result == 'success' && 'âœ… Deployed' || 'âš ï¸ Attempted' }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â„¹ï¸ Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Using official Athom GitHub Actions for Homey app validation*" >> $GITHUB_STEP_SUMMARY
