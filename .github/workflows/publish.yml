name: ðŸš€ Homey App Publish

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'app.json'
      - '.homeycompose/**'
      - 'lib/**'
      - 'drivers/**'
      - 'assets/**'
  workflow_dispatch:
    inputs:
      force:
        description: "Force publish even if validation warnings"
        required: false
        type: boolean
        default: false
      skip_validation:
        description: "Skip Athom validation (known CLI bug workaround)"
        required: false
        type: boolean
        default: false

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  # Known issues tracked:
  # - Athom CLI validation bug with images (use continue-on-error)
  # - Settings keys: zb_model_id NOT zb_modelId
  # - Flow cards: NO titleFormatted with [[device]] in triggers

jobs:
  validate:
    name: ðŸ” Validate & Sync
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      version: ${{ steps.info.outputs.version }}
      name: ${{ steps.info.outputs.name }}
      id: ${{ steps.info.outputs.id }}
      changed: ${{ steps.sync.outputs.changed }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit || npm install

      - name: ðŸ”„ Full sync from .homeycompose
        id: sync
        run: |
          echo "ðŸ“¦ Regenerating app.json from .homeycompose..."
          npx homey app build 2>&1 | tail -5
          
          echo "ðŸ”„ Running sync script..."
          node scripts/maintenance/sync-app-json.js
          
          # Check for any changes
          if git diff --quiet app.json .homeycompose/ drivers/*/driver.compose.json 2>/dev/null; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âœ… No changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changes detected, will commit"
          fi

      - name: ðŸ“ Commit sync changes
        if: steps.sync.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add app.json .homeycompose/ drivers/*/driver.compose.json 2>/dev/null || true
          git commit -m "ðŸ”„ Auto-sync app.json and compose files [skip ci]" || true
          git push || true

      - name: ðŸ”¨ Build app
        run: npx homey app build

      - name: ðŸ“¦ Get App Info
        id: info
        run: |
          VERSION=$(node -p "require('./app.json').version")
          NAME=$(node -p "require('./app.json').name.en")
          ID=$(node -p "require('./app.json').id")
          DRIVERS=$(ls -d drivers/*/ 2>/dev/null | wc -l)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "id=$ID" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ $NAME v$VERSION ($ID) - $DRIVERS drivers"

      - name: ðŸ” Validate (Athom Official)
        id: validate
        uses: athombv/github-action-homey-app-validate@v1
        continue-on-error: true
        with:
          level: appstore

      - name: ï¿½ Code Quality Checks
        run: |
          echo "## ðŸ”§ Code Quality Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for wrong settings keys (common bug)
          WRONG_KEYS=$(grep -r "zb_modelId\|zb_manufacturerName" lib/ drivers/ --include="*.js" 2>/dev/null | wc -l || echo 0)
          if [ "$WRONG_KEYS" -gt 0 ]; then
            echo "âš ï¸ Found $WRONG_KEYS files with wrong settings keys (use zb_model_id, zb_manufacturer_name)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Settings keys correct" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for titleFormatted with [[device]] bug
          TITLE_BUG=$(grep -r "titleFormatted.*\[\[device\]\]" drivers/ --include="*.json" 2>/dev/null | wc -l || echo 0)
          if [ "$TITLE_BUG" -gt 0 ]; then
            echo "âš ï¸ Found $TITLE_BUG flow cards with titleFormatted [[device]] bug" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Flow cards OK" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for TuyaZigbeeDriver wrong import
          WRONG_IMPORT=$(grep -r "require.*TuyaZigbeeDriver" drivers/ --include="*.js" 2>/dev/null | wc -l || echo 0)
          if [ "$WRONG_IMPORT" -gt 0 ]; then
            echo "âš ï¸ Found $WRONG_IMPORT files with wrong TuyaZigbeeDriver import" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Imports OK" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ï¿½ðŸ“Š Validation Summary
        run: |
          echo "## ðŸ” Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| App | ${{ steps.info.outputs.name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.info.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Drivers | $(ls -d drivers/*/ | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| Sync Changes | ${{ steps.sync.outputs.changed }} |" >> $GITHUB_STEP_SUMMARY

  publish:
    name: ðŸš€ Publish
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 15
    if: needs.validate.result == 'success'
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit || npm install

      - name: ï¿½ Pre-build with image fix
        run: |
          # Build app first
          npx homey app build
          # Fix large.png files (CLI bug workaround)
          for driver in drivers/*/; do
            dn=$(basename "$driver")
            if [ -f "drivers/${dn}/assets/images/large.png" ]; then
              mkdir -p ".homeybuild/drivers/${dn}/assets/images/"
              cp "drivers/${dn}/assets/images/large.png" ".homeybuild/drivers/${dn}/assets/images/"
            fi
          done
          [ -f "assets/images/large.png" ] && mkdir -p ".homeybuild/assets/images/" && cp "assets/images/large.png" ".homeybuild/assets/images/"
          cp ".homeychangelog.json" ".homeybuild/" 2>/dev/null || true

      - name: ï¿½ðŸ” Validate App (Official Athom Action)
        uses: athombv/github-action-homey-app-validate@master
        with:
          level: publish

      - name: ðŸš€ Publish to Homey App Store (Official Athom Action)
        id: publish
        uses: athombv/github-action-homey-app-publish@master
        with:
          personal_access_token: ${{ secrets.HOMEY_PAT }}

      - name: âœ… Summary
        run: |
          echo "## ðŸŽ‰ ${{ needs.validate.outputs.name }} v${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Published to Homey App Store!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [Manage Build](${{ steps.publish.outputs.url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Details" >> $GITHUB_STEP_SUMMARY
          echo "- **App ID**: ${{ needs.validate.outputs.id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Drivers**: $(ls -d drivers/*/ | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the uploaded version" >> $GITHUB_STEP_SUMMARY
          echo "2. Submit for Test or Live certification" >> $GITHUB_STEP_SUMMARY
