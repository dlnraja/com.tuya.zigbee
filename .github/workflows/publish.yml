name: Homey App Publish

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  publish:
    name: Publish to Homey App Store
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ðŸ“š Install dependencies
        run: npm ci
        
      - name: ðŸ”§ Install Homey CLI
        run: npm install -g homey
        
      - name: âœ… Validate app
        run: homey app validate --level publish
        
      - name: ðŸ”¨ Build app
        run: homey app build
        
      - name: ðŸš€ Publish to Homey App Store
        if: github.event_name == 'release'
        env:
          HOMEY_TOKEN: ${{ secrets.HOMEY_TOKEN }}
        run: |
          echo "ðŸ“¦ Publishing to Homey App Store..."
          echo $HOMEY_TOKEN > ~/.athom-cli-token
          homey app publish --changelog "CRITICAL FIX - Correct TuyaManufacturerCluster import path. Fixes app crash on startup for all users."
          echo "âœ… Published successfully!"
          
      - name: ðŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: homey-app-build
          path: |
            ./build/
            *.tar.gz
          retention-days: 90
