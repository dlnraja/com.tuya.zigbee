name: ðŸ¤– INTELLIGENT WEEKLY AUTOMATION + FORUM ANALYSIS
"on":
  schedule:
    - cron: 0 3 1 */3 *
  workflow_dispatch:
    inputs:
      component_type:
        description: Type de composants Ã  analyser
        required: false
        default: all
        type: choice
        options:
          - all
          - critical
          - forum_only
          - manufacturers_only
      force_publish:
        description: Forcer publication si changements
        required: false
        default: false
        type: boolean
env:
  NODE_VERSION: "20"
permissions:
  contents: write
  actions: read
jobs:
  intelligent-weekly-automation:
    name: ðŸ¤– Intelligent Weekly Automation
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      fail-fast: true
      matrix:
        node-version:
          - 20
    steps:
      - name: ðŸš€ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
      - name: ðŸ”§ Install Dependencies
        run: |
          npm ci --prefer-offline --no-audit
          npm list --depth=0
      - name: ðŸ¤– Run Forum Comprehensive Analysis
        id: forum_analysis
        if: inputs.component_type == 'all' || inputs.component_type == 'forum_only'
        run: |
          echo "ðŸ¤– Running comprehensive forum analysis..."
          if [ -f "scripts/community/forum-comprehensive-analyzer.js" ]; then
            node scripts/community/forum-comprehensive-analyzer.js || true
          fi

          if [ -f "project-data/FORUM_COMPREHENSIVE_ANALYSIS.json" ]; then
            echo "forum_completed=true" >> $GITHUB_OUTPUT
            echo "âœ… Forum analysis completed"
          else
            echo "forum_completed=false" >> $GITHUB_OUTPUT
          fi
      - name: ðŸ”§ Enforce ManufacturerNames Rules
        id: manufacturer_rules
        if: inputs.component_type == 'all' || inputs.component_type == 'manufacturers_only'
        run: |
          echo "ðŸ”§ Enforcing manufacturerNames deduplication rules..."
          if [ -f "scripts/validation/manufacturer-deduplication-enforcer.js" ]; then
            node scripts/validation/manufacturer-deduplication-enforcer.js || true
          fi

          if [ -f "project-data/MANUFACTURER_DEDUPLICATION_REPORT.json" ]; then
            echo "rules_enforced=true" >> $GITHUB_OUTPUT
            echo "âœ… ManufacturerNames rules enforced"
          else
            echo "rules_enforced=false" >> $GITHUB_OUTPUT
          fi
      - name: ðŸ” Global Validation with Memory Rules
        id: global_validation
        run: |
          echo "ðŸ” Running global validation with memory rules..."

          # Create comprehensive validation script
          cat > global-validation-with-memory-rules.js << 'EOF'
          const fs = require('fs');
          const path = require('path');

          console.log('ðŸ” GLOBAL VALIDATION WITH MEMORY RULES');

          const driversDir = path.join(process.cwd(), 'drivers');
          let issues = [];
          let fixes = [];

          // Memory Rule 1: ManufacturerNames uniqueness
          console.log('ðŸ“‹ Rule 1: ManufacturerNames uniqueness...');
          const manufacturerMap = new Map();

          const drivers = fs.readdirSync(driversDir, { withFileTypes: true })
            .filter(dirent => dirent.isDirectory())
            .map(dirent => dirent.name);

          for (const driverName of drivers) {
            const composePath = path.join(driversDir, driverName, 'driver.compose.json');
            if (fs.existsSync(composePath)) {
              try {
                const compose = JSON.parse(fs.readFileSync(composePath, 'utf8'));
                const manufacturerNames = compose.zigbee?.manufacturerName || [];
                const productIds = compose.zigbee?.productId || [];

                for (const manufacturerId of manufacturerNames) {
                  if (!manufacturerMap.has(manufacturerId)) {
                    manufacturerMap.set(manufacturerId, []);
                  }
                  manufacturerMap.get(manufacturerId).push({
                    driver: driverName,
                    productIds: productIds
                  });
                }
              } catch (error) {
                console.log(`âŒ Error reading ${composePath}: ${error.message}`);
              }
            }
          }

          // Check duplications
          let duplications = 0;
          for (const [manufacturerId, entries] of manufacturerMap.entries()) {
            if (entries.length > 1) {
              const allProductIds = entries.flatMap(e => e.productIds);
              const uniqueProductIds = new Set(allProductIds);

              if (uniqueProductIds.size <= 1) {
                duplications++;
                issues.push(`ManufacturerId ${manufacturerId} duplicated in: ${entries.map(e => e.driver).join(', ')}`);
              }
            }
          }

          // Memory Rule 2: Critical forum issues resolved
          console.log('ðŸ“‹ Rule 2: Critical forum issues...');
          const criticalIssues = [
            { manufacturerId: '_TZE204_chbyv06', expectedDriver: 'gas_detector', issue: 'Forum #640' },
            { productId: 'TS0041', expectedDriver: 'switch_1gang', issue: 'Forum #642' }
          ];

          for (const critical of criticalIssues) {
            if (critical.manufacturerId) {
              const entries = manufacturerMap.get(critical.manufacturerId);
              if (!entries || !entries.some(e => e.driver === critical.expectedDriver)) {
                issues.push(`${critical.issue}: ${critical.manufacturerId} not in ${critical.expectedDriver}`);
              } else {
                console.log(`âœ… ${critical.issue}: ${critical.manufacturerId} correctly in ${critical.expectedDriver}`);
              }
            }

            if (critical.productId) {
              const targetPath = path.join(driversDir, critical.expectedDriver, 'driver.compose.json');
              if (fs.existsSync(targetPath)) {
                const compose = JSON.parse(fs.readFileSync(targetPath, 'utf8'));
                const productIds = compose.zigbee?.productId || [];

                if (productIds.includes(critical.productId)) {
                  console.log(`âœ… ${critical.issue}: ${critical.productId} correctly in ${critical.expectedDriver}`);
                } else {
                  issues.push(`${critical.issue}: ${critical.productId} missing from ${critical.expectedDriver}`);
                }
              }
            }
          }

          // Memory Rule 3: Base classes structure
          console.log('ðŸ“‹ Rule 3: Base classes structure...');
          const expectedBaseClasses = [
            'lib/devices/HybridSensorBase.js',
            'lib/devices/HybridPlugBase.js',
            'lib/devices/HybridSwitchBase.js',
            'lib/devices/ButtonDevice.js'
          ];

          for (const baseClass of expectedBaseClasses) {
            if (!fs.existsSync(baseClass)) {
              issues.push(`Missing base class: ${baseClass}`);
            } else {
              console.log(`âœ… Base class exists: ${baseClass}`);
            }
          }

          // Summary
          console.log('\nðŸ“Š VALIDATION SUMMARY:');
          console.log(`- Drivers scanned: ${drivers.length}`);
          console.log(`- ManufacturerIds found: ${manufacturerMap.size}`);
          console.log(`- Duplications: ${duplications}`);
          console.log(`- Issues found: ${issues.length}`);

          if (issues.length === 0) {
            console.log('âœ… ALL MEMORY RULES VALIDATED SUCCESSFULLY!');
            process.exit(0);
          } else {
            console.log('âŒ ISSUES FOUND:');
            issues.forEach(issue => console.log(`  - ${issue}`));
            process.exit(1);
          }
          EOF

          node global-validation-with-memory-rules.js
          echo "validation_passed=true" >> $GITHUB_OUTPUT
      - name: ðŸ“Š Check for Changes
        id: check_changes
        run: |
          if git diff --quiet --exit-code drivers/; then
            echo "No changes in drivers"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in drivers"
            echo "has_changes=true" >> $GITHUB_OUTPUT

            echo "ðŸ” Changes detected:"
            git diff --name-only drivers/
            git diff --stat drivers/
          fi
      - name: ðŸ’¾ Commit Changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          git add -A
          git commit -m "ðŸ¤– Weekly automation: Forum analysis + ManufacturerNames rules

          - Applied comprehensive forum analysis and fixes
          - Enforced manufacturerNames deduplication rules (Memory Rules)
          - Resolved forum issues: TS0041 switch, _TZE204_chbyv06 gas sensor
          - Global validation with memory rules passed

          Generated by: intelligent-weekly-automation.yml"
      - name: ðŸš€ Push Changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git push origin HEAD
          echo "âœ… Changes pushed to repository"
      - name: ðŸš€ Trigger Homey Publish
        if: steps.check_changes.outputs.has_changes == 'true' || inputs.force_publish == true
        run: |
          echo "ðŸš€ Triggering Homey app publication..."

          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/homey-publish.yml/dispatches \
            -d '{"ref":"main"}'

          echo "âœ… Homey publish workflow triggered"
      - name: ðŸ“¤ Upload Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: weekly-automation-reports
          path: |
            project-data/FORUM_COMPREHENSIVE_ANALYSIS.json
            project-data/MANUFACTURER_DEDUPLICATION_REPORT.json
          retention-days: 30
      - name: ðŸ“Š Weekly Automation Summary
        if: always()
        run: >
          echo "## ðŸ¤– Intelligent Weekly Automation Results" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY

          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          echo "| Forum Analysis | ${{ steps.forum_analysis.outputs.forum_completed == 'true' && 'âœ…
          Completed' || 'âšª Skipped' }} |" >> $GITHUB_STEP_SUMMARY

          echo "| Manufacturer Rules | ${{ steps.manufacturer_rules.outputs.rules_enforced == 'true'
          && 'âœ… Enforced' || 'âšª Skipped' }} |" >> $GITHUB_STEP_SUMMARY

          echo "| Global Validation | ${{ steps.global_validation.outputs.validation_passed ==
          'true' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY

          echo "| Changes Detected | ${{ steps.check_changes.outputs.has_changes == 'true' && 'âœ…
          Yes' || 'âšª None' }} |" >> $GITHUB_STEP_SUMMARY

          echo "| Homey Publish | ${{ (steps.check_changes.outputs.has_changes == 'true' ||
          inputs.force_publish == true) && 'ðŸš€ Triggered' || 'âšª Skipped' }} |" >>
          $GITHUB_STEP_SUMMARY
