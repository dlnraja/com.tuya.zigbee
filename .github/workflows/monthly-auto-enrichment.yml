name: Monthly Auto-Enrichment

on:
  schedule:
    # Run on the 1st of every month at 2 AM UTC
    - cron: '0 2 1 * *'
  workflow_dispatch:
    inputs:
      enrichment_type:
        description: 'Type of enrichment to run'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'manufacturers'
          - 'dps'
          - 'images'
          - 'capabilities'

jobs:
  monthly-enrichment:
    name: Monthly Auto-Enrichment
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: 📦 Install Dependencies
        run: |
          echo "📦 Installing dependencies..."
          npm install --save-dev homey canvas
          npm install --ignore-scripts
          echo "✅ Dependencies installed"
      
      - name: 🧹 Clean Cache
        run: |
          echo "🧹 Cleaning caches..."
          rm -rf .homeybuild .homeycompose node_modules/.cache || true
          echo "✅ Cache cleaned"
      
      - name: 🔍 Analyze Current State
        id: analyze
        run: |
          echo "🔍 Analyzing current project state..."
          
          # Count drivers
          DRIVERS_COUNT=$(find drivers -maxdepth 1 -mindepth 1 -type d 2>/dev/null | wc -l)
          echo "drivers_count=$DRIVERS_COUNT" >> $GITHUB_OUTPUT
          
          # Check app.json version
          VERSION=$(jq -r '.version' app.json)
          echo "current_version=$VERSION" >> $GITHUB_OUTPUT
          
          # Check reports
          if [ -d "reports" ]; then
            REPORTS_COUNT=$(find reports -name "*.json" | wc -l)
            echo "reports_count=$REPORTS_COUNT" >> $GITHUB_OUTPUT
          fi
          
          echo "📊 Current state:"
          echo "  - Drivers: $DRIVERS_COUNT"
          echo "  - Version: $VERSION"
          echo "  - Reports: $REPORTS_COUNT"
      
      - name: 🔄 Scrape Latest DPs from Zigbee2MQTT
        if: github.event.inputs.enrichment_type == 'all' || github.event.inputs.enrichment_type == 'dps' || github.event_name == 'schedule'
        run: |
          echo "🔄 Scraping latest Tuya DPs..."
          
          if [ -f "scripts/enrichment/DEEP_DPS_SCRAPER.js" ]; then
            node scripts/enrichment/DEEP_DPS_SCRAPER.js || echo "⚠️ DPs scraper had warnings"
            echo "✅ DPs database updated"
          else
            echo "⚠️ DPs scraper not found, skipping"
          fi
      
      - name: 🏭 Enrich Manufacturer IDs
        if: github.event.inputs.enrichment_type == 'all' || github.event.inputs.enrichment_type == 'manufacturers' || github.event_name == 'schedule'
        run: |
          echo "🏭 Enriching manufacturer IDs..."
          
          if [ -f "scripts/analysis/ENRICH_ALL_MANUFACTURERS.js" ]; then
            node scripts/analysis/ENRICH_ALL_MANUFACTURERS.js || echo "⚠️ Manufacturer enrichment had warnings"
            echo "✅ Manufacturers enriched"
          else
            echo "⚠️ Manufacturer enrichment script not found, skipping"
          fi
      
      - name: 🎨 Update Images if Needed
        if: github.event.inputs.enrichment_type == 'all' || github.event.inputs.enrichment_type == 'images' || github.event_name == 'schedule'
        run: |
          echo "🎨 Checking for missing images..."
          
          MISSING_IMAGES=0
          for driver_dir in drivers/*/; do
            driver_name=$(basename "$driver_dir")
            
            if [ ! -f "${driver_dir}assets/small.png" ] || [ ! -f "${driver_dir}assets/large.png" ]; then
              echo "⚠️ Missing images for: $driver_name"
              MISSING_IMAGES=$((MISSING_IMAGES + 1))
            fi
          done
          
          if [ $MISSING_IMAGES -gt 0 ]; then
            echo "Found $MISSING_IMAGES drivers with missing images"
            
            if [ -f "scripts/generation/GENERATE_MISSING_ICONS.js" ]; then
              node scripts/generation/GENERATE_MISSING_ICONS.js || echo "⚠️ Image generation had warnings"
              echo "✅ Missing images generated"
            fi
          else
            echo "✅ All drivers have images"
          fi
      
      - name: 🚀 Enrich Capabilities
        if: github.event.inputs.enrichment_type == 'all' || github.event.inputs.enrichment_type == 'capabilities' || github.event_name == 'schedule'
        run: |
          echo "🚀 Enriching capabilities..."
          
          if [ -f "scripts/fixes/AUTO_ENRICH_ALL_CAPABILITIES.js" ]; then
            node scripts/fixes/AUTO_ENRICH_ALL_CAPABILITIES.js || echo "⚠️ Capability enrichment had warnings"
            echo "✅ Capabilities enriched"
          else
            echo "⚠️ Capability enrichment script not found, skipping"
          fi
      
      - name: 🔄 Apply Enhanced Features
        if: github.event.inputs.enrichment_type == 'all' || github.event_name == 'schedule'
        run: |
          echo "🔄 Applying enhanced features..."
          
          if [ -f "scripts/enrichment/APPLY_ENHANCED_FEATURES.js" ]; then
            node scripts/enrichment/APPLY_ENHANCED_FEATURES.js || echo "⚠️ Feature application had warnings"
            echo "✅ Enhanced features applied"
          else
            echo "⚠️ Enhanced features script not found, skipping"
          fi
      
      - name: 📝 Sync to app.json
        run: |
          echo "📝 Syncing drivers to app.json..."
          
          if [ -f "scripts/automation/AUTO_SYNC_DRIVERS_TO_APP_JSON.js" ]; then
            node scripts/automation/AUTO_SYNC_DRIVERS_TO_APP_JSON.js
            echo "✅ app.json synchronized"
          else
            echo "⚠️ Sync script not found, skipping"
          fi
      
      - name: ✅ Validate Changes
        run: |
          echo "✅ Validating app..."
          
          # Clean cache before validation
          rm -rf .homeybuild .homeycompose || true
          
          # Install homey CLI if not present
          npm install -g homey || true
          
          # Validate
          homey app validate --level publish || {
            echo "⚠️ Validation had warnings (non-blocking for monthly enrichment)"
          }
      
      - name: 📊 Generate Enrichment Report
        id: report
        run: |
          echo "📊 Generating enrichment report..."
          
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # Count changes
          CHANGED_FILES=$(git status --porcelain | wc -l)
          
          # Generate report content
          REPORT="## 🔄 Monthly Auto-Enrichment Report\n\n"
          REPORT="${REPORT}**Date:** $TIMESTAMP\n"
          REPORT="${REPORT}**Drivers:** ${{ steps.analyze.outputs.drivers_count }}\n"
          REPORT="${REPORT}**Changed Files:** $CHANGED_FILES\n\n"
          
          if [ $CHANGED_FILES -gt 0 ]; then
            REPORT="${REPORT}### Changes Made:\n"
            REPORT="${REPORT}\`\`\`\n$(git status --short)\n\`\`\`\n\n"
            REPORT="${REPORT}✅ Enrichment applied successfully"
          else
            REPORT="${REPORT}ℹ️ No changes needed - project is up to date"
          fi
          
          # Save report
          mkdir -p reports
          echo -e "$REPORT" > reports/MONTHLY_ENRICHMENT_$(date +%Y-%m).md
          
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "✅ Report generated"
      
      - name: 💾 Commit Changes
        if: steps.report.outputs.changed_files != '0'
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          TIMESTAMP=$(date -u +"%Y-%m-%d")
          
          git add -A
          git commit -m "chore: monthly auto-enrichment ($TIMESTAMP)
          
          Automated monthly enrichment completed:
          - Updated Tuya DPs database
          - Enriched manufacturer IDs
          - Updated capabilities
          - Applied enhanced features
          - Synchronized app.json
          
          Changed files: ${{ steps.report.outputs.changed_files }}
          
          [skip ci]"
          
          echo "✅ Changes committed"
      
      - name: 🚀 Push Changes
        if: steps.report.outputs.changed_files != '0'
        run: |
          # Pull with rebase first
          git pull --rebase origin master || true
          
          # Push
          git push origin HEAD:master || {
            echo "⚠️ Push failed, retrying..."
            git pull --rebase origin master
            git push origin HEAD:master
          }
          
          echo "✅ Changes pushed to master"
      
      - name: 📢 Create Summary
        if: always()
        run: |
          echo "## 🎉 Monthly Enrichment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Drivers:** ${{ steps.analyze.outputs.drivers_count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Changed Files:** ${{ steps.report.outputs.changed_files }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.report.outputs.changed_files }}" != "0" ]; then
            echo "✅ **Enrichment applied and pushed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ **No changes needed**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📋 Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review changes in latest commit" >> $GITHUB_STEP_SUMMARY
          echo "2. Monitor auto-publish workflow" >> $GITHUB_STEP_SUMMARY
          echo "3. Check [Actions](https://github.com/${{ github.repository }}/actions)" >> $GITHUB_STEP_SUMMARY
