name: ğŸ”„ Synchronisation Mensuelle tuya-light â† master

on:
  schedule:
    # ExÃ©cution le premier jour de chaque mois Ã  2h00 UTC
    - cron: '0 2 1 * *'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Forcer la synchronisation mÃªme si pas de changements'
        required: false
        default: false
        type: boolean

jobs:
  sync-tuya-light:
    runs-on: ubuntu-latest
    name: ğŸ”„ Synchronisation tuya-light â† master
    
    steps:
      - name: ğŸ“¥ Checkout du repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: npm ci
      
      - name: ğŸ” VÃ©rification de l'Ã©tat actuel
        run: |
          echo "=== Ã‰TAT ACTUEL ==="
          echo "Branch actuel: $(git branch --show-current)"
          echo "Drivers master: $(find drivers/tuya -name "*.js" -o -name "*.json" | grep -v node_modules | wc -l)"
          echo "Drivers tuya-light: $(git show origin/tuya-light:drivers/tuya | wc -l || echo '0')"
      
      - name: ğŸ”„ ExÃ©cution de la synchronisation
        run: npm run sync-tuya-light
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“Š VÃ©rification post-synchronisation
        run: |
          echo "=== VÃ‰RIFICATION POST-SYNC ==="
          git checkout tuya-light
          echo "Drivers tuya-light aprÃ¨s sync: $(find drivers/tuya -name "*.js" -o -name "*.json" | grep -v node_modules | wc -l)"
          git checkout master
      
      - name: ğŸ“ CrÃ©ation du rapport de synchronisation
        run: |
          echo "=== RAPPORT DE SYNCHRONISATION ==="
          echo "Date: $(date)"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Branch source: master"
          echo "Branch cible: tuya-light"
          echo "Mode: ${{ github.event_name == 'workflow_dispatch' && 'Manuel' || 'Automatique' }}"
      
      - name: ğŸ·ï¸ CrÃ©ation du tag de release
        if: success()
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
          TAG_NAME="tuya-light-sync-$TIMESTAMP"
          git tag $TAG_NAME
          git push origin $TAG_NAME
          echo "Tag crÃ©Ã©: $TAG_NAME"
      
      - name: ğŸ“¦ CrÃ©ation du ZIP de release
        if: success()
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
          ZIP_NAME="tuya-light-$TIMESTAMP.zip"
          
          # CrÃ©er le ZIP du projet
          git checkout tuya-light
          zip -r $ZIP_NAME . -x "node_modules/*" ".git/*" "*.log" "backups/*"
          
          # Uploader comme artifact
          echo "ZIP crÃ©Ã©: $ZIP_NAME"
      
      - name: ğŸ“¤ Upload des artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: tuya-light-release-${{ github.run_id }}
          path: |
            tuya-light-*.zip
            reports/sync-tuya-light-report-*.json
            logs/sync-tuya-light.log
          retention-days: 30
      
      - name: ğŸ”” Notification de succÃ¨s
        if: success()
        run: |
          echo "âœ… Synchronisation tuya-light â† master rÃ©ussie!"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ”„ Mode: ${{ github.event_name == 'workflow_dispatch' && 'Manuel' || 'Automatique' }}"
          echo "ğŸ“¦ Release: tuya-light-${{ github.run_id }}"
      
      - name: âš ï¸ Notification d'Ã©chec
        if: failure()
        run: |
          echo "âŒ Synchronisation tuya-light â† master Ã©chouÃ©e!"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ”„ Mode: ${{ github.event_name == 'workflow_dispatch' && 'Manuel' || 'Automatique' }}"
          echo "ğŸ” VÃ©rifier les logs pour plus de dÃ©tails"
      
      - name: ğŸ§¹ Nettoyage
        if: always()
        run: |
          echo "ğŸ§¹ Nettoyage des fichiers temporaires..."
          rm -f tuya-light-*.zip || true
          git checkout master