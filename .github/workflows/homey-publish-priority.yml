name: Homey App Publish - Priority (No Jekyll)

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  homey-publish:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Homey CLI
      run: |
        npm install -g @athombv/homey-cli
        homey --version
        echo "âœ… Homey CLI installed"
        
    - name: Clean environment
      run: |
        rm -rf .homeycompose node_modules docs/ public/ || true
        echo "ğŸ§¹ Cleaned Jekyll/Pages files that cause conflicts"
        
    - name: Validate App
      run: |
        echo "ğŸ” Validating Ultimate Zigbee Hub..."
        homey app validate
        echo "âœ… Validation passed - ready for App Store"
        
    - name: Auto-increment version
      run: |
        echo "ğŸ“ Version increment..."
        node -e "
        const fs = require('fs');
        const app = JSON.parse(fs.readFileSync('app.json', 'utf8'));
        const parts = app.version.split('.');
        parts[2] = String(parseInt(parts[2] || 0) + 1);
        app.version = parts.join('.');
        fs.writeFileSync('app.json', JSON.stringify(app, null, 2));
        console.log('âœ… New version:', app.version);
        "
        
    - name: Login to Homey (Corrected Auth)
      env:
        HOMEY_TOKEN: ${{ secrets.HOMEY_TOKEN }}
      run: |
        echo "ğŸ” Authenticating with Homey App Store..."
        if [ -z "$HOMEY_TOKEN" ]; then
          echo "âŒ HOMEY_TOKEN not configured in secrets!"
          echo "Please add your Homey token to repository secrets"
          exit 1
        fi
        echo "$HOMEY_TOKEN" | homey login
        echo "âœ… Authentication successful"
        
    - name: Publish to Homey App Store
      run: |
        echo "ğŸš€ Publishing Ultimate Zigbee Hub v2.1+ to Homey App Store..."
        homey app publish --changelog "ğŸ¯ v2.1+ Professional Edition - Homey Community corrections applied, SDK3 compliant, 164 drivers, UNBRANDED structure, comprehensive Zigbee device support"
        echo "ğŸ‰ Publication completed!"
        
    - name: Success Summary
      run: |
        echo "ğŸ† HOMEY APP PUBLICATION SUMMARY:"
        echo "âœ… App: Ultimate Zigbee Hub - Professional Edition"
        echo "âœ… Version: 2.1+ (auto-incremented)"
        echo "âœ… Drivers: 164 professional drivers"
        echo "âœ… Compliance: Full SDK3 + Homey guidelines"
        echo "âœ… Structure: UNBRANDED, organized by function"
        echo "ğŸ“± Dashboard: https://tools.developer.homey.app/apps/app/com.dlnraja.ultimate.zigbee.hub"
        echo "ğŸ¯ Community corrections successfully applied and published!"
