name: ğŸ” Security Scanner & Protection

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  schedule:
    - cron: '0 2 * * *'  # Tous les jours Ã  2h

jobs:
  security-scan:
    name: ğŸ›¡ï¸ Security Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ” Secret Detection with GitLeaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ” TruffleHog Secrets Scanner
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        
    - name: ğŸ›¡ï¸ Dependency Security Audit
      run: |
        npm audit --audit-level high
        npm audit fix --force
        
    - name: ğŸš¨ Remove Dangerous Files
      run: |
        echo "ğŸ” Recherche de fichiers dangereux..."
        find . -name "id_rsa*" -delete
        find . -name "*.pem" -delete
        find . -name "*.key" -path "*/test/*" -delete
        find . -name "*.p12" -delete
        find . -name ".env*" -path "*/node_modules/*" -delete
        echo "âœ… Nettoyage sÃ©curitÃ© terminÃ©"
        
    - name: ğŸ”’ Validate No Secrets in Commit
      run: |
        echo "ğŸ” VÃ©rification finale..."
        if grep -r "BEGIN.*PRIVATE KEY" . --exclude-dir=.git --exclude-dir=node_modules; then
          echo "âŒ ERREUR: ClÃ© privÃ©e dÃ©tectÃ©e!"
          exit 1
        fi
        echo "âœ… Aucun secret dÃ©tectÃ©"
        
    - name: ğŸ“Š Security Report
      if: always()
      run: |
        echo "ğŸ“Š RAPPORT SÃ‰CURITÃ‰ - $(date)"
        echo "âœ… Scan GitLeaks: TerminÃ©"
        echo "âœ… Scan TruffleHog: TerminÃ©" 
        echo "âœ… Audit dÃ©pendances: TerminÃ©"
        echo "âœ… Nettoyage fichiers: TerminÃ©"
        echo "ğŸ›¡ï¸ Niveau sÃ©curitÃ©: MAXIMAL"
