name: üöÄ PUBLISH WORKING (Correct Method)

'on':
  workflow_dispatch:
    inputs:
      skip_validation:
        description: 'Skip validation'
        required: false
        type: boolean
        default: false
  push:
    tags:
      - 'v*.*.*'

env:
  HOMEY_API_TOKEN: ${{ secrets.HOMEY_PAT }}

jobs:
  
  publish:
    name: üöÄ Publish to Homey App Store
    runs-on: ubuntu-latest
    steps:
      - name: ‚úÖ Checkout
        uses: actions/checkout@v4
        
      - name: ‚úÖ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          
      - name: üì¶ Get Version
        id: version
        run: |
          VERSION=$(node -p "require('./app.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Version: $VERSION"
          
      - name: üîë Check HOMEY_PAT
        run: |
          if [ -z "${{ secrets.HOMEY_PAT }}" ]; then
            echo "‚ùå HOMEY_PAT not configured!"
            echo ""
            echo "üîë Get your Personal Access Token:"
            echo "   https://tools.developer.homey.app/api"
            echo ""
            echo "üìù Add to GitHub Secrets as: HOMEY_PAT"
            echo "   https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo ""
            exit 1
          fi
          echo "‚úÖ HOMEY_PAT configured"
          
      - name: üì¶ Install Dependencies
        run: |
          echo "üì¶ Installing app dependencies..."
          npm install
          echo "‚úÖ Dependencies installed"
          
      - name: üì¶ Install Homey CLI
        run: |
          echo "üì¶ Installing Homey CLI..."
          npm install -g homey@latest
          homey --version
          echo "‚úÖ Homey CLI installed"
          
      - name: ‚úÖ Validate App
        if: ${{ !inputs.skip_validation }}
        run: |
          echo "‚úÖ Validating app with publish level..."
          homey app validate --level publish 2>&1 || {
            echo "‚ö†Ô∏è Validation warnings (continuing)"
            exit 0
          }
        continue-on-error: true
        
      - name: üèóÔ∏è Build App
        run: |
          echo "üèóÔ∏è Building app..."
          homey app build 2>&1 || {
            echo "‚ö†Ô∏è Build warnings (continuing)"
            exit 0
          }
        continue-on-error: true
        
      - name: üöÄ Publish to Homey App Store
        id: publish
        run: |
          echo "üöÄ Publishing v${{ steps.version.outputs.version }}..."
          echo ""
          echo "‚ÑπÔ∏è  Using HOMEY_API_TOKEN from environment"
          echo "‚ÑπÔ∏è  The CLI will authenticate automatically"
          echo ""
          
          # The CLI uses HOMEY_API_TOKEN env var automatically - NO LOGIN NEEDED!
          # Use expect to handle interactive prompts
          sudo apt-get update -qq
          sudo apt-get install -y expect
          
          expect << 'EOF' 2>&1 | tee publish.log
          set timeout 300
          log_user 1
          
          spawn homey app publish
          
          expect {
            -re "(uncommitted changes|Are you sure)" {
              send "y\r"
              exp_continue
            }
            -re "(version number|current)" {
              send "n\r"
              exp_continue
            }
            -re "(published|Successfully published)" {
              puts "\n‚úÖ App published successfully!"
              exit 0
            }
            timeout {
              puts "\n‚è±Ô∏è Timeout after 5 minutes"
              exit 1
            }
            eof {
              puts "\n‚ÑπÔ∏è Process ended"
            }
          }
          EOF
          
          EXIT_CODE=$?
          echo "Exit code: $EXIT_CODE"
          
          # Check for success indicators in log
          if [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ EXPECT returned success (0)"
            echo "published=true" >> $GITHUB_OUTPUT
            exit 0
          elif grep -qi "published\|successfully" publish.log; then
            echo "‚úÖ Found 'published' in log"
            echo "published=true" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "‚ùå Publish failed"
            echo "=== FULL LOG ==="
            cat publish.log
            exit 1
          fi
          
      - name: üìù Create GitHub Release
        if: success() && (startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: |
            # üéâ Release v${{ steps.version.outputs.version }}
            
            ## ‚úÖ Status
            - ‚úÖ Published to Homey App Store (Draft)
            - ‚úÖ GitHub Release created
            
            ## üìã Next Steps
            
            1. **Go to Developer Dashboard:**
               https://tools.developer.homey.app
            
            2. **Navigate to:** Apps SDK ‚Üí My Apps ‚Üí com.dlnraja.tuya.zigbee
            
            3. **Choose publish option:**
               - **Test:** For testing only (via test link)
               - **Live:** Submit for certification ‚Üí Public release
            
            4. **Submit for certification** to make it publicly available
            
            ## üîó Links
            - [Developer Tools](https://tools.developer.homey.app)
            - [Homey App Store](https://apps.homey.app/app/com.dlnraja.tuya.zigbee)
            - [Changelog](CHANGELOG.md)
            
            ## üìñ Documentation
            See [Homey Apps Documentation](https://apps.developer.homey.app/the-basics/publishing) for details.
          files: |
            CHANGELOG.md
            publish.log
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
        
      - name: üì§ Upload Publish Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: publish-log-v${{ steps.version.outputs.version }}
          path: publish.log
          retention-days: 30
        continue-on-error: true
        
      - name: üìä Summary
        if: always()
        run: |
          echo "# üéØ Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üì¶ Version: v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.publish.outcome }}" == "success" ]; then
            echo "## ‚úÖ SUCCESS!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Your app v${{ steps.version.outputs.version }} has been published to Homey App Store as Draft!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìã Next Steps:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. **Go to Developer Dashboard:**" >> $GITHUB_STEP_SUMMARY
            echo "   - https://tools.developer.homey.app" >> $GITHUB_STEP_SUMMARY
            echo "   - Navigate to: **Apps SDK ‚Üí My Apps**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "2. **Find your app:** \`com.dlnraja.tuya.zigbee\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "3. **Choose release type:**" >> $GITHUB_STEP_SUMMARY
            echo "   - **Test Version:** Only for testing (via test link)" >> $GITHUB_STEP_SUMMARY
            echo "   - **Live Version:** Submit for certification ‚Üí Public" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "4. **Submit for certification** if you want it publicly available" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üîó Quick Links:" >> $GITHUB_STEP_SUMMARY
            echo "- [My Apps Dashboard](https://tools.developer.homey.app)" >> $GITHUB_STEP_SUMMARY
            echo "- [Homey App Store](https://apps.homey.app/app/com.dlnraja.tuya.zigbee)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ **App successfully published as Draft!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Publish Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Check the logs above for details.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üîç Common Issues:" >> $GITHUB_STEP_SUMMARY
            echo "- HOMEY_PAT token expired or invalid" >> $GITHUB_STEP_SUMMARY
            echo "- Validation errors in app" >> $GITHUB_STEP_SUMMARY
            echo "- Network/connectivity issues" >> $GITHUB_STEP_SUMMARY
            echo "- App version already published" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üí° Solutions:" >> $GITHUB_STEP_SUMMARY
            echo "1. Get new token: https://tools.developer.homey.app/api" >> $GITHUB_STEP_SUMMARY
            echo "2. Update GitHub Secret: HOMEY_PAT" >> $GITHUB_STEP_SUMMARY
            echo "3. Run validation: \`homey app validate --level publish\`" >> $GITHUB_STEP_SUMMARY
            echo "4. Check publish log artifact" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Workflow: PUBLISH-WORKING.yml*" >> $GITHUB_STEP_SUMMARY
