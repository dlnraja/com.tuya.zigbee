name: Manual Homey Publish

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      changelog:
        description: 'Changelog message'
        required: false
        default: 'Fix: Settings infinite loop + homey-zigbeedriver dependency + 28 flow cards'

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Dependencies
      run: |
        echo "📦 Installing dependencies..."
        npm install --no-audit --no-fund
        
    - name: Install Homey CLI
      run: |
        echo "🔍 Installing Homey CLI..."
        npm install -g homey@latest --no-audit --no-fund
        homey --version
        
    - name: Check HOMEY_TOKEN
      env:
        HOMEY_TOKEN: ${{ secrets.HOMEY_TOKEN }}
      run: |
        if [ -z "$HOMEY_TOKEN" ]; then
          echo "⚠️  WARNING: HOMEY_TOKEN not configured"
          echo "ℹ️  Get token from: https://tools.developer.homey.app/"
          echo "ℹ️  Add it to: Settings → Secrets → Actions → HOMEY_TOKEN"
          echo ""
          echo "📝 Continuing without authentication (will use build only)..."
        else
          echo "✅ HOMEY_TOKEN is configured"
          mkdir -p ~/.homey
          echo "{\"token\":\"$HOMEY_TOKEN\"}" > ~/.homey/.homeyrc.json
          homey whoami || echo "Token validation skipped"
        fi
        
    - name: Build App
      run: |
        echo "🔨 Building app..."
        homey app build
        
    - name: Validate App
      run: |
        echo "✅ Validating at publish level..."
        homey app validate --level=publish
        
    - name: Get Current Version
      id: version
      run: |
        VERSION=$(node -p "require('./app.json').version")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "📊 Current version: $VERSION"
        
    - name: Publish Summary
      run: |
        echo "## 📊 Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ✅ Build & Validation Successful" >> $GITHUB_STEP_SUMMARY
        echo "**Current Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Requested Bump:** ${{ inputs.version_type }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -n "${{ secrets.HOMEY_TOKEN }}" ]; then
          echo "✅ HOMEY_TOKEN configured - Ready for automatic publish" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To publish, run locally:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "homey app publish" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️  HOMEY_TOKEN not configured" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To enable auto-publish:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Get token: https://tools.developer.homey.app/" >> $GITHUB_STEP_SUMMARY
          echo "2. Add secret: Settings → Secrets → Actions → HOMEY_TOKEN" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Or publish manually:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "git pull" >> $GITHUB_STEP_SUMMARY
          echo "homey app publish" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "🔗 [View App on Homey](https://tools.developer.homey.app/apps/app/com.dlnraja.tuya.zigbee)" >> $GITHUB_STEP_SUMMARY
