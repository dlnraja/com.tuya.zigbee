name: Force Publish (Official Actions)

'on':
  workflow_dispatch:
    inputs:
      skip_validation:
        description: 'Skip validation (force publish even with errors)'
        required: false
        type: boolean
        default: false

jobs:
  
  # Validate (optional)
  validate:
    name: Validate Homey App
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_validation }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Validate Homey App
        uses: athombv/github-action-homey-app-validate@v1
        continue-on-error: true
  
  # Force publish
  force-publish:
    name: Force Publish to Homey
    runs-on: ubuntu-latest
    needs: validate
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Check HOMEY_PAT
        run: |
          if [ -z "${{ secrets.HOMEY_PAT }}" ]; then
            echo "âš ï¸  HOMEY_PAT not configured!"
            echo ""
            echo "ðŸ”‘ Get your Personal Access Token at:"
            echo "   https://tools.developer.homey.app/me"
            echo ""
            echo "ðŸ“ Add it to GitHub Secrets:"
            echo "   Settings â†’ Secrets â†’ Actions â†’ New repository secret"
            echo "   Name: HOMEY_PAT"
            echo "   Value: (your personal access token)"
            echo ""
            exit 1
          fi
          echo "âœ… HOMEY_PAT configured"
          
      - name: Force Publish to Homey App Store
        uses: athombv/github-action-homey-app-publish@master
        id: publish
        with:
          personal_access_token: ${{ secrets.HOMEY_PAT }}
        continue-on-error: true
        
      - name: Create git tag (if needed)
        run: |
          VERSION=$(node -p "require('./app.json').version")
          echo "App version: $VERSION"
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Tag v$VERSION already exists"
          else
            echo "Creating tag v$VERSION"
            git tag -a "v$VERSION" -m "Force publish v$VERSION" || echo "Tag creation attempted"
            git push origin "v$VERSION" || echo "Tag push attempted"
          fi
        continue-on-error: true
        
      - name: Get Version
        id: get-version
        run: |
          VERSION=$(node -p "require('./app.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get-version.outputs.version }}
          name: Release v${{ steps.get-version.outputs.version }}
          body: |
            # Force Publish
            
            Published to Homey App Store using official Athom GitHub Actions.
            
            **Manage app:** ${{ steps.publish.outputs.url || 'Check Homey Developer Tools' }}
            
            ## Status
            - âœ… Force published
            - Validation: ${{ inputs.skip_validation && 'Skipped' || 'Attempted' }}
            
            See [CHANGELOG.md](CHANGELOG.md) for details.
          files: |
            CHANGELOG.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
  
  # Summary
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [validate, force-publish]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸš€ Force Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Validation:** ${{ inputs.skip_validation && 'â­ï¸ Skipped' || (needs.validate.result == 'success' && 'âœ… Passed' || 'âš ï¸ Had issues (continued)') }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Publish:** ${{ needs.force-publish.result == 'success' && 'âœ… Completed' || 'âš ï¸ Attempted' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.force-publish.result }}" == "success" ]; then
            echo "## âœ… Success!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your app has been published to the Homey App Store." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Check [Homey Developer Tools](https://tools.developer.homey.app)" >> $GITHUB_STEP_SUMMARY
            echo "2. Verify your app in the [Homey App Store](https://apps.homey.app/app/com.dlnraja.tuya.zigbee)" >> $GITHUB_STEP_SUMMARY
            echo "3. Test the published version" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ Issues Encountered" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The force publish encountered issues. Check the logs above." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Common issues:**" >> $GITHUB_STEP_SUMMARY
            echo "- HOMEY_PAT not configured or invalid" >> $GITHUB_STEP_SUMMARY
            echo "- App validation errors" >> $GITHUB_STEP_SUMMARY
            echo "- Network connectivity" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Get help:**" >> $GITHUB_STEP_SUMMARY
            echo "- [Homey Developer Tools](https://tools.developer.homey.app)" >> $GITHUB_STEP_SUMMARY
            echo "- [Homey Apps SDK Documentation](https://apps.developer.homey.app)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Published using official Athom GitHub Actions*" >> $GITHUB_STEP_SUMMARY
