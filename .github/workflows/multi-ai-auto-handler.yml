name: Multi-AI Auto Handler - PRs/Issues/Forum

on:
  issues:
    types: [opened, reopened, edited]
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    # Every 3 hours - check forum + issues + PRs
    - cron: '0 */3 * * *'
  workflow_dispatch:
    inputs:
      force_scan:
        description: 'Force full scan of all sources'
        required: false
        default: 'false'

jobs:
  multi-ai-orchestration:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          npm install
          npm install axios cheerio openai anthropic @google/generative-ai cohere-ai --save-dev
      
      - name: ğŸ¤– Multi-AI Analysis - GitHub Issues
        if: github.event_name == 'issues' || github.event_name == 'schedule'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_AI_KEY: ${{ secrets.GOOGLE_AI_KEY }}
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
        run: |
          node scripts/automation/multi-ai-issue-handler.js
      
      - name: ğŸ¤– Multi-AI Analysis - Pull Requests
        if: github.event_name == 'pull_request' || github.event_name == 'schedule'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_AI_KEY: ${{ secrets.GOOGLE_AI_KEY }}
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
        run: |
          node scripts/automation/multi-ai-pr-handler.js
      
      - name: ğŸŒ Multi-AI Analysis - Homey Forum
        if: github.event_name == 'schedule' || github.event.inputs.force_scan == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_AI_KEY: ${{ secrets.GOOGLE_AI_KEY }}
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
        run: |
          node scripts/automation/multi-ai-forum-scraper.js
      
      - name: ğŸ” Apply consensus fixes
        if: success()
        run: |
          node scripts/automation/apply-consensus-fixes.js
      
      - name: âœ… Validate changes
        if: success()
        run: |
          npm run validate || echo "Validation warnings detected"
      
      - name: ğŸ“ Commit auto-fixes
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add -A
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            git commit -m "ğŸ¤– Multi-AI auto-fix: Apply consensus corrections" \
                       -m "Applied fixes from multi-AI analysis:" \
                       -m "- GitHub Issues analyzed and fixed" \
                       -m "- Pull Requests reviewed and improved" \
                       -m "- Forum posts analyzed and responded" \
                       -m "- Consensus-based automated corrections" \
                       -m "" \
                       -m "Generated by: Multi-AI Auto Handler" \
                       -m "Timestamp: $TIMESTAMP"
            
            git push
            echo "âœ… Changes committed and pushed"
          else
            echo "â„¹ï¸ No changes to commit"
          fi
      
      - name: ğŸ”” Close resolved issues
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node scripts/automation/auto-close-resolved.js
      
      - name: ğŸ“Š Generate report
        if: always()
        run: |
          node scripts/automation/generate-ai-report.js > ai-report.md
      
      - name: ğŸ’¬ Post report as comment
        if: always() && (github.event_name == 'issues' || github.event_name == 'pull_request')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('ai-report.md', 'utf8');
            
            const issueNumber = context.issue.number;
            if (issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: report
              });
            }
      
      - name: ğŸ“¤ Upload report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: multi-ai-report-${{ github.run_number }}
          path: |
            ai-report.md
            logs/*.log
          retention-days: 30
      
      - name: âš ï¸ Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.issue.number;
            if (issue_number) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                body: 'âš ï¸ Multi-AI auto-handler encountered an error. Manual review required.\n\nCheck workflow logs for details.'
              });
            }

  enrichment-workflow:
    runs-on: ubuntu-latest
    needs: multi-ai-orchestration
    if: github.event_name == 'schedule'
    timeout-minutes: 45
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm install
      
      - name: ğŸ” Scan for new Zigbee devices
        run: |
          node scripts/enrichment/scan-new-devices.js
      
      - name: ğŸ¤– AI-powered device enrichment
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          node scripts/enrichment/ai-device-enricher.js
      
      - name: ğŸ“ Commit enrichments
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add -A
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            git commit -m "ğŸ” Auto-enrichment: New Zigbee devices added" \
                       -m "Scanned and enriched:" \
                       -m "- New manufacturer IDs discovered" \
                       -m "- Device capabilities enhanced" \
                       -m "- Drivers updated automatically" \
                       -m "" \
                       -m "Generated by: Enrichment Workflow" \
                       -m "Timestamp: $TIMESTAMP"
            
            git push
            echo "âœ… Enrichments committed and pushed"
          fi
      
      - name: âœ… Validate enrichments
        run: |
          npm run validate || echo "Validation completed with warnings"

  metrics-report:
    runs-on: ubuntu-latest
    needs: [multi-ai-orchestration, enrichment-workflow]
    if: always() && github.event_name == 'schedule'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ“Š Generate metrics dashboard
        run: |
          node scripts/automation/generate-metrics-dashboard.js
      
      - name: ğŸ“¤ Upload metrics
        uses: actions/upload-artifact@v4
        with:
          name: metrics-dashboard-${{ github.run_number }}
          path: metrics-dashboard.html
          retention-days: 90
