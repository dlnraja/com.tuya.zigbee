name: Monthly Enrichment
"on":
  schedule:
    cron: 0 3 1 */3 *
  workflow_dispatch:
    inputs:
      full_scan:
        description: Force full scan (annual rescan)
        required: false
        default: false
        type: boolean
      limit:
        description: Limit number of manufacturers to process
        required: false
        default: "50"
        type: string
permissions:
  contents: read
  actions: read
jobs:
  enrich:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Run MASTER Enrichment (Rule 9.x Compliant)
        id: enricher
        run: |
          echo "ðŸš€ Running MASTER enrichment with all fingerprinting rules..."

          # Step 1: Apply all fingerprinting rules
          if [ -f "automation/MASTER_APPLY_ALL_RULES.js" ]; then
            node automation/MASTER_APPLY_ALL_RULES.js | tee enrichment.log
          fi

          # Step 2: Run MEGA enrichment from Z2M
          if [ -f "automation/MEGA_ENRICHMENT_50.js" ]; then
            node automation/MEGA_ENRICHMENT_50.js | tee -a enrichment.log
          fi

          # Step 3: Detect any remaining collisions
          if [ -f "automation/DETECT_COLLISIONS.js" ]; then
            node automation/DETECT_COLLISIONS.js | tee -a enrichment.log
          fi

          # Extract stats
          MFRS=$(grep -oP 'unique manufacturers: \K\d+' enrichment.log | tail -1 || echo "0")
          PIDS=$(grep -oP 'unique productIds: \K\d+' enrichment.log | tail -1 || echo "0")
          COLLISIONS=$(grep -oP 'Remaining collisions: \K\d+' enrichment.log | tail -1 || echo "0")

          echo "processed=$MFRS" >> $GITHUB_OUTPUT
          echo "enriched=$PIDS" >> $GITHUB_OUTPUT
          echo "collisions=$COLLISIONS" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and validate
        if: steps.enricher.outputs.enriched != '0'
        run: |
          npx homey app build
          npx homey app validate --level publish
      - name: Commit changes
        if: steps.enricher.outputs.enriched != '0'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            COMMIT_MSG="chore: Monthly enrichment - $(date +%Y-%m)

            Processed: ${{ steps.enricher.outputs.processed }} manufacturers
            Enriched: ${{ steps.enricher.outputs.enriched }} with new data

            [skip ci]"

            git commit -m "$COMMIT_MSG"
            git push
          fi
      - name: Create summary
        run: >
          echo "## ðŸ“Š Monthly Enrichment Results (Rule 9.x Compliant)" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY

          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY

          echo "| Unique Manufacturers | ${{ steps.enricher.outputs.processed }} |" >>
          $GITHUB_STEP_SUMMARY

          echo "| Unique ProductIds | ${{ steps.enricher.outputs.enriched }} |" >>
          $GITHUB_STEP_SUMMARY

          echo "| Remaining Collisions | ${{ steps.enricher.outputs.collisions }} |" >>
          $GITHUB_STEP_SUMMARY

          echo "| Run Date | $(date -u +%Y-%m-%d) |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Rules Applied" >> $GITHUB_STEP_SUMMARY

          echo "- 9.5 ManufacturerName Expansion (MAXIMAL)" >> $GITHUB_STEP_SUMMARY

          echo "- 9.6 ProductId Expansion (EXHAUSTIVE)" >> $GITHUB_STEP_SUMMARY

          echo "- 9.8 Non-Regression Protection" >> $GITHUB_STEP_SUMMARY

          echo "- 9.10 Golden Principle" >> $GITHUB_STEP_SUMMARY
      - name: Upload enrichment log
        uses: actions/upload-artifact@v4
        with:
          name: enrichment-log-${{ github.run_id }}
          path: enrichment.log
          retention-days: 30
    strategy:
      fail-fast: true
