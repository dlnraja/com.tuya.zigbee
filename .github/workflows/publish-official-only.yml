name: ðŸš€ Publish to Homey (Official Action Only)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'

jobs:

  publish:
    name: ðŸ“¦ Publish to Homey App Store
    runs-on: ubuntu-latest
    steps:

      - name: âœ… Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Get Version
        id: version
        run: |
          VERSION=$(node -p "require('./app.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"

      - name: ðŸ”‘ Check HOMEY_PAT
        run: |
          if [ -z "${{ secrets.HOMEY_PAT }}" ]; then
            echo "âŒ HOMEY_PAT not configured!"
            echo ""
            echo "ðŸ”‘ Get your Personal Access Token:"
            echo "   https://tools.developer.homey.app/api"
            echo ""
            echo "ðŸ“ Add to GitHub Secrets as: HOMEY_PAT"
            exit 1
          fi
          echo "âœ… HOMEY_PAT configured"

      - name: âœ… Validate App (Optional)
        uses: athombv/github-action-homey-app-validate@v1
        continue-on-error: true

      - name: ðŸš€ Publish to Homey App Store
        id: publish
        uses: athombv/github-action-homey-app-publish@v1
        with:
          personal_access_token: ${{ secrets.HOMEY_PAT }}

      - name: ðŸ“ Success Message
        if: success()
        run: |
          echo "âœ… App v${{ steps.version.outputs.version }} published successfully!"
          echo ""
          echo "ðŸ”— Manage your app:"
          echo "   https://tools.developer.homey.app"
          echo ""
          echo "ðŸ“± View in App Store:"
          echo "   https://apps.homey.app/app/com.dlnraja.tuya.zigbee"

      - name: ðŸ“ Create GitHub Release
        if: success() && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            # ðŸŽ‰ Release ${{ github.ref_name }}

            ## âœ… Status
            - âœ… Published to Homey App Store
            - âœ… GitHub Release created

            ## ðŸ“‹ Next Steps

            1. **Go to Developer Dashboard:**
               https://tools.developer.homey.app

            2. **Navigate to:** Apps SDK â†’ My Apps â†’ com.dlnraja.tuya.zigbee

            3. **Choose publish type:**
               - **Test:** For testing (via test link)
               - **Live:** Submit for certification â†’ Public release

            ## ðŸ”— Links
            - [Developer Tools](https://tools.developer.homey.app)
            - [Homey App Store](https://apps.homey.app/app/com.dlnraja.tuya.zigbee)
            - [Changelog](CHANGELOG.md)

            ## ðŸ“– Documentation
            See [Homey Apps Documentation](https://apps.developer.homey.app/the-basics/publishing) for details.
          files: CHANGELOG.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "# ðŸŽ¯ Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Version: v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.publish.outcome }}" == "success" ]; then
            echo "## âœ… SUCCESS!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Your app v${{ steps.version.outputs.version }} has been published to Homey App Store!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. **Go to Developer Dashboard:**" >> $GITHUB_STEP_SUMMARY
            echo "   - https://tools.developer.homey.app" >> $GITHUB_STEP_SUMMARY
            echo "   - Navigate to: **Apps SDK â†’ My Apps**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "2. **Find your app:** \`com.dlnraja.tuya.zigbee\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "3. **Choose release type:**" >> $GITHUB_STEP_SUMMARY
            echo "   - **Test Version:** Only for testing (via test link)" >> $GITHUB_STEP_SUMMARY
            echo "   - **Live Version:** Submit for certification â†’ Public" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”— Quick Links:" >> $GITHUB_STEP_SUMMARY
            echo "- [My Apps Dashboard](https://tools.developer.homey.app)" >> $GITHUB_STEP_SUMMARY
            echo "- [Homey App Store](https://apps.homey.app/app/com.dlnraja.tuya.zigbee)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **App successfully published!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Publish Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Check the logs above for details.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ” Common Issues:" >> $GITHUB_STEP_SUMMARY
            echo "- HOMEY_PAT token expired or invalid" >> $GITHUB_STEP_SUMMARY
            echo "- Validation errors in app" >> $GITHUB_STEP_SUMMARY
            echo "- App version already published" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ’¡ Solutions:" >> $GITHUB_STEP_SUMMARY
            echo "1. Get new token: https://tools.developer.homey.app/api" >> $GITHUB_STEP_SUMMARY
            echo "2. Update GitHub Secret: HOMEY_PAT" >> $GITHUB_STEP_SUMMARY
            echo "3. Check app.json version number" >> $GITHUB_STEP_SUMMARY
          fi
