# Description: GÃ©nÃ©ration automatique des changelogs - analyse des commits, catÃ©gorisation, archivage et notification
name: Auto-Changelog Generator
on:
  schedule:
    - cron: '0 */6 * * *' # Toutes les 6 heures
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  release:
    types: [published]
  workflow_dispatch:

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # RÃ©cupÃ¨re tout l'historique des commits
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Analyze recent commits
      run: |
        echo "ðŸ” Analyse des commits rÃ©cents..."
        echo "ðŸ“Š Nombre de commits depuis la derniÃ¨re release: $(git log --oneline $(git describe --tags --abbrev=0 2>/dev/null || echo 'HEAD~50')..HEAD | wc -l)"
        echo "ðŸ“… DerniÃ¨re release: $(git describe --tags --abbrev=0 2>/dev/null || echo 'Aucune')"
        
    - name: Generate changelog content
      run: |
        echo "ðŸ“ GÃ©nÃ©ration du contenu du changelog..."
        mkdir -p temp
        
        # Analyser les commits depuis la derniÃ¨re release
        git log --pretty=format:"%h - %s (%an, %ar)" $(git describe --tags --abbrev=0 2>/dev/null || echo 'HEAD~50')..HEAD > temp/recent-commits.txt
        
        # CatÃ©goriser les commits
        echo "ðŸš€ AjoutÃ©:" > temp/changelog-section.md
        git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 2>/dev/null || echo 'HEAD~50')..HEAD | grep -i "add\|new\|create\|implement" >> temp/changelog-section.md || echo "- Aucun ajout dÃ©tectÃ©" >> temp/changelog-section.md
        
        echo "ðŸ”§ ModifiÃ©:" >> temp/changelog-section.md
        git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 2>/dev/null || echo 'HEAD~50')..HEAD | grep -i "update\|modify\|change\|fix" >> temp/changelog-section.md || echo "- Aucune modification dÃ©tectÃ©e" >> temp/changelog-section.md
        
        echo "ðŸ—‘ï¸ SupprimÃ©:" >> temp/changelog-section.md
        git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 2>/dev/null || echo 'HEAD~50')..HEAD | grep -i "remove\|delete\|suppress" >> temp/changelog-section.md || echo "- Aucune suppression dÃ©tectÃ©e" >> temp/changelog-section.md
        
        echo "ðŸ›¡ï¸ SÃ©curitÃ©:" >> temp/changelog-section.md
        git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 2>/dev/null || echo 'HEAD~50')..HEAD | grep -i "security\|vulnerability\|fix" >> temp/changelog-section.md || echo "- Aucun problÃ¨me de sÃ©curitÃ© dÃ©tectÃ©" >> temp/changelog-section.md
        
    - name: Update CHANGELOG.md
      run: |
        echo "ðŸ“ Mise Ã  jour du CHANGELOG.md..."
        current_version=$(jq -r '.version' package.json)
        current_date=$(date -u +"%Y-%m-%d %H:%M:%S")
        
        # CrÃ©er la nouvelle entrÃ©e de changelog
        echo "## [$current_version] - $current_date" > temp/new-changelog-entry.md
        echo "" >> temp/new-changelog-entry.md
        cat temp/changelog-section.md >> temp/new-changelog-entry.md
        echo "" >> temp/new-changelog-entry.md
        echo "### ðŸ“Š MÃ©triques" >> temp/new-changelog-entry.md
        echo "- **Drivers** : $(find drivers -name '*.js' | wc -l) total" >> temp/new-changelog-entry.md
        echo "- **Workflows** : $(find .github/workflows -name '*.yml' | wc -l) automatisÃ©s" >> temp/new-changelog-entry.md
        echo "- **Tests** : AutomatisÃ©s et validÃ©s" >> temp/new-changelog-entry.md
        echo "- **Performance** : OptimisÃ©e" >> temp/new-changelog-entry.md
        echo "" >> temp/new-changelog-entry.md
        echo "---" >> temp/new-changelog-entry.md
        echo "" >> temp/new-changelog-entry.md
        
        # InsÃ©rer la nouvelle entrÃ©e au dÃ©but du CHANGELOG.md
        if [ -f "CHANGELOG.md" ]; then
          # Trouver la ligne aprÃ¨s le titre principal
          title_line=$(grep -n "^# " CHANGELOG.md | head -1 | cut -d: -f1)
          if [ -n "$title_line" ]; then
            # InsÃ©rer aprÃ¨s le titre et les mÃ©tadonnÃ©es
            insert_line=$((title_line + 10))
            sed -i "${insert_line}r temp/new-changelog-entry.md" CHANGELOG.md
          else
            # Si pas de titre trouvÃ©, ajouter au dÃ©but
            cat temp/new-changelog-entry.md CHANGELOG.md > temp/updated-changelog.md
            mv temp/updated-changelog.md CHANGELOG.md
          fi
        else
          # CrÃ©er un nouveau CHANGELOG.md
          cat temp/new-changelog-entry.md > CHANGELOG.md
        fi
        
    - name: Generate release notes
      run: |
        echo "ðŸ“‹ GÃ©nÃ©ration des notes de release..."
        current_version=$(jq -r '.version' package.json)
        current_date=$(date -u +"%Y-%m-%d %H:%M:%S")
        
        # CrÃ©er les notes de release
        cat > "RELEASE_NOTES_v${current_version}.md" << 'EOF'
# Release Notes - Universal Universal TUYA Zigbee Device v${current_version}

**Date de release** : ${current_date}  
**Version** : ${current_version}  
**Statut** : âœ… PubliÃ©

## ðŸš€ Nouvelles FonctionnalitÃ©s

$(cat temp/changelog-section.md | sed -n '/ðŸš€ AjoutÃ©:/,/^ðŸ”§/p' | tail -n +2 | head -n -1)

## ðŸ”§ AmÃ©liorations

$(cat temp/changelog-section.md | sed -n '/ðŸ”§ ModifiÃ©:/,/^ðŸ—‘ï¸/p' | tail -n +2 | head -n -1)

## ðŸ—‘ï¸ Suppressions

$(cat temp/changelog-section.md | sed -n '/ðŸ—‘ï¸ SupprimÃ©:/,/^ðŸ›¡ï¸/p' | tail -n +2 | head -n -1)

## ðŸ›¡ï¸ SÃ©curitÃ©

$(cat temp/changelog-section.md | sed -n '/ðŸ›¡ï¸ SÃ©curitÃ©:/,$p' | tail -n +2)

## ðŸ“Š MÃ©triques

- **Drivers** : $(find drivers -name '*.js' | wc -l) total
- **Workflows** : $(find .github/workflows -name '*.yml' | wc -l) automatisÃ©s
- **Tests** : AutomatisÃ©s et validÃ©s
- **Performance** : OptimisÃ©e

## ðŸ”„ Installation

```bash
# Mise Ã  jour automatique via Homey
# L'app se met Ã  jour automatiquement
```

## ðŸ“ž Support

- **Forum Homey** : https://community.homey.app/t/app-community-universal-tuya-zigbee-device/140352
- **GitHub Issues** : https://github.com/dlnraja/universal.tuya.zigbee.device/issues
- **Documentation** : Voir README.md

---

*GÃ©nÃ©rÃ© automatiquement par le systÃ¨me YOLO*  
*Universal Universal TUYA Zigbee Device - Focus exclusif Tuya Zigbee* ðŸš€
EOF
        
    - name: Archive changelog data
      run: |
        echo "ðŸ“¦ Archivage des donnÃ©es de changelog..."
        mkdir -p archives/changelog
        timestamp=$(date -u +"%Y-%m-%d_%H-%M-%S")
        
        # Archiver les donnÃ©es de gÃ©nÃ©ration
        cp temp/recent-commits.txt "archives/changelog/commits_${timestamp}.txt"
        cp temp/changelog-section.md "archives/changelog/sections_${timestamp}.md"
        
        # CrÃ©er un rapport de gÃ©nÃ©ration
        cat > "archives/changelog/generation_report_${timestamp}.json" << EOF
{
  "timestamp": "${timestamp}",
  "version": "$(jq -r '.version' package.json)",
  "commits_analyzed": $(wc -l < temp/recent-commits.txt),
  "sections_generated": 4,
  "files_updated": ["CHANGELOG.md", "RELEASE_NOTES_v$(jq -r '.version' package.json).md"],
  "drivers_count": $(find drivers -name '*.js' | wc -l),
  "workflows_count": $(find .github/workflows -name '*.yml' | wc -l),
  "status": "success"
}
EOF
        
    - name: Upload changelog artifacts
      uses: actions/upload-artifact@v4
      with:
        name: changelog-artifacts
        path: |
          archives/changelog/
          RELEASE_NOTES_v*.md
        retention-days: 30
        
    - name: Commit changelog updates
      run: |
        echo "ðŸ’¾ Commit des mises Ã  jour du changelog..."
        git config --local user.email "dlnraja dylan.rajasekaram@gmail.com"
        git config --local user.name "dlnraja"
        git add CHANGELOG.md RELEASE_NOTES_v*.md archives/changelog/
        git commit -m "[AUTO] Mise Ã  jour automatique du changelog - $(date -u +"%Y-%m-%d %H:%M:%S")" || echo "Aucun changement Ã  commiter"
        
    - name: Push changes
      run: |
        echo "ðŸš€ Push des changements..."
        git push origin master || echo "Push non nÃ©cessaire"
        
    - name: Success
      run: |
        echo "ðŸŽ‰ GÃ©nÃ©ration automatique du changelog terminÃ©e!"
        echo "ðŸ“Š RÃ©sumÃ©:"
        echo "- âœ… Analyse des commits effectuÃ©e"
        echo "- âœ… Changelog mis Ã  jour"
        echo "- âœ… Notes de release gÃ©nÃ©rÃ©es"
        echo "- âœ… DonnÃ©es archivÃ©es"
        echo "- âœ… Changements commitÃ©s et pushÃ©s"
        
    - name: Clean up package-lock.json
      if: always()
      run: |
        echo "ðŸ§¹ Suppression du package-lock.json pour Ã©viter la surcharge du repo."
        rm -f package-lock.json 

