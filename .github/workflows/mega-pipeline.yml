name: Tuya Zigbee Mega Pipeline

on:
  schedule:
    - cron: '0 2 * * 1,4'
  workflow_dispatch:
  push:
    branches: [test]

jobs:
  full-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ§ª Install Node Dependencies
        run: npm ci

      #################################################
      # ğŸ” 1. Check & Fix Core App Structure (recursif)
      #################################################
      - name: ğŸ§± Fix app.json, app.js, paths & drivers
        run: node scripts/fix-app-structure.js || echo "âš ï¸ Core structure correction skipped"

      #################################################
      # ğŸ” 2. Verify and Clean All Drivers
      #################################################
      - name: ğŸ” Scan & Validate Drivers
        run: node scripts/verify-all-drivers.js || echo "âš ï¸ Driver verification skipped"

      #################################################
      # ğŸ”„ 3. Fetch New Devices
      #################################################
      - name: ğŸ”„ Fetch Tuya/Community/New Devices
        run: node scripts/fetch-new-devices.js || echo "âš ï¸ Device fetching skipped"

      #################################################
      # ğŸ§  4. Enrich with AI (Optional)
      #################################################
      - name: ğŸ§  Enrich Drivers with AI (if key present)
        if: ${{ secrets.OPENAI_API_KEY != '' }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: node scripts/ai-enrich-drivers.js || echo "âš ï¸ AI skipped"

      #################################################
      # ğŸ•¸ï¸ 5. Scrape Homey Community
      #################################################
      - name: ğŸ•¸ï¸ Scrape Homey Web & Forum
        run: node scripts/scrape-homey-community.js || echo "âš ï¸ Web scraping skipped"

      #################################################
      # ğŸ› 6. Scrape Forum Bugs & Auto-Fix
      #################################################
      - name: ğŸ› Scrape Forum Bugs & Auto-Fix
        run: node scripts/scrape-homey-forum-bugs.js || echo "âš ï¸ Forum bugs scraping skipped"

      #################################################
      # ğŸ“¬ 7. Fetch GitHub Issues & PRs
      #################################################
      - name: ğŸ“¬ Sync Issues & PRs
        if: ${{ secrets.GITHUB_TOKEN != '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node scripts/fetch-issues-pullrequests.js || echo "âš ï¸ GitHub fetch skipped"

      #################################################
      # ğŸ§© 8. Resolve TODO Devices
      #################################################
      - name: ğŸ§© Generate & Fix TODO Devices
        run: node scripts/resolve-todo-devices.js || echo "âš ï¸ TODO resolution skipped"

      #################################################
      # ğŸ§ª 9. Test Compatibility (Firmware + Homey)
      #################################################
      - name: ğŸ§ª Compatibility Check (Firmware + Platform)
        run: node scripts/test-multi-firmware-compatibility.js || echo "âš ï¸ Compatibility skipped"

      #################################################
      # ğŸ› ï¸ 10. Homey CLI Validation
      #################################################
      - name: ğŸ§° Validate App via Homey CLI
        run: |
          if command -v homey > /dev/null; then
            homey app validate || echo "âš ï¸ Homey CLI validation failed"
          else
            echo "âš ï¸ Homey CLI not installed in CI context"
          fi

      #################################################
      # ğŸ“š 11. Generate Documentation
      #################################################
      - name: ğŸ“œ Generate README, Changelog, Matrix
        run: node scripts/generate-docs.js || echo "âš ï¸ Doc generation skipped"

      #################################################
      # âœ… 12. Lint + Test Drivers
      #################################################
      - name: âœ… Lint & Unit Test
        run: npm run lint && npm run test || echo "âš ï¸ Lint/test warnings"

      #################################################
      # ğŸš€ 13. Commit & Push if token present
      #################################################
      - name: ğŸš€ Commit & Push
        if: ${{ secrets.GITHUB_TOKEN != '' }}
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸš€ Auto-fix & enrich drivers [CI]"
          branch: test
          file_pattern: |
            app.json
            app.js
            drivers/**
            CHANGELOG.md
            README.md
            docs/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      #################################################
      # ğŸŒ 14. Deploy Dashboard (optional)
      #################################################
      - name: ğŸŒ Deploy Pages (if exists)
        run: npm run deploy:pages || echo "âš ï¸ No dashboard to deploy" 