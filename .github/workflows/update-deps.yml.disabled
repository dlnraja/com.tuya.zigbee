name: 🔄 Update Dependencies

on:
  schedule:
    - cron: '0 8 * * 0' # Every Sunday at 8 AM UTC
  workflow_dispatch:
    inputs:
      target:
        description: 'Update target'
        required: false
        default: 'minor'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  check-updates:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: 📦 Install dependencies
      run: |
        npm ci
        npm install -g npm-check-updates
        
    - name: 🔍 Check for updates
      id: check-updates
      run: |
        echo "Checking for dependency updates..."
        ncu --target ${{ github.event.inputs.target || 'minor' }} --format group > updates.txt
        if [ -s updates.txt ]; then
          echo "updates-available=true" >> $GITHUB_OUTPUT
          echo "Updates found:"
          cat updates.txt
        else
          echo "updates-available=false" >> $GITHUB_OUTPUT
          echo "No updates available"
        fi
        
    - name: 📊 Generate update report
      if: steps.check-updates.outputs.updates-available == 'true'
      run: |
        npm run report:dependency-updates
        echo "Dependency update report generated"
        
    - name: 📤 Upload update artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dependency-updates
        path: |
          updates.txt
          reports/dependencies/
        retention-days: 30

  create-update-pr:
    runs-on: ubuntu-latest
    needs: check-updates
    if: steps.check-updates.outputs.updates-available == 'true'
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: 📦 Install dependencies
      run: npm ci
        
    - name: 📥 Download update artifacts
      uses: actions/download-artifact@v4
      with:
        name: dependency-updates
        path: ./
        
    - name: 🔄 Update dependencies
      run: |
        echo "Updating dependencies..."
        ncu --target ${{ github.event.inputs.target || 'minor' }} --upgrade
        npm install
        echo "Dependencies updated"
        
    - name: 🔍 Run tests after update
      run: |
        npm test || echo "Some tests failed after dependency update"
        
    - name: 📊 Generate post-update report
      run: |
        npm run report:post-update
        echo "Post-update report generated"
        
    - name: 📝 Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          🔄 Update dependencies to latest versions
          
          Automated dependency update using npm-check-updates:
          - Target: ${{ github.event.inputs.target || 'minor' }}
          - Updated packages: [List from updates.txt]
          - Tests: [Pass/Fail status]
          
          Generated by GitHub Actions dependency update workflow
          Date: ${{ github.event.schedule || 'Manual trigger' }}
        title: |
          🔄 Dependency Updates: ${{ github.event.inputs.target || 'minor' }} versions
        body: |
          ## 🔄 Automated Dependency Updates
          
          This PR contains automatically updated dependencies using npm-check-updates.
          
          ### 📊 Update Summary
          - **Target**: ${{ github.event.inputs.target || 'minor' }} versions
          - **Packages Updated**: [Count] packages
          - **Update Type**: [patch/minor/major]
          - **Test Status**: [Pass/Fail]
          
          ### 📋 Updated Packages
          ```
          [Content from updates.txt]
          ```
          
          ### 🔍 Changes Made
          - Updated package.json
          - Updated package-lock.json
          - Ran tests to verify compatibility
          - Generated update report
          
          ### 🧪 Testing
          - [ ] All tests pass
          - [ ] No breaking changes
          - [ ] Compatibility maintained
          - [ ] Performance acceptable
          
          ### 📈 Impact Assessment
          - **Security**: [Improved/Unchanged/Worse]
          - **Performance**: [Improved/Unchanged/Worse]
          - **Compatibility**: [Maintained/Breaking]
          - **Risk Level**: [Low/Medium/High]
          
          ### 📋 Review Checklist
          - [ ] Dependencies are necessary
          - [ ] No breaking changes introduced
          - [ ] Tests pass successfully
          - [ ] Performance is acceptable
          - [ ] Security is improved/maintained
          
          ---
          
          *Generated by GitHub Actions on ${{ github.event.schedule || 'Manual trigger' }}*
          
          **Note**: This is an automated dependency update. Please review carefully for breaking changes.
        branch: dependency-updates/${{ github.run_id }}
        base: develop
        delete-branch: true
        labels: |
          auto-generated
          dependencies
          maintenance
          security
        assignees: dlnraja
        reviewers: dlnraja
        
    - name: 📊 Update dependency metrics
      run: |
        npm run update:dependency-metrics
        echo "Dependency metrics updated"
        
    - name: 📤 Upload update artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: update-artifacts
        path: |
          reports/
          logs/
          package.json
          package-lock.json
        retention-days: 90

  notification:
    runs-on: ubuntu-latest
    needs: [check-updates, create-update-pr]
    if: always()
    
    steps:
    - name: 📧 Send notification
      run: |
        echo "## 🔄 Dependency Update Notification" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.check-updates.outputs.updates-available }}" == "true" ]; then
          echo "✅ Dependencies updated successfully" >> $GITHUB_STEP_SUMMARY
          echo "📝 Pull Request created for review" >> $GITHUB_STEP_SUMMARY
        else
          echo "ℹ️ No dependency updates available" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "📊 Update artifacts uploaded" >> $GITHUB_STEP_SUMMARY
        echo "🔄 Next scheduled check: Sunday 8 AM UTC" >> $GITHUB_STEP_SUMMARY
        
    - name: 📧 Send Discord notification
      if: ${{ needs.check-updates.outputs.updates-available == 'true' }}
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.DISCORD_WEBHOOK }}
        status: ${{ job.status }}
        title: "Dependencies Updated"
        description: |
          **Universal Tuya Zigbee** dependencies updated!
          
          🔄 ${{ github.event.inputs.target || 'minor' }} version updates
          📦 [Count] packages updated
          🔗 [View PR](${{ github.server_url }}/${{ github.repository }}/pull/${{ needs.create-update-pr.outputs.pr-number }})
        color: "00ff00"

  cleanup:
    runs-on: ubuntu-latest
    needs: [check-updates, create-update-pr, notification]
    if: always()
    
    steps:
    - name: 🧹 Cleanup temporary files
      run: |
        npm run cleanup:temp
        echo "Temporary files cleaned up"
        
    - name: 📊 Update dependency metrics
      run: |
        npm run update:dependency-metrics
        echo "Dependency metrics updated"
        
    - name: 📤 Upload final artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: final-dependency-artifacts
        path: |
          reports/
          logs/
          metrics/
        retention-days: 365
