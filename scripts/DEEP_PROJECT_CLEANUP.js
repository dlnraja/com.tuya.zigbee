#!/usr/bin/env node
/**
 * DEEP PROJECT CLEANUP
 * 
 * Analyse COMPL√àTE de la racine et nettoyage profond:
 * - Identifie tous les fichiers l√©gitimes vs non-l√©gitimes
 * - D√©place/Archive fichiers non essentiels
 * - V√©rifie TOUS les chemins dans le projet
 * - Garantit coh√©rence et fonctionnalit√©
 */

const fs = require('fs');
const path = require('path');

const rootPath = path.join(__dirname, '..');

console.log('üßπ DEEP PROJECT CLEANUP');
console.log('='.repeat(80));
console.log('‚ö° ANALYSE & NETTOYAGE COMPLET DE LA RACINE');
console.log('='.repeat(80));
console.log('');

// ============================================================================
// FICHIERS L√âGITIMES √Ä LA RACINE
// ============================================================================

const LEGITIMATE_ROOT_FILES = [
  // Essentiels app
  'app.json',
  'app.js',
  'package.json',
  'package-lock.json',
  
  // Documentation principale
  'README.md',
  'CHANGELOG.md',
  'CONTRIBUTING.md',
  
  // Lanceur principal
  'LAUNCH_FULL_ENRICHMENT.bat',
  
  // Configuration
  '.gitignore',
  '.homeyignore',
  '.prettierignore',
  '.prettierrc',
  '.homeychangelog.json',
  '.env'
];

const LEGITIMATE_ROOT_DIRS = [
  '.git',
  '.github',
  '.vscode',
  '.homeycompose',
  'node_modules',
  'assets',
  'locales',
  'drivers',
  'scripts',
  'docs',
  'reports'
];

// ============================================================================
// DOSSIERS √Ä ARCHIVER (non essentiels)
// ============================================================================

const DIRS_TO_ARCHIVE = [
  'archive',
  'backup',
  'backup_complete',
  'catalog',
  'deep_scraping',
  'forum_analysis',
  'mega_analysis',
  'project-data',
  'references',
  'settings',
  'tools',
  'ultimate_system'
];

// ============================================================================
// PHASE 1: ANALYSE
// ============================================================================

console.log('üîç Phase 1: Analyse de la Racine');
console.log('-'.repeat(80));

const rootItems = fs.readdirSync(rootPath);

const analysis = {
  legitimate: [],
  toMove: [],
  toArchive: [],
  unknown: []
};

rootItems.forEach(item => {
  const itemPath = path.join(rootPath, item);
  const stat = fs.statSync(itemPath);
  
  if (stat.isDirectory()) {
    if (LEGITIMATE_ROOT_DIRS.includes(item)) {
      analysis.legitimate.push({ type: 'dir', name: item, action: 'KEEP' });
    } else if (DIRS_TO_ARCHIVE.includes(item)) {
      analysis.toArchive.push({ type: 'dir', name: item, action: 'ARCHIVE' });
    } else {
      analysis.unknown.push({ type: 'dir', name: item, action: 'REVIEW' });
    }
  } else {
    if (LEGITIMATE_ROOT_FILES.includes(item)) {
      analysis.legitimate.push({ type: 'file', name: item, action: 'KEEP' });
    } else if (item.endsWith('.ps1')) {
      analysis.toMove.push({ type: 'file', name: item, target: 'scripts/', action: 'MOVE' });
    } else if (item.endsWith('.txt') && item !== 'requirements.txt') {
      analysis.toMove.push({ type: 'file', name: item, target: 'docs/', action: 'MOVE' });
    } else if (item.endsWith('.md') && !LEGITIMATE_ROOT_FILES.includes(item)) {
      analysis.toMove.push({ type: 'file', name: item, target: 'docs/', action: 'MOVE' });
    } else {
      analysis.unknown.push({ type: 'file', name: item, action: 'REVIEW' });
    }
  }
});

console.log(`   ‚úÖ L√©gitimes:  ${analysis.legitimate.length}`);
console.log(`   üì¶ √Ä d√©placer: ${analysis.toMove.length}`);
console.log(`   üìÅ √Ä archiver: ${analysis.toArchive.length}`);
console.log(`   ‚ö†Ô∏è  Inconnus:   ${analysis.unknown.length}`);
console.log('');

// ============================================================================
// PHASE 2: AFFICHAGE D√âTAILS
// ============================================================================

console.log('üìã Phase 2: D√©tails');
console.log('-'.repeat(80));

if (analysis.toMove.length > 0) {
  console.log('');
  console.log('üì¶ FICHIERS √Ä D√âPLACER:');
  analysis.toMove.forEach(item => {
    console.log(`   ${item.name} ‚Üí ${item.target}`);
  });
}

if (analysis.toArchive.length > 0) {
  console.log('');
  console.log('üìÅ DOSSIERS √Ä ARCHIVER:');
  analysis.toArchive.forEach(item => {
    console.log(`   ${item.name}/ ‚Üí archive_old/`);
  });
}

if (analysis.unknown.length > 0) {
  console.log('');
  console.log('‚ö†Ô∏è  FICHIERS INCONNUS (√† review):');
  analysis.unknown.forEach(item => {
    console.log(`   ${item.type === 'dir' ? item.name + '/' : item.name}`);
  });
}

console.log('');

// ============================================================================
// PHASE 3: EX√âCUTION DU NETTOYAGE
// ============================================================================

console.log('üßπ Phase 3: Ex√©cution du Nettoyage');
console.log('-'.repeat(80));

const stats = {
  moved: 0,
  archived: 0,
  errors: 0
};

// D√©placer fichiers
analysis.toMove.forEach(item => {
  try {
    const sourcePath = path.join(rootPath, item.name);
    const targetPath = path.join(rootPath, item.target, item.name);
    
    if (fs.existsSync(targetPath)) {
      console.log(`   ‚ÑπÔ∏è  Existe d√©j√†: ${item.target}${item.name}`);
    } else {
      fs.renameSync(sourcePath, targetPath);
      console.log(`   ‚úÖ D√©plac√©: ${item.name} ‚Üí ${item.target}`);
      stats.moved++;
    }
  } catch (error) {
    console.log(`   ‚ùå Erreur: ${item.name} - ${error.message}`);
    stats.errors++;
  }
});

// Archiver dossiers
const archiveDir = path.join(rootPath, 'archive_old');
if (analysis.toArchive.length > 0) {
  if (!fs.existsSync(archiveDir)) {
    fs.mkdirSync(archiveDir, { recursive: true });
    console.log('   ‚úÖ Cr√©√©: archive_old/');
  }
  
  analysis.toArchive.forEach(item => {
    try {
      const sourcePath = path.join(rootPath, item.name);
      const targetPath = path.join(archiveDir, item.name);
      
      if (fs.existsSync(targetPath)) {
        console.log(`   ‚ÑπÔ∏è  D√©j√† archiv√©: ${item.name}/`);
      } else {
        fs.renameSync(sourcePath, targetPath);
        console.log(`   ‚úÖ Archiv√©: ${item.name}/ ‚Üí archive_old/`);
        stats.archived++;
      }
    } catch (error) {
      console.log(`   ‚ùå Erreur: ${item.name}/ - ${error.message}`);
      stats.errors++;
    }
  });
}

console.log('');

// ============================================================================
// PHASE 4: V√âRIFICATION CHEMINS
// ============================================================================

console.log('üîç Phase 4: V√©rification Chemins');
console.log('-'.repeat(80));

const pathsToCheck = {
  bat: {
    file: 'LAUNCH_FULL_ENRICHMENT.bat',
    paths: [
      'scripts\\MEGA_GITHUB_INTEGRATION_ENRICHER.js',
      'scripts\\MEGA_FORUM_WEB_INTEGRATOR.js',
      'scripts\\ULTIMATE_PATTERN_ANALYZER_ORCHESTRATOR.js',
      'scripts\\ULTRA_FINE_DRIVER_ANALYZER.js',
      'scripts\\ULTIMATE_WEB_VALIDATOR.js'
    ]
  },
  githubAction: {
    file: '.github/workflows/monthly-auto-enrichment.yml',
    paths: [
      'scripts/MONTHLY_AUTO_ENRICHMENT_ORCHESTRATOR.js'
    ]
  }
};

let pathErrors = 0;

// Check .bat file
console.log('   üìÑ Checking LAUNCH_FULL_ENRICHMENT.bat...');
if (fs.existsSync(path.join(rootPath, pathsToCheck.bat.file))) {
  const batContent = fs.readFileSync(path.join(rootPath, pathsToCheck.bat.file), 'utf8');
  pathsToCheck.bat.paths.forEach(scriptPath => {
    if (batContent.includes(scriptPath)) {
      const fullPath = path.join(rootPath, scriptPath.replace(/\\/g, '/'));
      if (fs.existsSync(fullPath)) {
        console.log(`      ‚úÖ ${scriptPath}`);
      } else {
        console.log(`      ‚ùå MANQUANT: ${scriptPath}`);
        pathErrors++;
      }
    } else {
      console.log(`      ‚ö†Ô∏è  Non r√©f√©renc√©: ${scriptPath}`);
    }
  });
} else {
  console.log('      ‚ùå .bat file not found!');
  pathErrors++;
}

// Check GitHub Action
console.log('   üìÑ Checking GitHub Actions...');
if (fs.existsSync(path.join(rootPath, pathsToCheck.githubAction.file))) {
  const actionContent = fs.readFileSync(path.join(rootPath, pathsToCheck.githubAction.file), 'utf8');
  pathsToCheck.githubAction.paths.forEach(scriptPath => {
    if (actionContent.includes(scriptPath)) {
      const fullPath = path.join(rootPath, scriptPath);
      if (fs.existsSync(fullPath)) {
        console.log(`      ‚úÖ ${scriptPath}`);
      } else {
        console.log(`      ‚ùå MANQUANT: ${scriptPath}`);
        pathErrors++;
      }
    } else {
      console.log(`      ‚ö†Ô∏è  Non r√©f√©renc√©: ${scriptPath}`);
    }
  });
} else {
  console.log('      ‚ö†Ô∏è  GitHub Action not found');
}

console.log('');

// ============================================================================
// PHASE 5: RAPPORT FINAL
// ============================================================================

console.log('='.repeat(80));
console.log('üìä RAPPORT FINAL');
console.log('='.repeat(80));
console.log('');
console.log('üìà STATISTIQUES:');
console.log(`   Fichiers d√©plac√©s:     ${stats.moved}`);
console.log(`   Dossiers archiv√©s:     ${stats.archived}`);
console.log(`   Erreurs:               ${stats.errors}`);
console.log(`   Erreurs de chemins:    ${pathErrors}`);
console.log('');
console.log('üìÅ STRUCTURE FINALE:');
console.log(`   L√©gitimes √† la racine: ${analysis.legitimate.length}`);
console.log(`   Fichiers docs/:        D√©plac√©s (${analysis.toMove.filter(i => i.target === 'docs/').length})`);
console.log(`   Fichiers scripts/:     D√©plac√©s (${analysis.toMove.filter(i => i.target === 'scripts/').length})`);
console.log(`   Dossiers archive_old/: Archiv√©s (${stats.archived})`);
console.log('');

if (pathErrors === 0 && stats.errors === 0) {
  console.log('‚úÖ NETTOYAGE COMPLET R√âUSSI!');
  console.log('');
  console.log('üìÅ Racine du projet maintenant CLEAN:');
  console.log('   - Fichiers essentiels uniquement');
  console.log('   - Tous les chemins valides');
  console.log('   - Structure coh√©rente');
  console.log('   - Pr√™t pour production');
} else {
  console.log('‚ö†Ô∏è  NETTOYAGE TERMIN√â AVEC AVERTISSEMENTS');
  console.log('   V√©rifier les erreurs ci-dessus');
}

console.log('');

// Save report
const reportPath = path.join(rootPath, 'reports', 'cleanup_report.json');
fs.writeFileSync(reportPath, JSON.stringify({
  timestamp: new Date().toISOString(),
  analysis: analysis,
  stats: stats,
  pathErrors: pathErrors
}, null, 2));

console.log(`üìÑ Rapport: ${reportPath}`);
console.log('');

process.exit(pathErrors > 0 || stats.errors > 0 ? 1 : 0);
