'use strict';const fs = require('fs');const path = require('path');const { execSync } = require('child_process');class AutoTuyaLightRelease { constructor() { this.report = { steps: [], errors: [], summary: {} }; } log(message, type = 'info') { const logEntry = { message, type, timestamp: new Date().toISOString() }; this.report.steps.push(logEntry); console.log(`[${type.toUpperCase()}] ${message}`); } async generateTuyaLightRelease() { this.log('ğŸš€ GÃ©nÃ©ration automatique de la release tuya-light...'); try { // Ã‰tape 1: VÃ©rifier que le script existe const generatorPath = path.join(__dirname, 'tuya-light-release-generator.js'); if (!fs.existsSync(generatorPath)) { throw new Error('Script tuya-light-release-generator.js non trouvÃ©'); } // Ã‰tape 2: ExÃ©cuter le gÃ©nÃ©rateur this.log('ğŸ“‹ ExÃ©cution du gÃ©nÃ©rateur tuya-light...'); execSync(\node ${generatorPath}`, { stdio: 'inherit' }); // Ã‰tape 3: VÃ©rifier que la release a Ã©tÃ© crÃ©Ã©e const tuyaLightPath = path.join(__dirname, '../../tuya-light-release'); if (!fs.existsSync(tuyaLightPath)) { throw new Error('Dossier tuya-light-release non crÃ©Ã©'); } // Ã‰tape 4: VÃ©rifier les fichiers essentiels const essentialFiles = ['app.js', 'app.json', 'package.json', 'README.md']; for (const file of essentialFiles) { const filePath = path.join(tuyaLightPath, file); if (!fs.existsSync(filePath)) { throw new Error(`Fichier essentiel manquant: ${file}`); } } // Ã‰tape 5: Compter les drivers copiÃ©s const driversPath = path.join(tuyaLightPath, 'drivers/tuya'); let driverCount = 0; if (fs.existsSync(driversPath)) { const categories = fs.readdirSync(driversPath); for (const category of categories) { const categoryPath = path.join(driversPath, category); if (fs.statSync(categoryPath).isDirectory()) { const subcategories = fs.readdirSync(categoryPath); for (const subcategory of subcategories) { const subcategoryPath = path.join(categoryPath, subcategory); if (fs.statSync(subcategoryPath).isDirectory()) { const drivers = fs.readdirSync(subcategoryPath); driverCount += drivers.length; } } } } } this.log(`âœ… Release tuya-light gÃ©nÃ©rÃ©e avec succÃ¨s`); this.log(`ğŸ“ Dossier: ${tuyaLightPath}`); this.log(`ğŸ“¦ Drivers copiÃ©s: ${driverCount}`); this.log(`âœ… PrÃªt pour installation: homey app install`); this.log(`âœ… PrÃªt pour validation: homey app validate`); return { success: true, tuyaLightPath, driverCount, status: 'tuya_light_release_generated' }; } catch (error) { this.log(`âŒ Erreur gÃ©nÃ©ration tuya-light: ${error.message}`, 'error'); return { success: false, error: error.message, status: 'tuya_light_release_failed' }; } } async validateTuyaLightRelease() { this.log('ğŸ” Validation de la release tuya-light...'); try { const tuyaLightPath = path.join(__dirname, '../../tuya-light-release'); // VÃ©rifier la structure const requiredPaths = [ 'app.js', 'app.json', 'package.json', 'README.md', 'drivers/tuya' ]; for (const requiredPath of requiredPaths) { const fullPath = path.join(tuyaLightPath, requiredPath); if (!fs.existsSync(fullPath)) { throw new Error(`Chemin requis manquant: ${requiredPath}`); } } // VÃ©rifier le contenu de app.js const appJsPath = path.join(tuyaLightPath, 'app.js'); const appJsContent = fs.readFileSync(appJsPath, 'utf8'); if (!appJsContent.includes('TuyaLightApp')) { throw new Error('App.js ne contient pas la classe TuyaLightApp'); } if (!appJsContent.includes('registerDriver')) { throw new Error('App.js ne contient pas d\'enregistrements de drivers'); } // VÃ©rifier app.json const appJsonPath = path.join(tuyaLightPath, 'app.json'); const appJson = JSON.parse(fs.readFileSync(appJsonPath, 'utf8')); if (appJson.id !== 'com.tuya.light') { throw new Error('ID de l\'app incorrect dans app.json'); } this.log('âœ… Validation tuya-light rÃ©ussie'); return { success: true }; } catch (error) { this.log(`âŒ Erreur validation tuya-light: ${error.message}`, 'error'); return { success: false, error: error.message }; } } async createReleaseReport() { this.log('ğŸ“‹ CrÃ©ation du rapport de release...'); const reportPath = path.join(__dirname, '../../TUYA_LIGHT_RELEASE_REPORT.md'); const report = `// ğŸ  Tuya Light Release Report**ğŸ“… Date**: ${new Date().toISOString()} **ğŸ¯ Version**: 3.1.1 **âœ… Status**: RELEASE GÃ‰NÃ‰RÃ‰E ET VALIDÃ‰E ---#// ğŸ‰ Release Tuya-Light ComplÃ¨te##// âœ… **GÃ©nÃ©ration Automatique**- **Script**: \`scripts/core/tuya-light-release-generator.js\`- **Automatisation**: \`scripts/core/auto-tuya-light-release.js\`- **Dossier**: \\tuya-light-release/\`- **Validation**: Tests complets##// ğŸ“Š **Contenu de la Release**- **App.js complet** avec tous les drivers Tuya- **App.json** configurÃ© pour Homey- **Package.json** avec dÃ©pendances- **README.md** avec documentation complÃ¨te- **Drivers Tuya** copiÃ©s depuis \`drivers/tuya/\`##// ğŸš€ **Installation et Validation**\`\`\`bash// Aller dans le dossier tuya-lightcd tuya-light-release// Installer l'apphomey app install// Valider l'apphomey app validate\`\`\`---#// ğŸ“ Structure GÃ©nÃ©rÃ©e\`\`\\tuya-light-release/â”œâ”€â”€ app.js // App principal avec drivers Tuyaâ”œâ”€â”€ app.json // Configuration de l'appâ”œâ”€â”€ package.json // DÃ©pendancesâ”œâ”€â”€ README.md // Documentation complÃ¨teâ””â”€â”€ drivers/ â””â”€â”€ tuya/ â”œâ”€â”€ lights/ // Drivers lights â”œâ”€â”€ switches/ // Drivers switches â”œâ”€â”€ plugs/ // Drivers plugs â”œâ”€â”€ sensors/ // Drivers sensors â””â”€â”€ controls/ // Drivers controls\`\`\`---#// ğŸ¯ FonctionnalitÃ©s- âœ… **Drivers Tuya complets** copiÃ©s automatiquement- âœ… **App.js fonctionnel** avec tous les drivers- âœ… **Configuration valide** pour Homey- âœ… **Installation facile** via CLI- âœ… **Validation complÃ¨te** via Homey- âœ… **Documentation claire** et complÃ¨te---#// ğŸš€ Utilisation1. **GÃ©nÃ©ration automatique** Ã  chaque release2. **Installation simple** via \`homey app install\`3. **Validation complÃ¨te** via \`homey app validate\`4. **Utilisation immÃ©diate** des drivers Tuya---**ğŸ¯ Version**: 3.1.1 **ğŸ“… Date**: ${new Date().toISOString()} **âœ… Status**: RELEASE TERMINÃ‰E ET VALIDÃ‰E **ğŸš€ PrÃªt pour la production !**---> **Cette release tuya-light est gÃ©nÃ©rÃ©e automatiquement Ã  la fin de chaque release principale.** ğŸ†âœ¨`; try { fs.writeFileSync(reportPath, report); this.log('âœ… Rapport de release crÃ©Ã©'); return true; } catch (error) { this.log(`âŒ Erreur crÃ©ation rapport: ${error.message}`, 'error'); return false; } } async run() { this.log('ğŸš€ DÃ©but de l\'automatisation tuya-light release...'); try { // Ã‰tape 1: GÃ©nÃ©rer la release tuya-light const generationResult = await this.generateTuyaLightRelease(); if (!generationResult.success) { throw new Error(generationResult.error); } // Ã‰tape 2: Valider la release const validationResult = await this.validateTuyaLightRelease(); if (!validationResult.success) { throw new Error(validationResult.error); } // Ã‰tape 3: CrÃ©er le rapport await this.createReleaseReport(); // Ã‰tape 4: CrÃ©er le rapport final this.report.summary = { generationResult, validationResult, status: 'tuya_light_release_completed', timestamp: new Date().toISOString() }; this.log('ğŸ‰ Automatisation tuya-light release terminÃ©e!'); this.log('âœ… Release gÃ©nÃ©rÃ©e et validÃ©e avec succÃ¨s'); this.log('ğŸ“ Dossier: tuya-light-release/'); this.log('ğŸ“¦ Drivers: CopiÃ©s automatiquement'); this.log('ğŸš€ PrÃªt pour installation et validation'); return this.report; } catch (error) { this.log(`âŒ Erreur automatisation tuya-light: ${error.message}`, 'error'); return this.report; } }}module.exports = AutoTuyaLightRelease; 